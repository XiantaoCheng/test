<!--
+[返回目录]

LaTeX数学记号::https://oeis.org/wiki/List_of_LaTeX_mathematical_symbols
+[打开](,LaTeX数学记号)
-->

<html>
  <head>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!--
Nini, 打开JS编译器(文件)
parser
保存:...
-->

<script>

/*
+[J函数](,JS版本)
*/

function arrayRemove(arr,value) {
    a=arr.filter(function(ele) {
            return ele!=value;
        }
    );
    return a;
}

class NetP {
    constructor(name,text='') {
        this.m_master='';
        this.m_needed='';
        this.m_creator='';
        this.m_dev='';
        this.m_var='';

        this.m_permission=4;


        this.m_name=name;
        this.m_text=text;
        this.m_db=['',''];
        this.m_con=[];
    }

    connect(con,index) {
        if(index>1 | index<0) {
            return
        }
        else {
            this.disconnect_i(index)
            this.m_db[index]=con
            if(con!='') {
                if(!con.m_con.includes(this)) {
                    con.m_con.push(this)
                }
            }
        }
    }

/*
+[J函数](,JS版本)
*/

    disconnect_i(index) {
        var con;
        if(index==0 | index==1) {
            con=this.m_db[index];
            this.m_db[index]=''
            if(con!='') {
                if(con.m_con.includes(this)) {
                    if(con!=this.m_db[1-index]) {
                        arrayRemove(con.m_con,this);
                    }
                }
            }
        }
    }

    delete() {
        this.disconnect_i(0);
        this.disconnect_i(1);
        var cons=this.m_con.slice();
        for(var i;i<cons.length;i++) {
            var point=cons[i];
            if(point.m_db[0]==this) {
                point.disconnect(0);
            }
            if(point.m_db[1]==this) {
                point.disconnect(1);
            }
        }
    }

    con(con0,con1) {
        var con0,con1;
        if(con0!=0) {
            this.disconnect_i(0)
            this.connect(con0,0)
        }
        if(con1!=0) {
            this.disconnect_i(1)
            this.connect(con1,1)
        }
        return this
    }

    info() {
    
        var str_info, str_d, str_b;
        if (this.m_db[0]=='') {
            str_d='';
        } else {
            str_d=this.m_db[0].m_name;
        }

        if (this.m_db[1]=='') {
            str_b='';
        }
        else {
            str_b=this.m_db[1].m_name;
        }
        
        str_info=`${this.m_name}(${str_d},${str_b})`;

        return str_info;
    }
}


/*
记住"Matlab"
Nini, 打开动作(库)
Nini, 打开JS编译器(文件)
+[J函数](,JS版本)

测试:...
*/
/*
保存:...
+[J函数](,JS版本)
Reason_oneStep
J函数(JS版本,)

m_needed

参考::https://www.freecodecamp.org/news/how-to-clone-an-array-in-javascript-1d3183468f6a/
+[打开](,参考)
[:]
*/


class Karma {

    constructor(symbol) {
        this.m_symbol=symbol;
        symbol.m_master=this;
        this.m_creator='';
        this.m_map='';
        this.m_cause='';
        this.m_yese=[];
        this.m_noe=[];
        this.m_yesAnd=false;
        this.m_noAnd=false;
        this.m_eoi=0;
        this.m_clause=[];
        this.m_clauseAnd=true;

        this.m_clauseNew=[];
        this.m_clauseCollect=false;
        this.m_clauseOut=false;
        this.m_clauseIn=false;

        this.m_not=false;
        this.m_no=false;
        this.m_buildMode=false;

        this.m_listMP='';
        this.m_restricted=false;

        this.m_ranger='';
        this.m_rangType=false
        this.m_stage=0;
        this.m_reState='';
        this.m_choose=true;
        this.m_interp=false;
    }

    addKarma(karma,con_type='肯定') {
        
        while(karma.m_cause!='') {
            karma=karma.m_cause;
        }
        if(con_type=="clause" | con_type=="从句") {
            this.m_clause.push(karma);
        }
        
        else if(con_type=="no" | con_type=="否定") {
            this.m_noe.push(karma);
        }
        
        else {
            this.m_yese.push(karma);
        }
        karma.m_cause=this;
    }

    info_cause() {
        var info='';
        var karma=this;
        
        while(true) {
            if(karma.m_symbol!='') {
                info=karma.m_symbol.m_name+info;
            }
            if(karma.m_cause=='') {
                break;
            }
            if(karma.m_cause.m_yese.includes(karma)) {
                if(karma.m_no==true) {
                    info='=>'+info;
                }
                
                else {
                    info='->'+info;
                }
            }
            
            else if(karma.m_cause.m_noe.includes(karma)) {
                if(karma.m_no==true) {
                    info='=>>'+info;
                }
                
                else {
                    info='->>'+info;
                }
            }
            
            else if(karma.m_cause.m_clause.includes(karma)) {
                info='=='+info;
            }
            karma=karma.m_cause;
        }
        return info;
    }


    stateSelf() {
        var name;

        if(this.m_interp==true) {
            return 'blue';
        }
        if(this.m_symbol=='' | this.m_map=='') {
            return 'yellow';
        }
        if(this.m_symbol.m_name=='[eq]' | this.m_symbol.m_name=='[同名]') {
            return this.stateSelf_eq();
        }
        
        else if(this.m_symbol.m_name=='[is]' | this.m_symbol.m_name=='[是]') {
            return this.stateSelf_is();
        }
        
        else if(this.m_symbol.m_name=='[那]') {
            return 'green';
        }
        if(this.m_symbol.m_name=='_正则表达式' | this.m_symbol.m_name=='_re') {
            
            try {
                pattern=new RegEx(this.m_symbol.m_text);
            } catch(e) {
                print('Invalid regular expression: ',this.m_symbol.m_text,'!');
                return 'red';
            }
            match=this.m_map.m_name;
            if(pattern.test(match)) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
        if(this.m_symbol.m_name!='' & this.m_symbol.m_name[0]=='_') {
            name=this.m_symbol.m_name.slice(1,this.m_symbol.m_name.length);
            var name_m=this.m_map.m_name;
            if(name.length==0) {
                return 'green';
            }
            
            else if(name[0]=='[' & name[name.length-1]==']') {
                if(name_m.length>=2 & name_m[0]=='[' & name_m[name_m.length-1]==']') {
                    return 'green';
                }
                
                else {
                    return 'red';
                }
            }
            
            else {
                return 'green';
            }
        }
        if(this.m_symbol.m_name.length > 1 & this.m_symbol.m_name[0]=='[' & this.m_symbol.m_name[this.m_symbol.m_name.length-1]==']') {
            var name1=this.m_symbol.m_name.slice(1,this.m_symbol.m_name.length-1);
            var name2=this.m_symbol.m_name;
            if(this.m_interp==false & this.m_map.m_creator=='' & this.m_buildMode==false) {
                return 'red';
            }
            if(name1==this.m_map.m_name | name2==this.m_map.m_name) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
        if(this.m_symbol.m_name!='' & this.m_symbol.m_name[0]=='~') {
            name=this.m_symbol.m_name.slice(1,this.m_symbol.m_name.length);
            if(name==this.m_map.m_name) {
                return 'red';
            }
            
            else {
                return 'green';
            }
        }
        
        else {
            name=this.m_map.m_name;
            if(name!='' & name[0]=='[' & name[name.length-1]==']') {
                name=name.slice(1,name.length-1);
            }
            if(name!=this.m_symbol.m_name) {
                return 'red';
            }
            
            else if(this.m_symbol.m_text!='' & this.m_symbol.m_text!=this.m_map.m_text) {
                return 'red';
            }
            
            else {
                return 'green';
            }
        }
    }


    stateSelf_eq() {
        var karmaL,karmaR;
        var nameL,nameR;

        if(this.m_map=='') {
            return 'yellow';
        }
        if(this.m_symbol.m_db[0]=='' | this.m_symbol.m_db[1]=='') {
            return 'red';
        }
        karmaL=this.m_symbol.m_db[0].m_master;
        karmaR=this.m_symbol.m_db[1].m_master;
        if(karmaL=='' | karmaR=='') {
            print('Error! [eq] doesn\'t have sbj | obj.');
            print('Sbj:',karmaL);
            print('Obj:',karmaR);
            return 'red';
        }
        if(karmaL.m_map=='' | karmaR.m_map=='') {
            return 'green';
        }
        
        else {
            nameL=karmaL.m_map.m_name;
            nameR=karmaR.m_map.m_name;
            if(karmaL.m_map.m_name.length>1 & karmaL.m_map.m_name[0]=='[' & karmaL.m_map.m_name[karmaL.m_map.m_name.length-1]==']') {
                nameL=karmaL.m_map.m_name.slice(1,karmaL.m_map.m_name.length-1);
            }
            if(karmaR.m_map.m_name.length>1 & karmaR.m_map.m_name[0]=='[' & karmaR.m_map.m_name[karmaR.m_map.m_name.length-1]==']') {
                nameR=karmaR.m_map.m_name.slice(1,karmaR.m_map.m_name.length-1);
            }
            if(nameL==nameR) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
    }


    stateSelf_is() {
        var karmaL,karmaR;
        if(this.m_map=='') {
            return 'yellow';
        }
        if(this.m_symbol.m_db[0]=='' | this.m_symbol.m_db[1]=='') {
            return 'red';
        }
        karmaL=this.m_symbol.m_db[0].m_master;
        karmaR=this.m_symbol.m_db[1].m_master;
        if(karmaL.m_map=='' | karmaR.m_map=='') {
            return 'green';
        }
        
        else {
            if(karmaL.m_map==karmaR.m_map) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
    }



    stateRelation() {
        if(this.m_map=='' | this.m_symbol=='') {
            return true;
        }
        var cause=this.m_cause;
        
        while(cause!='') {
            if(cause.m_symbol==this.m_symbol.m_db[0]) {
                if(cause.m_map!=this.m_map.m_db[0]) {
                    return false;
                }
            }
            if(cause.m_symbol==this.m_symbol.m_db[1]) {
                if(cause.m_map!=this.m_map.m_db[1]) {
                    return false;
                }
            }

// For a function point, you should check the relation between the point through the function point selfstate()
            if(cause.m_symbol.m_db[0]==this.m_symbol) {
                if(cause.m_map.m_db[0]!=this.m_map | cause.stateSelf()=='red') {
                    return false;
                }
            }
            if(cause.m_symbol.m_db[1]==this.m_symbol) {
                if(cause.m_map.m_db[1]!=this.m_map | cause.stateSelf()=='red') {
                    return false;
                }
            }
            cause=cause.m_cause;
        }
        return true;
    }

/*
newMap存档:...
Reason_oneStep
delete
list_have
info_cause
setRangers
*/


    mapListFromRange() {
        var list_map=[];
        if(this.m_rangType==true) {
            if(this.m_ranger.m_map=='') {
                list_map=[];
            }
            
            else {
                list_map=[...this.m_ranger.m_map.m_con];
            }
        }
        
        else if(this.m_ranger.m_symbol.m_db[0]==this.m_symbol) {
            if(this.m_ranger.m_map.m_db[0]=='') {
                list_map=[];
            }
            
            else {
                list_map=[this.m_ranger.m_map.m_db[0]];
            }
        }
        
        else if(this.m_ranger.m_symbol.m_db[1]==this.m_symbol) {
            if(this.m_ranger.m_map.m_db[1]=='') {
                list_map=[];
            }
            
            else {
                list_map=[this.m_ranger.m_map.m_db[1]];
            }
        }
        
        else {
            print('Warning! Undefined situation.');
        }
        return list_map;
    }


    mapListFromPool_normal(pool) {
        var list_map=[];
        var name=this.m_symbol.m_name;

        if(name.length>0 & (name[0]=='_' | name[0]=='~')) {
            list_have=dictToList(pool);
            list_map=[];
            
            for(var i=0;i<list_have.length;i++) {
                var point=list_have[i];
                if(point.m_needed=='' | (point.m_needed!='' & point.m_creator!='')) {
                    list_map.push(point);
                }
            }
        }
        
        else {
// print(undefined===[])
            list_map=pool[this.m_symbol.m_name];
            if(list_map===undefined) {
                list_map=[];
            }
        }
        return list_map;
    }
    

    mapList_is(ranger,pool) {
        if(ranger.m_symbol.m_db[0]=='' | ranger.m_symbol.m_db[1]=='') {
            return this.mapListFromPool_normal(pool);
        }
        if(ranger.m_symbol.m_db[0]==this.m_symbol & ranger.m_map.m_db[1]!='') {
            return [ranger.m_map.m_db[1]];
        }
        if(ranger.m_symbol.m_db[1]==this.m_symbol & ranger.m_map.m_db[0]!='') {
            return [ranger.m_map.m_db[0]];
        }
        return this.mapListFromPool_normal(pool);
    }

    allCauses() {
        var cause=this;
        var list_km=[];
        
        while(cause.m_cause!='') {
            cause=cause.m_cause;
            list_km.push(cause);
        }
        return list_km;
    }

    mapList_that(ranger) {
        var list_cause=ranger.allCauses();
        var list_map=[];
        
        for(var i=0;i<list_cause.length;i++) {
            var cause=list_cause[i];
            var pt_map=cause.m_map;
            if(pt_map!='' & !list_map.includes(pt_map)) {
                list_map.push(pt_map);
            }
        }
        return list_map;
    }

    //rangeList(pool,areaType,list_new) {
    rangeList(pool,list_new) {
        var list_map=[];

        if(this.m_listMP!=='') {
            return this.m_listMP;
        }
        
        else if(this.m_ranger!='') {
            var ranger=this.m_ranger;
            var nameR=this.m_ranger.m_symbol.m_name;
            if(nameR=='[is]') {
                list_map=this.mapList_is(this.m_ranger,pool);
            }
            
            else if(nameR=='[那]') {
                list_map=this.mapList_that(this.m_ranger);
            }
            
            else if(this.m_ranger.isType('非回答新建') &  this.m_symbol.m_con.includes(this.m_ranger.m_symbol)) {
                list_map=this.mapListFromPool_normal(pool);
            }
            
            else {
                list_map=this.mapListFromRange();
            }
        }
        
        else {
            list_map=this.mapListFromPool_normal(pool);
        }
        this.m_listMP=list_map;
        return list_map;
    }


    newMap(pool,areaType,list_new) {
    //newMap(list_map,areaType,list_new) {
        var list_map=this.rangeList(pool,list_new);

        // var list_map=[];
        var name;
        if(this.m_buildMode==false | areaType==false) {
            name=this.m_symbol.m_name;
            if(this.isPreDefined()) {
                if(this.m_map=='') {
                    point=new NetP(name,this.m_symbol.m_text);
                    point.m_needed=this;
                    point.m_creator=this;
                    this.map(point);
                }
                
                else {
                    this.m_map.delete();
                    delete this.m_map;
                    this.map('');
                }
                return;
            }
            
            else if(this.isFunctionPoint()==2) {
                if(this.m_map=='') {
                    point=new NetP(name,this.m_symbol.m_text);
                    point.m_needed=this;
                    this.map(point);
                }
                
                else {
                    this.map(this.m_map);
                }
                this.m_interp=true;
                return;
            }
            var list_have=list_map;
            var mp=this.m_map;
            this.map(this.nextInlist(mp,list_have));
            return;
        }
        
        else {
            name=this.m_symbol.m_name;
            if(name!='' & (name[0]!='[' | name[name.length-1]!=']')) {
                if(this.m_map!='') {
                    this.m_map.m_creator='';
                    if(this.m_map.m_needed=='') {
                        this.m_map.delete();
                        this.map('');
                        return;
                    }
                    
                    else {
                        this.m_map.m_name='['+this.m_map.m_name+']';
                    }
                }
                var list_need=[];
                
                for(var i=0;i<list_map.length;i++) {
                    var point=list_map[i];
                    if(point.m_creator=='' & point.m_needed!='') {
                        list_need.push(point);
                    }
                }

                point=this.m_map;
                this.map(this.nextInlist(point,list_need));
                if(this.m_map=='') {
                    if(this.m_restricted==true) {
                        this.map('');
                        return;
                    }
                    point=new NetP(this.m_symbol.m_name,this.m_symbol.m_text);
                    point.m_building=true;
                    this.map(point);
                }
                
                else {
                    this.m_map.m_building=true;
                    this.m_map.m_name=this.m_map.m_name.slice(1,this.m_map.m_name.length-1);
                }
                this.m_map.m_creator=this;
                return;
            }
            else {
                if(this.m_map=='') {
                    point=new NetP(name,this.m_symbol.m_text);
                    point.m_building=true;
                    point.m_needed=this;
                    this.map(point);
                    return;
                } else {
                    this.m_map.m_needed='';
                    this.m_map.delete();
                    this.map('');
                    return;
                }
            }
        } 

        this.map('');
    }
/*
+[J函数](,JS版本)
*/

    nextInlist(point,list_pt) {
        var i;
        if(list_pt.length==0) {
            return '';
        }
        if(point=='') {
            return list_pt[0];
        }
        
        try {
            i=list_pt.lastIndexOf(point);
        } catch(e) {
            return '';
        }

        if(i+1>=list_pt.length) {
            return '';
        }
        else {
            return list_pt[i+1];
        }
    }

/*
+[J函数](,JS版本)
*/

    map(point) {
        var cause;
        this.clearAll();
        this.m_map=point;
        if(this.m_map!='') {
            cause=this.m_cause;
            
            while(cause!='') {
                if(cause.needBuildRelation()) {
                    if(cause.m_map.m_needed=='' | cause.m_map.m_needed==cause) {
                        if(cause.m_symbol.m_db[0]==this.m_symbol) {
                            cause.m_map.connect(this.m_map,0);
                        }
                        if(cause.m_symbol.m_db[1]==this.m_symbol) {
                            cause.m_map.connect(this.m_map,1);
                        }
                    }
                }
                if(this.needBuildRelation()) {
                    if(this.m_map.m_needed=='' | this.m_map.m_needed==this) {
                        if(this.m_symbol.m_db[0]==cause.m_symbol) {
                            this.m_map.connect(cause.m_map,0);
                        }
                        if(this.m_symbol.m_db[1]==cause.m_symbol) {
                            this.m_map.connect(cause.m_map,1);
                        }
                    }
                }
                cause=cause.m_cause;
            }
        }
    }

/*
+[J函数](,JS版本)
info(
*/

    clearAll() {
        this.m_map='';
        this.m_stage=0;
        this.m_interp=false;
        this.m_reState='';
        this.m_choose=true;
        this.m_eoi=0;
        if(this.m_restricted==false) {
            delete this.m_listMP;
            this.m_listMP='';
        }
        
        for(var i=0;i<this.m_clause.length;i++) {
            var clause=this.m_clause[i];
            clause.clearAll();
        }
        
        for(var i=0;i<this.m_noe.length;i++) {
            var end=this.m_noe[i];
            end.clearAll();
        }
        
        for(var i=0;i<this.m_yese.length;i++) {
            var end=this.m_yese[i];
            end.clearAll();
        }
    }


    needBuildRelation() {
        if(this.buildingNewMap()) {
            return true;
        }
        
        else if(this.isFunctionPoint()!=0) {
            return true;
        }
        return false;
    }



    buildingNewMap() {
        if(this.m_map=='') {
            return false;
        }
        
        else if(this.m_buildMode==false) {
            return false;
        }
        
        else {
            if(this.m_map.m_needed=='') {
                return true;
            }
        }
        return false;
    }



    isFunctionPoint() {
        if(this.m_symbol.m_name=='') {
            return 0;
        }
        
        else if(this.m_symbol.m_name=='[eq]' | this.m_symbol.m_name=='[同名]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name=='[is]' | this.m_symbol.m_name=='[是]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name=='[那]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name=='[]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name[0]=='[' & this.m_symbol.m_name[this.m_symbol.m_name.length-1]==']') {
            return 2;
        }
        return 0;
    }

/*
list_have
*/

    isPreDefined() {
        var name=this.m_symbol.m_name;
        if(name=='[is]' | name=='[eq]' | name=='[那]' | name=='[]') {
            return true;
        }
        
        else {
            return false;
        }
    }


    areaType() {
        return 0;
    }

/*
+[J函数](,JS版本)
length
newMap
*/

    Reason_oneStep(pool) {
        var list_new=[];
        // var areaType=areaType.concat(this.areaType());
        var areaType=true;
        var change=false;
        var keep=true;

        if(this.m_stage==0) {
            if(this.m_cause!='') {
                if(this.m_cause.m_clause.includes(this)) {
                    if(this.m_cause.m_stage==2) {
                        this.m_stage=1;
                        change=true;
                    }
                }
            }
        }

        if(this.m_stage==1) {
            
            while(true) {
                if(this.stateSelf()!='blue') {
                    this.newMap(pool,areaType,list_new);
                }
                
                else {
                    this.m_interp=false;
                }
                change=true;
                if(this.stateRelation()==false) {
                    continue;
                }
                
                else if(this.stateSelf()=='red') {
                    continue;
                }
                
                else if(this.stateSelf()=='yellow') {
                    this.m_stage=5;
                    if(this.m_no==false) {
                        this.m_reState='dark yellow';
                        return [change,list_new];
                    }
                    
                    else {
                        this.m_reState='dark green';
                        return [change,list_new];
                    }
                }
                
                else if(this.stateSelf()=='blue') {
                    this.m_stage=1;
                    return [change,list_new];
                }
                
                else {
                    this.m_stage=2;
                    break;
                }
            }
        }

        if(this.m_stage==2) {

            if(this.m_clause.length==0) {
                this.m_choose=true;
                this.m_stage=3;
                change=true;
            }
            
            else {
                this.m_choose=this.m_clauseAnd;
                keep=false;
            }

            
            for(var i=0;i<this.m_clause.length;i++) {
                var clause=this.m_clause[i];
                if(this.m_clauseAnd==true) {
                    if(clause.m_reState=='dark yellow') {
                        this.m_choose=false;
                        this.m_stage=3;
                        change=true;
                        this.m_clauseOut=true;
                        break;
                    }
                    
                    else if(clause.m_reState=='') {
                        keep=true;
                    }
                }
                
                else {
                    if(clause.m_reState=='dark green') {
                        this.m_choose=true;
                        this.m_stage=3;
                        change=true;
                        this.m_clauseOut=true;
                        break;
                    }
                    
                    else if(clause.m_reState=='') {
                        keep=true;
                    }
                }
            }

            if(this.m_clause.length!=0 & keep==false) {
                this.m_stage=3;
                change=true;
                this.m_clauseOut=true;
            }
        }


        if(this.m_stage==3) {
            if(this.m_choose==false) {
                if(this.m_noe.length==0) {
                    this.m_stage=1;
                    change=true;
                    return [change,list_new];
                }
                i=this.m_eoi;
                var end=this.m_noe[i];
                if(end.m_stage==0) {
                    end.m_stage=1;
                    change=true;
                }
                
                else if(end.m_reState=='dark yellow') {
                    if(this.m_noAnd==true) {
                        this.m_stage=1;
                        change=true;
                    }
                    
                    else {
                        i+=1;
                        change=true;
                        if(i==this.m_noe.length) {
                            this.m_stage=1;
                            this.m_eoi=0;
                        }
                        
                        else {
                            this.m_eoi=i;
                        }
                    }
                }
                
                else if(end.m_reState=='dark green') {
                    if(this.m_noAnd!=true) {
                        this.m_stage=4;
                        change=true;
                    }
                    
                    else {
                        i+=1;
                        change=true;
                        if(i==this.m_noe.length) {
                            this.m_stage=4;
                            this.m_eoi=0;
                        }
                        
                        else {
                            this.m_eoi=i;
                        }
                    }
                }
            }
            
            else {
                if(this.m_yese.length==0 & this.m_noe.length==0) {
                    this.m_stage=4;
                    change=true;
                }
                
                else if(this.m_yese.length==0) {
                    this.m_stage=1;
                    change=true;
                    return [change,list_new];
                }
                
                else {
                    i=this.m_eoi;
                    end=this.m_yese[i];
                    if(end.m_stage==0) {
                        end.m_stage=1;
                        change=true;
                    }
                    
                    else if(end.m_reState=='dark yellow') {
                        if(this.m_yesAnd==true) {
                            this.m_stage=1;
                            change=true;
                        }
                        
                        else {
                            i+=1;
                            change=true;
                            if(i==this.m_yese.length) {
                                this.m_stage=1;
                                this.m_eoi=0;
                            }
                            
                            else {
                                this.m_eoi=i;
                            }
                        }
                    }
                    
                    else if(end.m_reState=='dark green') {
                        if(this.m_yesAnd!=true) {
                            this.m_stage=4;
                            change=true;
                        }
                        
                        else {
                            i+=1;
                            change=true;
                            if(i==this.m_yese.length) {
                                this.m_stage=4;
                                this.m_eoi=0;
                            }
                            
                            else {
                                this.m_eoi=i;
                            }
                        }
                    }
                }
            }
        }


        if(this.m_stage==4) {
            if(this.m_clauseNew.length!=0 | this.m_clauseOut==true) {
                this.m_clauseCollect=true;
            }
            if((this.m_buildMode==true | this.isFunctionPoint()==1) & this.m_map!='' & !list_new.includes(this.m_map)) {
                list_new.push(this.m_map);
            }
            this.m_stage=5;
            if(this.m_no==true) {
                this.m_reState='dark yellow';
                change=true;
                return [change,list_new];
            }
            
            else {
                this.m_reState='dark green';
                change=true;
                return [change,list_new];
            }
        }
        return [change,list_new];
    }

    isVirtual() {
        var name=this.m_symbol.m_name;
        if(name.length>1 & name[0]=='[' & name[name.length-1]==']') {
            return true;
        }
        
        else {
            return false;
        }
    }


    isSpecialRanger() {
        var name=this.m_symbol.m_name;
        if(name=='[is]' | name=='[那]') {
            return true;
        }
        return false;
    }

    isType(str_type) {
        var name=this.m_symbol.m_name;
        if(infoInStr('引用',str_type)) {
            if(!this.isVirtual() | this.m_buildMode==true) {
                return false;
            }
        }
        if(infoInStr('新建',str_type)) {
            if(infoInStr('非新建',str_type)) {
                if(this.m_buildMode==true) {
                    return false;
                }
            }
            
            else if(this.m_buildMode==false) {
                return false;
            }
        }
        if(infoInStr('动作',str_type)) {
            if(!this.isVirtual() | this.m_buildMode==false) {
                return false;
            }
        }
        if(infoInStr('内置',str_type)) {
            if(!this.isPreDefined()) {
                return false;
            }
        }
        if(infoInStr('特殊范围',str_type)) {
            if(!this.isSpecialRanger()) {
                return false;
            }
        }
        if(infoInStr('否定',str_type)) {
            if(name=='' | name[0]!='~') {
                return false;
            }
        }
        if(infoInStr('通用',str_type)) {
            if(name=='' | name[0]!='_') {
                return false;
            }
        }
        if(infoInStr('普通',str_type)) {
            if(this.isVirtual()) {
                return false;
            }
        }
        if(infoInStr('端点',str_type)) {
            if(infoInStr('非端点',str_type)) {
                if(this.m_ranger=='') {
                    return false;
                }
            }
            
            else if(this.m_ranger!='') {
                return false;
            }
        }
        if(infoInStr('回答',str_type)) {
            var an_type=true;
            if(this.m_map=='' | this.m_map.m_needed==this | this.m_map.m_needed=='') {
                an_type=false;
            }
            if(infoInStr('非回答',str_type)) {
                if(an_type) {
                    return false;
                }
            }
            
            else if(!an_type) {
                return false;
            }
        }
        if(infoInStr('限制',str_type)) {
            if(this.m_restricted==false) {
                return false;
            }
        }
        return true;
    }


    setRangers(causes='') {
        var connecting='';
        var connected='';
        var caseNo=100;
        if(causes=='') {
            causes=[];
        }
        
        else if(this.isType('非新建普通链节')) {
            
            for(var i=0;i<causes.length;i++) {
                var cause=causes[i];
                if(cause.m_symbol.m_db[0]==this.m_symbol | cause.m_symbol.m_db[1]==this.m_symbol) {
                    if(cause.isType('特殊范围')) {
                        connected=cause;
                        break;
                    }
                    
                    else if(cause.isType('普通非新建') & caseNo>3) {
                        connected=cause;
                        caseNo=3;
                    }
                    
                    else if(cause.isType('新建') & caseNo>5) {
                        connected=cause;
                        caseNo=5;
                    }
                }
                
                else if(this.m_symbol.m_db[0]==cause.m_symbol | this.m_symbol.m_db[1]==cause.m_symbol) {
                    if(cause.isType('引用') & caseNo>2) {
                        connecting=cause;
                        caseNo=2;
                    }
                    
                    else if(cause.isType('普通非新建') & caseNo>4) {
                        connecting=cause;
                        caseNo=4;
                    }
                    
                    else if(cause.isType('新建') & caseNo>6) {
                        connecting=cause;
                        caseNo=6;
                    }
                }
            }
            if(connected!='') {
                this.m_ranger=connected;
            }
            
            else if(connecting!='') {
                this.m_ranger=connecting;
                this.m_rangType=true;
            }
        }
        causes=[...causes,this];
        
        for(var i=0;i<this.m_clause.length;i++) {
            var con=this.m_clause[i];
            con.setRangers(causes);
        }
        
        for(var i=0;i<this.m_yese.length;i++) {
            var end=this.m_yese[i];
            end.setRangers(causes);
        }
        
        for(var i=0;i<this.m_noe.length;i++) {
            var end=this.m_noe[i];
            end.setRangers(causes);
        }
    }

    allEffects() {
        var list_effects=[this];
        
        for(var i=0;i<this.m_clause.length;i++) {
            var karma=this.m_clause[i];
            list_effects=list_effects.concat(karma.allEffects());
        }
        
        for(var i=0;i<this.m_noe.length;i++) {
            var karma=this.m_noe[i];
            list_effects=list_effects.concat(karma.allEffects());
        }
        
        for(var i=0;i<this.m_yese.length;i++) {
            var karma=this.m_yese[i];
            list_effects=list_effects.concat(karma.allEffects());
        }
        return list_effects;
    }


    causeEnd() {
        var cause=this;
        
        while(cause.m_cause!='') {
            cause=cause.m_cause;
        }
        return cause;
    }


    info() {
        var map,str_info;
        if(this.m_map!='') {
            map=this.m_map.info();
        }
        else {
            map='(None)';
        }
        var map_info,name_info;
        
        if(this.m_reState=='dark green') {
            name_info=`<span style="background-color:green;color:white;">${this.m_symbol.info()}</span>`;
        }
        else if(this.m_reState=='dark yellow') {
            name_info=`<span style="background-color:yellow;color:black;">${this.m_symbol.info()}</span>`;
        }
        else {
            name_info=`<span>${this.m_symbol.info()}</span>`;
        }
        
        if(this.stateSelf()=='yellow') {
            map_info=`<span style="background-color:${this.stateSelf()};">${map}</span>`;
        }
        else {
            map_info=`<span style="background-color:${this.stateSelf()};color:white;">${map}</span>`;
        }
        
        str_info=`${name_info}:${map_info},stage(${this.m_stage})`;
        return str_info;
    }


}


function infoInStr(string,str_info) {
    a=str_info.includes(string);
    return a;
}


function dictToList(dict_pt) {
    var list_pt=[];
    
    for(var i=0;i<dict_pt.length;i++) {
        var term=dict_pt[i];
        list_pt=[...list_pt,dict_pt[term]];
    }
    return list_pt;
}




/*
oneStep

stateRelation
setRangers
nextInlist
concat
测试(J函数):...
+[新建阅读窗口](,测试)
*/
/*
+[J函数](,JS版本)

测试:...
测试list:...
+[新建阅读窗口](,测试)
Object

保存:...
+[新建阅读窗口](,保存)
setRange
readSubCode_tokener
buildPoints_tokener
pool
writeStdCode
*/



function writeStdCode_karma(karma,list_pt) {
    var karma_code='',text='';

    if(karma=='') {
        return [karma_code,list_pt];
    }
    if(!list_pt.includes(karma.m_symbol)) {
        list_pt.push(karma.m_symbol);
    }
    if(karma.m_buildMode==true) {
        karma_code+='+';
    }
    // var n=list_pt.indexOf(karma.m_symbol);
    // karma_code+=(list_pt.indexOf(karma.m_symbol)).toString();
    karma_code+=karma.m_symbol.info();
    if(karma.m_clause.length!=0) {
        if(karma.m_clauseAnd==false) {
            karma_code+='|';
        }
        karma_code+='{';
        
        for(var i=0;i<karma.m_clause.length;i++) {
            var clause=karma.m_clause[i];
            [text,list_pt]=writeStdCode_karma(clause,list_pt);
            karma_code+=text;
            if(clause!=karma.m_clause[karma.m_clause.length-1]) {
                karma_code+=',';
            }
        }
        karma_code+='}';
    }
    if(karma.m_yese.length+karma.m_noe.length>1) {
        if(karma.m_yesAnd==true) {
            karma_code+='&';
        }
        karma_code+=':';
    }
    
    for(var i=0;i<karma.m_yese.length;i++) {
        var end=karma.m_yese[i];
        if(end.m_no==false) {
            karma_code+='->';
        }
        
        else {
            karma_code+='=>';
        }
        [text,list_pt]=writeStdCode_karma(end,list_pt);
        karma_code+=text;
        if(end!=karma.m_yese[karma.m_yese.length-1]) {
            karma_code+=',';
        }
    }
    
    for(var i=0;i<karma.m_noe.length;i++) {
        var end=karma.m_noe[i];
        if (karma.m_yese.length!=0) {
            karma_code+=',';
        }
        if(end.m_no==false) {
            karma_code+='->>';
        }
        
        else {
            karma_code+='=>>';
        }
        [text,list_pt]=writeStdCode_karma(end,list_pt);
        karma_code+=text;
        if(end!=karma.m_noe[karma.m_noe.length-1]) {
            karma_code+=',';
        }
    }
    if(karma.m_yese.length+karma.m_noe.length>1) {
        karma_code+=';';
    }
    return [karma_code,list_pt];
}

/*
do
保存NetPStack:...
*/

class NetPStack {
    
    constructor() {
        this.m_builtStack=[{}];
        this.m_undefinedStack=[{}];
    }

    info() {
        var info='',info_stack='';
        
        info+='Built: ';
        for(var i in this.m_builtStack) {
            info_stack=''
            for(var key in this.m_builtStack[i]) {
                info_stack+=`${key}:${this.m_builtStack[i][key].info()},`;
            }
            info+=`{${info_stack}},`;
        }
        
        info+='<br>Undefined: ';
        for(var i in this.m_undefinedStack) {
            info_stack=''
            for(var key in this.m_undefinedStack[i]) {
                info_stack+=`${key}:${this.m_undefinedStack[i][key].info()},`;
            }
            info+=`{${info_stack}},`;
        }
        info+=`<br>`;
        return info;
    
    }

    popBuilt() {
        return this.m_builtStack.pop();
    }
    
    popUndefined() {
        return this.m_undefinedStack.pop();
    }
    
    pushBuilt(built) {
        this.m_builtStack.push(built);
    }
    
    pushUndefined(undefined_pt) {
        this.m_undefinedStack.push(undefined_pt);
    }
    
    enterClause() {
        var copy0={},copy1={};

        Object.assign(copy0,this.m_builtStack[this.m_builtStack.length-1]);
        this.m_builtStack.push(copy0);

        Object.assign(this.m_undefinedStack[this.m_undefinedStack.length-1],copy1);
        this.m_undefinedStack.push(copy1);
    }


    insertPtIntotKarma_back(km0,netP) {
        var km_new=new Karma(netP),km;
        if(netP.m_name.length>1 & netP.m_name[0]=='+') {
            netP.m_name=netP.m_name.slice(1,netP.m_name.length);
            km_new.m_buildMode=true;
        }
        
        for(var i=0;i<km0.m_clause.length;i++) {
            km=km0.m_clause[i];
            km.m_cause=km_new;
        }
        
        for(var i=0;i<km0.m_yese.length;i++) {
            km=km0.m_yese[i];
            km.m_cause=km_new;
        }
        
        for(var i=0;i<km0.m_noe.length;i++) {
            km=km0.m_noe[i];
            km.m_cause=km_new;
        }
        km_new.m_clause=km0.m_clause;
        km_new.m_yese=km0.m_yese;
        km_new.m_noe=km0.m_noe;
        km0.m_yese=[km_new];
        km0.m_noe=[];
        km_new.m_cause=km0;
    }
    

    insertPtIntotKarma_front(km0,netP) {
        var i;
        var km_new=new Karma(netP);
        if(netP.m_name.length>1 & netP.m_name[0]=='+') {
            netP.m_name=netP.m_name.slice(1,netP.m_name.length);
            km_new.m_buildMode=true;
        }
        if(km0.m_cause!='') {
            var cause=km0.m_cause;
            km_new.m_cause=cause;
            if(cause.m_clause.includes(km0)) {
                i=cause.m_clause.indexOf(km0);
                cause.m_clause.splice(i,1);
                cause.m_clause.push(km_new);
            }
            
            else if(cause.m_yese.includes(km0)) {
                i=cause.m_yese.indexOf(km0);
                cause.m_yese.splice(i,1);
                cause.m_yese.push(km_new);
            }
            
            else if(cause.m_noe.includes(km0)) {
                i=cause.m_noe.indexOf(km0);
                cause.m_noe.splice(i,1);
                cause.m_noe.push(km_new);
            }
            
            else {
                print("Warning! The karma:"+km0.m_symbol.info()+", has a weird cause karma.");
            }
        }
        km0.m_cause=km_new;
        km_new.m_yese=[km0];
        if(km0.m_no==true) {
            km0.m_no=false;
            km_new.m_no=true;
        }
    }


    insertPtIntotKarma(km0,netP) {
        var otherP;
        if(km0.m_symbol.m_db[0]==netP) {
            otherP=km0.m_symbol.m_db[1];
        }
        
        else if(km0.m_symbol.m_db[1]==netP) {
            otherP=km0.m_symbol.m_db[0];
        }
        
        else {
            return;
        }

        if(km0.isType('新建') | km0.m_symbol.m_name=='[那]') {
            this.insertPtIntotKarma_back(km0,netP);
        }
        
        else if(km0.isType('普通非新建') | km0.m_symbol.m_name=='[is]') {
            if(otherP=='' | otherP.m_master=='') {
                this.insertPtIntotKarma_back(km0,netP);
            }
            
            else if(km0.allCauses().includes(otherP.m_master)) {
                this.insertPtIntotKarma_back(km0,netP);
            }
            
            else {
                this.insertPtIntotKarma_front(km0,netP);
            }
        }
        else if(km0.isType('引用')) {
        //else {
            this.insertPtIntotKarma_front(km0,netP);
        }
    }



    leaveClause() {
        var dict_len=0,dict_undef={};
        var dict_len2=0,dict_undef2={};
        var pt,km_head;
        if(this.m_undefinedStack.length==1) {
            dict_undef=this.m_undefinedStack[this.m_undefinedStack.length-1];
            dict_len=Object.keys(dict_undef).length;
            if(dict_len!=0) {
                for(var term in dict_undef) {
                    pt=dict_undef[term];
                    if(pt.m_master=='') {
                        km_head=pt.m_con[0].m_master;
                        this.insertPtIntotKarma(km_head,pt);
                    }
                }
            }
        }
        
        else {
            dict_undef=this.m_undefinedStack[this.m_undefinedStack.length-1];
            dict_len=Object.keys(dict_undef).length;

            dict_undef2=this.m_undefinedStack[this.m_undefinedStack.length-2];
            dict_len2=Object.keys(dict_undef2).length;

            if(dict_len>dict_len2) {
                for(var term in dict_undef) {
                    if(dict_undef2[term]==undefined) {
                        pt=dict_undef[term];
                        if(pt.m_master=='') {
                            km_head=pt.m_con[0].m_master;
                            this.insertPtIntotKarma(km_head,pt);
                        }
                    }
                }
            }
        }

        this.m_builtStack.pop();
        this.m_undefinedStack.pop();
    }
    
    popUndefinedName(name) {
        
        for(var i=0;i<this.m_undefinedStack.length;i++) {
            var stack=this.m_undefinedStack[i];
            delete stack[name];
        }
    }
    
    buildNetP(name,con0_name='',con1_name='') {
        var recent=this.m_builtStack[this.m_builtStack.length-1];
        var undefined_pt=this.m_undefinedStack[this.m_undefinedStack.length-1];
        var point=undefined_pt[name];
        if(point==undefined) {
            var name0=name;
            point=new NetP(name.replace(/#.*$/,''));
            recent[name0]=point;
        }
        
        else {
            delete undefined_pt[name];
        }
        if(con1_name!='') {
            var con1=recent[con1_name];
            if(con1==undefined) {
                var con1_name0=con1_name;
                con1=new NetP(con1_name.replace(/#.*$/,''));
                recent[con1_name0]=con1;
                undefined_pt[con1_name0]=con1;
            }
            point.connect(con1,1);
        }
        if(con0_name!='') {
            var con0=recent[con0_name];
            if(con0==undefined) {
                var con0_name0=con0_name;
                con0=new NetP(con0_name.replace(/#.*$/,''));
                recent[con0_name0]=con0;
                undefined_pt[con0_name]=con0;
            }
            point.connect(con0,0);
        }
        return point;
    }




}



class Parser {

    readSubCode_tokener(code) {
        var list_karma=[];
        var karma,pointStack;
        
        while(code!='') {
            code=code.replace(/^[ \t\n]+/,'');
            if(code=='') {
                break;
            }

//            code,result=removeComment(code);
//            if(result==true) {
//                continue;
//            }
            
            else {
                [code,karma,pointStack]=this.chainToken(code);
                pointStack.leaveClause();
                karma=karma.causeEnd();
                karma.setRangers();
                list_karma.push(karma);
                if(code!='' & code[0]==';') {
                    code=code.slice(1,code.length);
                }
            }
        }
        return list_karma;
    }

/*
buildNetP
*/

    buildPoints_tokener(code) {
        code=code.replace(/^[ \t\n\r]*/,'');

        var list_pt=[],netP;
        var pointStack=new NetPStack();

        while(code!='') {
            [code,netP,pointStack]=this.netPToken(code,pointStack);
            list_pt.push(netP);
            code=code.replace(/^\[-?\d+,-?\d+\]/,'');
            code=code.replace(/^[ \t\n\r;]*/,'');

        }
        return list_pt;
    }


    chainToken(code,pointStack='') {
        var karma;
        if(pointStack=='') {
            pointStack=new NetPStack();
        }
        [code,karma,pointStack]=this.karmaToken(code,pointStack);
        if(code=='' | code[0]==';' | code[0]=='\n' | code[0]=='}') {
            return [code,karma,pointStack];
        }
        
        else if(code[0]==',') {
            return [code,karma,pointStack];
        }
        
        else if(code[0]==':') {
            code=code.slice(1,code.length);
            [code,karma,pointStack]=this.splitToken(code,karma,pointStack);
        }
        
        else if(code[0]=='|' | code[0]=='&') {
            var typeSub=code[0];
            code=code.slice(1,code.length);
            if(code!='' & code[0]==':') {
                if(typeSub=='|') {
                    karma.m_noAnd=false;
                    karma.m_yesAnd=false;
                }
                
                else {
                    karma.m_noAnd=true;
                    karma.m_yesAnd=true;
                }
                code=code.slice(1,code.length);
                [code,karma,pointStack]=this.splitToken(code,karma,pointStack);
            }
        }
        
        else {
            var typeCon,effect;
            [code,typeCon]=this.conToken(code);
            [code,effect,pointStack]=this.chainToken(code,pointStack);
            this.buildRelation(karma,typeCon,effect);
        }
        return [code,karma,pointStack];
    }


    conToken(code) {
        var typeCon;
        while(code.length>3 & code.slice(0,3)=='...') {
            code=code.replace(/^\.\.\..*[\n\t ]*/,'');
        }
        code=code.replace(/^[ \t]*/,'');
        if(code.length>2 & code.slice(0,3)=='->>') {
            typeCon=code.slice(0,3);
            code=code.slice(3,code.length);
        }
        
        else if(code.length>2 & code.slice(0,3)=='=>>') {
            typeCon=code.slice(0,3);
            code=code.slice(3,code.length);
        }
        
        else if(code.length>1 & code.slice(0,2)=='->') {
            typeCon=code.slice(0,2);
            code=code.slice(2,code.length);
        }
        
        else if(code.length>1 & code.slice(0,2)=='=>') {
            typeCon=code.slice(0,2);
            code=code.slice(2,code.length);
        }
        
        else {
            print('\n\n\nIllegal connection symbol!\nCode:',code);
            throw 'Illegal connection symbol!';
        }
        code=code.replace(/^[ \t]*/,'');
        return [code,typeCon];
    }


    clauseToken(code,karma,pointStack) {
        pointStack.enterClause();
        var clause;

        while(true) {
            code=code.replace(/^[ \t\n]*/,'');
            if(code=='') {
                throw 'Error! Unbalanced bracket!';
            }
            
            else if(code[0]=='}') {
                break;
            }
            
            else {
                [code,clause,pointStack]=this.chainToken(code,pointStack);
                karma.m_clause.push(clause);
                clause.m_cause=karma;
                if(code!='' & code[0]!=',') {
                    break;
                }
                
                else if(code!='') {
                    code=code.slice(1,code.length);
                }
            }
        }
        pointStack.leaveClause();
        return [code,karma,pointStack];
    }


    splitToken(code,karma,pointStack) {
        var typeCon,effect;

        while(true) {
            code=code.replace(/^[ \t\n]*/,'');
            [code,typeCon]=this.conToken(code);
            [code,effect,pointStack]=this.chainToken(code,pointStack);
            this.buildRelation(karma,typeCon,effect);
            code=code.replace(/^[ \t\n]*/,'');
            if(code=='' | code[0]==';' | code[0]=='}') {
                break;
            }
            
            else if(code[0]!=',') {
                print('\n\n\n\nError! Ilegal splitting type!\nCode:',code);
                throw 'Error! Ilegal splitting type!';
            }
            
            else {
                code=code.slice(1,code.length);
            }
        }
        return [code,karma,pointStack];
    }



    karmaToken(code,pointStack) {
        if(code=='') {
            throw 'Error! Invalid karma detected!';
        }

        var buildType=false;
        var karma='';
        var netP;

        if(code[0]=='+') {
            buildType=true;
        }
        [code,netP,pointStack]=this.netPToken(code,pointStack);
        karma=new Karma(netP);
        if(buildType==true & netP.m_name!='+') {
            netP.m_name=netP.m_name.slice(1,netP.m_name.length);
            karma.m_buildMode=true;
        }

        if(code!='' & code[0]=='{') {
            code=code.slice(1,code.length);
            [code,karma,pointStack]=this.clauseToken(code,karma,pointStack);
            code=code.replace(/^[\n\t ]*/,'');
            if(code=='' | code[0]!='}') {
                print('\n\n\nError! Unbalanced bracket.\nCode:',code);
                throw 'Error! Unbalanced bracket.';
            }
            
            else {
                code=code.slice(1,code.length);
            }
        }

        return [code,karma,pointStack];
    }


    netPToken(code,pointStack) {
        var title=/^[\w\u3000\u3400-\u4DBF\u4E00-\u9FFF \[\]~#.+=\-^/*\\!<\']*|^\[>=?\]/;
        var name=code.match(title)[0];
        code=code.replace(title,'');
        if(name=='') {
            print('\n\n\nError! Invalid name.\nCode:',code);
            throw 'Error! Invalid name.';
        }


        if(name[name.length-1]=='=' | name[name.length-1]=='-') {
            if(code.length>0 & code[0]=='>') {
                code=name[name.length-1]+code;
                name=name.slice(0,name.length-1);
            }
        }

        var con0_name='';
        var con1_name='';
        var text='';
        if(code!='' & code[0]=='\"') {
            code=code.slice(1,code.length);
            [code,text]=this.textToken(code);
            if(code=='' | code[0]!='\"') {
                print(code);
                throw 'Error! Unbalanced quote!';
            }
            code=code.slice(1,code.length);
        }
        if(code!='' & code[0]=='(') {
            code=code.slice(1,code.length);
            con0_name=code.match(title)[0];
            code=code.replace(title,'');
            if(code=='' | code[0]!=',') {
                print(code);
                throw 'Error! Ilegal net point format. A net point must be title"text"(title,title)';
            }
            code=code.slice(1,code.length);
            con1_name=code.match(title)[0];
            code=code.replace(title,'');
            if(code=='' | code[0]!=')') {
                throw 'Error! Unbalanced bracket in a net point format!';
            }
            code=code.slice(1,code.length);
        }
        if(name=='') {
            print('Warning! There is a point without a name!');
        }
        var netP=pointStack.buildNetP(name,con0_name,con1_name);
        //var netP=new NetP(name,text);
        netP.m_text=text;
        return [code,netP,pointStack];
    }



    textToken(code) {
        var text='';
        var preEnd=true;
        
        while(true) {
            if(code=='') {
                break;
            }
            
            else if(code.length>1 & code.slice(0,2)=='\\"') {
                preEnd=false;
            }
            
            else if(code[0]=='\"' & preEnd==true) {
                break;
            }
            
            else {
                text+=code[0];
                preEnd=true;
            }
            code=code.slice(1,code.length);
        }
        return [code,text];
    }


    buildRelation(karma,typeCon,effect) {
        if(typeCon=='->') {
            karma.m_yese.push(effect);
        }
        
        else if(typeCon=='->>') {
            karma.m_noe.push(effect);
        }
        
        else if(typeCon=='=>') {
            karma.m_yese.push(effect);
            effect.m_no=true;
        }
        
        else if(typeCon=='=>>') {
            karma.m_noe.push(effect);
            effect.m_no=true;
        }
        
        else {
            throw 'Error! Ilegal connection type!';
        }
        effect.m_cause=karma;
    }

}


function info_PtList(list_pt) {
    var info_pt='';
    for(var i=0;i<list_pt.length;i++) {
        var pt=list_pt[i];
        info_pt+=pt.info()+','
    }

    return `[${info_pt}]`;
}


function info_PtPool(pool_pt) {
    var info_pt='';
    for(var key in pool_pt) {
        var list_pt=pool_pt[key];
        info_pt+=key+`: ${info_PtList(list_pt)},`;
    }

    return `{${info_pt}}`;
}

function printPtList(list_pt) {
    print(info_PtList(list_pt));
}

function printPtPool(pool_pt) {
    print(info_PtPool(pool_pt));
}


function mergeArrays(list0,list1) {
    for(var j=0;j<list1.length;j++) {
        if(!list0.includes(list1[j])) {
            list0.push(list1[j]);
        }
    }
}

/*
+[J函数](,JS版本)

保存run_code:...
*/

function run_code_line(km,list_pt) {
    var code,list_km,list_new;

    //[code,km]=parser.chainToken(code0);
    list_km=km.allEffects();
    
    list_km[0].m_stage=1;
    var change=true,change1;
    
    while(change) {
        change=false;
        for(var i=0;i<list_km.length;i++) {
            [change1,list_new]=list_km[i].Reason_oneStep(list_pt);
            karma=list_km[i];
            //print(karma.info(),list_new.length);
            mergeArrays(list_pt,list_new);
    
            if(change1 & !change) {
                change=true;
            }
        }
        //printPtList(list_pt);
        //print(change);
        //print();
    }
    return code;
}

function run_code(code0,list_pt) {
    var code1=code0;
    var parser=new Parser();
    list_km=parser.readSubCode_tokener(code0);

    for(var i in list_km) {
        run_code_line(list_km[i],list_pt);
    }

    return code0;
}



/*
chain
+[J函数](,JS版本)
测试stdCode:...
测试Parser:...
测试:...
+[J函数](,测试)
+[新建阅读窗口](,测试)
*/
/*
+[J函数](,JS版本)
do
run_code_line
+[新建阅读窗口](,测试)
*/

function listFromPt(pt) {
    var list_pt=[];

    if(pt=='') {
        return list_pt;
    }

    for(var i=0;i<pt.m_con.length;i++) {
        if(pt.m_con[i].m_name=='的' & pt.m_con[i].m_db[1]!='') {
            list_pt.push(pt.m_con[i].m_db[1]);
        }
    }
    return list_pt;
}


class StCore {
    constructor() {
        this.m_parser=new Parser();
        this.m_lib='';
        this.m_idea='';
    }

    do(code,pt_in='',list_global=[]) {
        var list_pt=listFromPt(pt_in)
        var list_new=[];
        var list_km=[];

        mergeArrays(list_pt,list_global);
        if(!list_pt.includes(pt_in) & pt_in!='') {
            list_pt.push(pt_in);
        }

        [code,list_km]=this.run_code(code,list_pt,list_new);
        this.operation(list_new);
        
        for(var i=0;i<list_new.length;i++) {
            var pt=list_new[i],pt_de;
            pt_de=new NetP('的');
            pt_de.con(pt_in,pt);
        }
    
        return [code,list_km];
    }

    make(code,pt_in='') {
        var list_pt=this.m_parser.buildPoints_tokener(code);
        if(pt_in==='') {
            return list_pt
        }
        for(var i in list_pt) {
            var pt=list_pt[i];
            new NetP('的').con(pt_in,pt);
        }
        return list_pt;
    }

/*
保存run_code_line:...
*/

    run_code_line(km,list_pt,list_ns) {
        var code,list_km,list_new
        var karma,int_result=false;
        var pool=listPt2poolPt(list_pt);

        list_km=km.allEffects();
        
        list_km[0].m_stage=1;
        var change=true,change1;

        while(change) {
            change=false;
            for(var i=0;i<list_km.length;i++) {
                [change1,list_new]=list_km[i].Reason_oneStep(pool);
                karma=list_km[i];

//print(karma.info(),karma.m_interp);
                if(karma.m_interp) {
                    int_result=this.think(karma.m_map);
//print(int_result);
                    if(!int_result) {
                        karma.m_map='';
                    }
                }

//printPtList(karma.m_listMP)
//printPtList(list_new);
                listPtIntoPoolPt(pool,list_new);
                mergeArrays(list_pt,list_new);
                mergeArrays(list_ns,list_new);
        
                if(change1 & !change) {
                    change=true;
                }
            }
        }
        return true;
    }
    
    run_code(code0,list_pt,list_ns=[]) {
        var code1=code0,list_km;
        var parser=this.m_parser;

        list_km=parser.readSubCode_tokener(code0);

        for(var i in list_km) {
            this.run_code_line(list_km[i],list_pt,list_ns);
        }

        return [code0,list_km];
    }

    act(pt_code,pt) {
        var code1=pt_code.m_text;
        var list_km=[],list_new=[],result=false;
        var parser=this.m_parser;
    
        list_km=parser.readSubCode_tokener(code1);
    
        list_km[0].m_listMP=[pt];
        list_km[0].m_restricted=true;

        result=this.run_code_line(list_km[0],[pt_code],list_new);
        if(result) {
            this.operation(list_new);
        }
        return result;
    }

    operation(list_pt) {
        var list_del=[];
        for(var i=0;i<list_pt.length;i++) {
    //    for(var i=list_pt.length-1;i>=0;i--) {
            var pt=list_pt[i];
            var operated=false;
            var sbj=pt.m_db[0],obj=pt.m_db[1];

            if(pt.m_name=='[del]') {
                this.opDel(pt,list_pt,list_del);
                operated=true;
            }
            else if(pt.m_name=='[消息窗口]') {
                this.opMsgWin(pt);
                operated=true;
            }
            else if(pt.m_name=='[左连]') {
                this.opConnect(sbj,obj,0);
                operated=true;
            }
            else if(pt.m_name=='[右连]') {
                this.opConnect(sbj,obj,1);
                operated=true;
            }
            else if(pt.m_name.length>1 & pt.m_name[0]=='[' & pt.m_name[pt.m_name.length-1]==']') {
                this.opLibDefined(pt);
                operated=true;
            }
            if(operated) {
                list_del.push(i);
            }
        }

        for(var i=list_del.length;i>0;i--) {
            var i_del=list_del[i-1];
            var pt_del=list_pt[i_del];
            list_pt.splice(i_del,1);
            pt_del.delete();
            //delete pt_del;
        }
    }
    
    opMsgWin(action) {
        var obj=action.m_db[1];
        var name,text;
        if(obj=='' & action.m_text=='') {
            return;
        }
        else if(action.m_text=='') {
            name=obj.info();
            text=obj.m_text;
        }
        else if(obj=='') {
            name='消息';
            text=action.m_text;
        }
        alert(`${name}: ${text}`);
    }
    
    opDel(action,list_pt,list_del) {
        if(action.m_db[1]=='') {
            return;
        }
        var pt_del=action.m_db[1];
        pt_del.delete()

        if(pt_del in list_del) {
            return;
        }
        else {
            list_del.push(list_pt.indexOf(pt_del));
        }
    }

    opConnect(sbj,obj,i) {
        if(sbj=='') {
            return;
        }
        sbj.disconnect_i(i);
        sbj.connect(obj,i);
    }

    opLibDefined(action) {
        var list_pt=listFromPt(this.m_lib);
        var name=action.m_name.slice(1,action.m_name.length-1);
        var result=false;

        for(var i in list_pt) {
            var pt=list_pt[i];
            if(name===list_pt[i].m_name) {
                result=this.act(list_pt[i].m_text,action);
                if(result) {
                    break;
                }
            }
        }
    }

think(question,list_new) {
    var result=false;
    var list_pt=listFromPt(this.m_idea);
    var name=question.m_name.slice(1,question.m_name.length-1);

    for(var i in list_pt) {
        var pt=list_pt[i];
        if(name===list_pt[i].m_name) {
            result=this.match(list_pt[i],question);
            if(result) {
                return true;
            }
        }
    }
    result=this.termBuiltin(question);
    return result;
}

match(pt_A,pt_Q) {
    var code1=pt_A.m_text;
    var list_km=[],list_new=[],result=false;
    var parser=this.m_parser;

    list_km=parser.readSubCode_tokener(code1);

    list_km[0].m_listMP=[pt_Q];
    list_km[0].m_restricted=true;

    result=this.run_code_line(list_km[0],[pt_A],list_new);
    return result;
}

termBuiltin(question) {
    var sbj,obj;
    sbj=question.m_db[0];
    obj=question.m_db[1];
    
    if(question.m_name=='[m_name]') {
        return this.answerQuestion(question);
    }
    
    return false;
}

answerQuestion(question) {
    var name=question.m_name;
    if(name.length<2) {
        return false;
    }
    if(name[0]==='[' & name[name.length-1]===']') {
        question.m_name=name.slice(1,name.length-1);
        question.m_creator='Nini';
    }
    return true;
}

}

function listPt2poolPt(list_pt) {
    var pool={};
    
    for(var i=0;i<list_pt.length;i++) {
        var pt=list_pt[i];
        var name=pt.m_name;
        
        if(pool[name]===undefined) {
            pool[name]=[pt];
        }
        else {
            pool[name].push(pt);
        }
    }

    return pool;
}

function listPtIntoPoolPt(pool,list_pt) {
    for(var i=0;i<list_pt.length;i++) {
        var pt=list_pt[i];
        var name=pt.m_name;
        
        if(pool[name]===undefined) {
            pool[name]=[pt];
        }
        else if(!pool[name].includes(pt)) {
            pool[name].push(pt);
        }
    }

    return pool;
}

function poolPt2listPt(pool) {
    var list_pt=[];
    
    for(var key in pool) {
        list_pt=[...list_pt,...pool[key]];
    }
    
    return list_pt;
}

var Nini=new StCore();


/*
act()
+[J函数](,JS版本)
测试:...
+[新建阅读窗口](,测试)
*/
function print() {
    if(document.getElementById("cmd_window").innerHTML===null) {
        return;
    }

    document.getElementById("cmd_window").innerHTML+="<br>";
    for (var i=0; i < arguments.length; i++) {
        text=arguments[i];
        document.getElementById("cmd_window").innerHTML+=" "+text;
    }
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, 'cmd_window']);
}

function arrayRemove(arr,value) {
    a=arr.filter(function(ele) {
            return ele!=value;
        }
    );
    return a;
}
</script>




<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {
  box-sizing: border-box;
  font-family: Arial, Helvetica, sans-serif;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
}

/* Style the top navigation bar */
.topnav {
  overflow: hidden;
  background-color: #333;
}

/* Style the topnav links */
.topnav a {
  float: left;
  display: block;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

/* Change color on hover */
.topnav a:hover {
  background-color: #ddd;
  color: black;
}


/* Style the content */
.content {
  background-color: #fff;
  padding: 10px;
}

/*
+[网页](web,实验室日历模板)
*/

/* Style the footer */
.footer {
  background-color: #333;
  padding: 10px;
  margin-top: 20px
}

.footer p {
  color: #ddd
}

</style>


  </head>


<body>
<div class="topnav">
  <a href="#">Link</a>
  <a href="#">Link</a>
  <a href="#">Link</a>
</div>


<div class="content">
    <p><mathjax style=\"font-size:1.5em\">
<!--
+[H函数](,Nini聊天框)

emoji::https://unicode.org/emoji/charts/full-emoji-list.html#1f92b

-->

<style>
.window {
  position: relative;
  width: 90%;
  #overflow: hidden;
  overflow: auto;
  # padding-top: 20%;
  left: 5%;
  border: 2px solid #888888;
}

.window.history {
  height: 60%;
  background-color: lightgrey;
}

.window.me {
  background-color: white;
}

.chat-bubble {
    margin: 10px;
    display: inline-block;
    position: relative;
    width: auto;
    height: auto;
}

.chat-bubble.Nini {
    float: left;
    clear: both;
    background-color: white;
}

.chat-bubble.me {
    float: right;
    clear: both;
    background-color: lightgreen;
}

.talktext{
    padding: 1em;
    text-align: left;
    line-height: 1.5em;
}

</style>

<!--
+[H函数](,Nini聊天框)
&#129409
&#x1f611
&#x1f612
&#x1f623
&#x1f603
-->

<h1 id='Nini_face'>Nini: &#x1f603</h1>

<div id="chat_history" class="window history">

<div class="chat-bubble Nini">
    <div class="talktext">
你好!
    </div>
</div>

</div>

<br>

<textarea class="window me" id='edit_box' rows=4>
+[消息窗口](,+A)->+A(,+B)
</textarea>

<p id='cmd_window'></p>

<script>

var face_normal='&#x1f611';
var face_see='&#x1f612';
var face_bad='&#x1f623';
var face_happy='&#x1f603';

var pt_Nini=new NetP('Nini');

edit_box.addEventListener("keydown", function (event) {
    if(event.key==='Enter') {
        var code=edit_box.value;
        edit_box.value='';
        event.preventDefault();
        updateChatHistory(code);
        runCode_Nini(code);
    }
});

function updateChatHistory(code) {
    chat_history.innerHTML+=`
<div class="chat-bubble me">
    <div class="talktext">
${code}
    </div>
</div>
`;

chat_history.scrollTop = chat_history.scrollHeight;

}

function runCode_Nini(code) {
    Nini.do(code,pt_Nini);
    Nini_face.innerHTML=`Nini: ${face_see}`;
}


</script>


<!--
+[H函数](,Nini聊天框)
-->
    </mathjax></p>
</div>

<div class="footer">
  <p>Footer</p>
</div>

</body>
</html>