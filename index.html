function arrayRemove(arr,value) {
    a=arr.filter(function(ele) {
            return ele!=value;
        }
    );
    return a;
}

class NetP {
    constructor(name,text='') {
        this.m_master='';
        this.m_needed='';
        this.m_created='';
        this.m_dev='';
        this.m_var='';

        this.m_permission=4;


        this.m_name=name;
        this.m_text=text;
        this.m_db=['',''];
        this.m_con=[];
    }

    connect(con,index) {
        if(index>1 | index<0) {
            return
        }
        else {
            this.disconnect_i(index)
            this.m_db[index]=con
            if(con!='') {
                if(!con.m_con.includes(this)) {
                    con.m_con.push(this)
                }
            }
        }
    }

/*
+[J函数](,JS版本)
*/

    disconnect_i(index) {
        var con;
        if(index==0 | index==1) {
            con=this.m_db[index];
            this.m_db[index]=''
            if(con!='') {
                if(con.m_con.includes(this)) {
                    if(con!=this.m_db[1-index]) {
                        arrayRemove(con.m_con,this);
                    }
                }
            }
        }
    }

    delete() {
        this.disconnect_i(0);
        this.disconnect_i(1);
        var cons=this.m_con.slice();
        for(var i;i<cons.length;i++) {
            var point=cons[i];
            if(point.m_db[0]==this) {
                point.disconnect(0);
            }
            if(point.m_db[1]==this) {
                point.disconnect(1);
            }
        }
    }

    con(con0,con1) {
        var con0,con1;
        if(con0!=0) {
            this.disconnect_i(0)
            this.connect(con0,0)
        }
        if(con1!=0) {
            this.disconnect_i(1)
            this.connect(con1,1)
        }
        return this
    }

    info() {
    
        var str_info, str_d, str_b;
        if (this.m_db[0]=='') {
            str_d='';
        } else {
            str_d=this.m_db[0].m_name;
        }

        if (this.m_db[1]=='') {
            str_b='';
        }
        else {
            str_b=this.m_db[1].m_name;
        }
        
        str_info=`${this.m_name}(${str_d},${str_b})`;

        return str_info;
    }
}


var a=new NetP('a');
var b=new NetP('b');
var c=new NetP('c');

a.con(c,b)
print(a.info())


D1=20;
D2=10;
1/(1/2*(3/D2-1/D1))
/*
记住"Matlab"
Nini, 打开动作(库)
Nini, 打开JS编译器(文件)
+[J函数](,JS版本)
*/
/*
保存:...
+[J函数](,JS版本)
allEffects
J函数(JS版本,)
*/


class Karma {

    constructor(symbol) {
        this.m_symbol=symbol;
        symbol.m_master=this;
        this.m_creator='';
        this.m_map='';
        this.m_cause='';
        this.m_yese=[];
        this.m_noe=[];
        this.m_yesAnd=false;
        this.m_noAnd=false;
        this.m_eoi=0;
        this.m_clause=[];
        this.m_clauseAnd=true;
        this.m_clauseNew=[];
        this.m_clauseCollect=false;
        this.m_clauseOut=false;
        this.m_clauseIn=false;
        this.m_not=false;
        this.m_no=false;
        this.m_buildMode=false;
        this.m_listMP='';
        this.m_restricted=false;
        this.m_ranger='';
        this.m_rangType=false
        this.m_stage=0;
        this.m_reState='';
        this.m_choose=true;
        this.m_interp=false;
    }

    addKarma(karma,con_type='肯定') {
        
        while(karma.m_cause!='') {
            karma=karma.m_cause;
        }
        if(con_type=="clause" | con_type=="从句") {
            this.m_clause.push(karma);
        }
        
        else if(con_type=="no" | con_type=="否定") {
            this.m_noe.push(karma);
        }
        
        else {
            this.m_yese.push(karma);
        }
        karma.m_cause=this;
    }

    info_cause() {
        var info='';
        var karma=this;
        
        while(true) {
            if(karma.m_symbol!='') {
                info=karma.m_symbol.m_name+info;
            }
            if(karma.m_cause=='') {
                break;
            }
            if(karma.m_cause.m_yese.includes(karma)) {
                if(karma.m_no==true) {
                    info='=>'+info;
                }
                
                else {
                    info='->'+info;
                }
            }
            
            else if(karma.m_cause.m_noe.includes(karma)) {
                if(karma.m_no==true) {
                    info='=>>'+info;
                }
                
                else {
                    info='->>'+info;
                }
            }
            
            else if(karma.m_cause.m_clause.includes(karma)) {
                info='=='+info;
            }
            karma=karma.m_cause;
        }
        return info;
    }


    stateSelf() {
        var name;

        if(this.m_interp==true) {
            return 'blue';
        }
        if(this.m_symbol=='' | this.m_map=='') {
            return 'yellow';
        }
        if(this.m_symbol.m_name=='[eq]' | this.m_symbol.m_name=='[同名]') {
            return this.stateSelf_eq();
        }
        
        else if(this.m_symbol.m_name=='[is]' | this.m_symbol.m_name=='[是]') {
            return this.stateSelf_is();
        }
        
        else if(this.m_symbol.m_name=='[那]') {
            return 'green';
        }
        if(this.m_symbol.m_name=='_正则表达式' | this.m_symbol.m_name=='_re') {
            
            try {
                pattern=new RegEx(this.m_symbol.m_text);
            } catch(e) {
                print('Invalid regular expression: ',this.m_symbol.m_text,'!');
                return 'red';
            }
            match=this.m_map.m_name;
            if(pattern.test(match)) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
        if(this.m_symbol.m_name!='' & this.m_symbol.m_name[0]=='_') {
            name=this.m_symbol.m_name.slice(1,this.m_symbol.m_name.length);
            var name_m=this.m_map.m_name;
            if(name.length==0) {
                return 'green';
            }
            
            else if(name[0]=='[' & name[name.length-1]==']') {
                if(name_m.length>=2 & name_m[0]=='[' & name_m[name_m.length-1]==']') {
                    return 'green';
                }
                
                else {
                    return 'red';
                }
            }
            
            else {
                return 'green';
            }
        }
        if(this.m_symbol.m_name.length > 1 & this.m_symbol.m_name[0]=='[' & this.m_symbol.m_name[this.m_symbol.m_name.length-1]==']') {
            var name1=this.m_symbol.m_name.slice(1,this.m_symbol.m_name.length-1);
            var name2=this.m_symbol.m_name;
            if(this.m_interp==false & this.m_map.m_creator=='' & this.m_buildMode==false) {
                return 'red';
            }
            if(name1==this.m_map.m_name | name2==this.m_map.m_name) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
        if(this.m_symbol.m_name!='' & this.m_symbol.m_name[0]=='~') {
            name=this.m_symbol.m_name.slice(1,this.m_symbol.m_name.length);
            if(name==this.m_map.m_name) {
                return 'red';
            }
            
            else {
                return 'green';
            }
        }
        
        else {
            name=this.m_map.m_name;
            if(name!='' & name[0]=='[' & name[name.length-1]==']') {
                name=name.slice(1,name.length-1);
            }
            if(name!=this.m_symbol.m_name) {
                return 'red';
            }
            
            else if(this.m_symbol.m_text!='' & this.m_symbol.m_text!=this.m_map.m_text) {
                return 'red';
            }
            
            else {
                return 'green';
            }
        }
    }


    stateSelf_eq() {
        var karmaL,karmaR;
        var nameL,nameR;

        if(this.m_map=='') {
            return 'yellow';
        }
        if(this.m_symbol.m_db[0]=='' | this.m_symbol.m_db[1]=='') {
            return 'red';
        }
        karmaL=this.m_symbol.m_db[0].m_master;
        karmaR=this.m_symbol.m_db[1].m_master;
        if(karmaL=='' | karmaR=='') {
            print('Error! [eq] doesn\'t have sbj | obj.');
            print('Sbj:',karmaL);
            print('Obj:',karmaR);
            return 'red';
        }
        if(karmaL.m_map=='' | karmaR.m_map=='') {
            return 'green';
        }
        
        else {
            nameL=karmaL.m_map.m_name;
            nameR=karmaR.m_map.m_name;
            if(karmaL.m_map.m_name.length>1 & karmaL.m_map.m_name[0]=='[' & karmaL.m_map.m_name[karmaL.m_map.m_name.length-1]==']') {
                nameL=karmaL.m_map.m_name.slice(1,karmaL.m_map.m_name.length-1);
            }
            if(karmaR.m_map.m_name.length>1 & karmaR.m_map.m_name[0]=='[' & karmaR.m_map.m_name[karmaR.m_map.m_name.length-1]==']') {
                nameR=karmaR.m_map.m_name.slice(1,karmaR.m_map.m_name.length-1);
            }
            if(nameL==nameR) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
    }


    stateSelf_is() {
        var karmaL,karmaR;
        if(this.m_map=='') {
            return 'yellow';
        }
        if(this.m_symbol.m_db[0]=='' | this.m_symbol.m_db[1]=='') {
            return 'red';
        }
        karmaL=this.m_symbol.m_db[0].m_master;
        karmaR=this.m_symbol.m_db[1].m_master;
        if(karmaL.m_map=='' | karmaR.m_map=='') {
            return 'green';
        }
        
        else {
            if(karmaL.m_map==karmaR.m_map) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
    }



    stateRelation() {
        if(this.m_map=='' | this.m_symbol=='') {
            return true;
        }
        var cause=this.m_cause;
        
        while(cause!='') {
            if(cause.m_symbol==this.m_symbol.m_db[0]) {
                if(cause.m_map!=this.m_map.m_db[0]) {
                    return false;
                }
            }
            if(cause.m_symbol==this.m_symbol.m_db[1]) {
                if(cause.m_map!=this.m_map.m_db[1]) {
                    return false;
                }
            }

// For a function point, you should check the relation between the point through the function point selfstate()
            if(cause.m_symbol.m_db[0]==this.m_symbol) {
                if(cause.m_map.m_db[0]!=this.m_map | cause.stateSelf()=='red') {
                    return false;
                }
            }
            if(cause.m_symbol.m_db[1]==this.m_symbol) {
                if(cause.m_map.m_db[1]!=this.m_map | cause.stateSelf()=='red') {
                    return false;
                }
            }
            cause=cause.m_cause;
        }
        return true;
    }

/*
newMap存档:...
Reason_oneStep
delete
list_have
info_cause
*/

    //newMap(pool,areaType,list_new) {
    newMap(list_map,areaType,list_new) {
        // list_map=this.rangeList(pool,areaType,list_new);
        // var list_map=[];
        var name;
        if(this.m_buildMode==false | areaType==false) {
            name=this.m_symbol.m_name;
            if(this.isPreDefined()) {
                if(this.m_map=='') {
                    point=new NetP(name,this.m_symbol.m_text);
                    point.m_needed=this;
                    point.m_creator=this;
                    this.map(point);
                }
                
                else {
                    this.m_map.delete();
                    delete this.m_map;
                    this.map('');
                }
                return;
            }
            
            else if(this.isFunctionPoint()==2) {
                if(this.m_map=='') {
                    point=new NetP(name,this.m_symbol.m_text);
                    point.m_needed=this;
                    this.map(point);
                }
                
                else {
                    this.map(this.m_map);
                }
                this.m_interp=true;
                return;
            }
            var list_have=list_map;
            var mp=this.m_map;
            this.map(this.nextInlist(mp,list_have));
            return;
        }
        
        else {
            name=this.m_symbol.m_name;
            if(name!='' & (name[0]!='[' | name[name.length-1]!=']')) {
                if(this.m_map!='') {
                    this.m_map.m_creator='';
                    if(this.m_map.m_needed=='') {
                        this.m_map.delete();
                        this.map('');
                        return;
                    }
                    
                    else {
                        this.m_map.m_name='['+this.m_map.m_name+']';
                    }
                }
                var list_need=[];
                
                for(var i=0;i<list_map.length;i++) {
                    var point=list_map[i];
                    if(point.m_creator=='' & point.m_needed!='') {
                        list_need.push(point);
                    }
                }
                point=this.m_map;
                this.map(this.nextInlist(point,list_need));
                if(this.m_map=='') {
                    if(this.m_restricted==true) {
                        this.map('');
                        return;
                    }
                    point=new NetP(this.m_symbol.m_name,this.m_symbol.m_text);
                    point.m_building=true;
                    this.map(point);
                }
                
                else {
                    this.m_map.m_building=true;
                    this.m_map.m_name=this.m_map.m_name.slice(1,this.m_map.m_name.length-1);
                }
                this.m_map.m_creator=this;
                return;
            }
            else {
                if(this.m_map=='') {
                    point=new NetP(name,this.m_symbol.m_text);
                    point.m_building=true;
                    point.m_needed=this;
                    this.map(point);
                    return;
                } else {
                    this.m_map.m_needed='';
                    this.m_map.delete();
                    this.map('');
                    return;
                }
            }
        } 

        this.map('');
    }
/*
+[J函数](,JS版本)
*/

    nextInlist(point,list_pt) {
        var i;
        if(list_pt.length==0) {
            return '';
        }
        if(point=='') {
            return list_pt[0];
        }
        
        try {
            i=list_pt.lastIndexOf(point);
        } catch(e) {
            return '';
        }

        if(i+1>=list_pt.length) {
            return '';
        }
        else {
            return list_pt[i+1];
        }
    }

/*
+[J函数](,JS版本)
*/

    map(point) {
        var cause;
        this.clearAll();
        this.m_map=point;
        if(this.m_map!='') {
            cause=this.m_cause;
            
            while(cause!='') {
                if(cause.needBuildRelation()) {
                    if(cause.m_map.m_needed=='' | cause.m_map.m_needed==cause) {
                        if(cause.m_symbol.m_db[0]==this.m_symbol) {
                            cause.m_map.connect(this.m_map,0);
                        }
                        if(cause.m_symbol.m_db[1]==this.m_symbol) {
                            cause.m_map.connect(this.m_map,1);
                        }
                    }
                }
                if(this.needBuildRelation()) {
                    if(this.m_map.m_needed=='' | this.m_map.m_needed==this) {
                        if(this.m_symbol.m_db[0]==cause.m_symbol) {
                            this.m_map.connect(cause.m_map,0);
                        }
                        if(this.m_symbol.m_db[1]==cause.m_symbol) {
                            this.m_map.connect(cause.m_map,1);
                        }
                    }
                }
                cause=cause.m_cause;
            }
        }
    }

/*
+[J函数](,JS版本)
info(
*/

    clearAll() {
        this.m_map='';
        this.m_stage=0;
        this.m_interp=false;
        this.m_reState='';
        this.m_choose=true;
        this.m_eoi=0;
        if(this.m_restricted==false) {
            delete this.m_listMP;
            this.m_listMP='';
        }
        
        for(var i=0;i<this.m_clause.length;i++) {
            var clause=this.m_clause[i];
            clause.clearAll();
        }
        
        for(var i=0;i<this.m_noe.length;i++) {
            var end=this.m_noe[i];
            end.clearAll();
        }
        
        for(var i=0;i<this.m_yese.length;i++) {
            var end=this.m_yese[i];
            end.clearAll();
        }
    }


    needBuildRelation() {
        if(this.buildingNewMap()) {
            return true;
        }
        
        else if(this.isFunctionPoint()!=0) {
            return true;
        }
        return false;
    }



    buildingNewMap() {
        if(this.m_map=='') {
            return false;
        }
        
        else if(this.m_buildMode==false) {
            return false;
        }
        
        else {
            if(this.m_map.m_needed=='') {
                return true;
            }
        }
        return false;
    }



    isFunctionPoint() {
        if(this.m_symbol.m_name=='') {
            return 0;
        }
        
        else if(this.m_symbol.m_name=='[eq]' | this.m_symbol.m_name=='[同名]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name=='[is]' | this.m_symbol.m_name=='[是]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name=='[那]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name=='[]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name[0]=='[' & this.m_symbol.m_name[this.m_symbol.m_name.length-1]==']') {
            return 2;
        }
        return 0;
    }

/*
list_have
*/

    isPreDefined() {
        var name=this.m_symbol.m_name;
        if(name=='[is]' | name=='[eq]' | name=='[那]' | name=='[]') {
            return true;
        }
        
        else {
            return false;
        }
    }


    areaType() {
        return 0;
    }

/*
+[J函数](,JS版本)
length
new NetP
*/

    Reason_oneStep(pool) {
        var list_new=[];
        // var areaType=areaType.concat(this.areaType());
        var areaType=true;
        var change=false;
        var keep=true;

        if(this.m_stage==0) {
            if(this.m_cause!='') {
                if(this.m_cause.m_clause.includes(this)) {
                    if(this.m_cause.m_stage==2) {
                        this.m_stage=1;
                        change=true;
                    }
                }
            }
        }

        if(this.m_stage==1) {
            
            while(true) {
                if(this.stateSelf()!='blue') {
                    this.newMap(pool,areaType,list_new);
                }
                
                else {
                    this.m_interp=false;
                }
                change=true;
                if(this.stateRelation()==false) {
                    continue;
                }
                
                else if(this.stateSelf()=='red') {
                    continue;
                }
                
                else if(this.stateSelf()=='yellow') {
                    this.m_stage=5;
                    if(this.m_no==false) {
                        this.m_reState='dark yellow';
                        return [change,list_new];
                    }
                    
                    else {
                        this.m_reState='dark green';
                        return [change,list_new];
                    }
                }
                
                else if(this.stateSelf()=='blue') {
                    this.m_stage=1;
                    return [change,list_new];
                }
                
                else {
                    this.m_stage=2;
                    break;
                }
            }
        }

        if(this.m_stage==2) {

            if(this.m_clause.length==0) {
                this.m_choose=true;
                this.m_stage=3;
                change=true;
            }
            
            else {
                this.m_choose=this.m_clauseAnd;
                keep=false;
            }

            
            for(var i=0;i<this.m_clause.length;i++) {
                var clause=this.m_clause[i];
                if(this.m_clauseAnd==true) {
                    if(clause.m_reState=='dark yellow') {
                        this.m_choose=false;
                        this.m_stage=3;
                        change=true;
                        this.m_clauseOut=true;
                        break;
                    }
                    
                    else if(clause.m_reState=='') {
                        keep=true;
                    }
                }
                
                else {
                    if(clause.m_reState=='dark green') {
                        this.m_choose=true;
                        this.m_stage=3;
                        change=true;
                        this.m_clauseOut=true;
                        break;
                    }
                    
                    else if(clause.m_reState=='') {
                        keep=true;
                    }
                }
            }

            if(this.m_clause.length!=0 & keep==false) {
                this.m_stage=3;
                change=true;
                this.m_clauseOut=true;
            }
        }


        if(this.m_stage==3) {
            if(this.m_choose==false) {
                if(this.m_noe.length==0) {
                    this.m_stage=1;
                    change=true;
                    return [change,list_new];
                }
                i=this.m_eoi;
                var end=this.m_noe[i];
                if(end.m_stage==0) {
                    end.m_stage=1;
                    change=true;
                }
                
                else if(end.m_reState=='dark yellow') {
                    if(this.m_noAnd==true) {
                        this.m_stage=1;
                        change=true;
                    }
                    
                    else {
                        i+=1;
                        change=true;
                        if(i==this.m_noe.length) {
                            this.m_stage=1;
                            this.m_eoi=0;
                        }
                        
                        else {
                            this.m_eoi=i;
                        }
                    }
                }
                
                else if(end.m_reState=='dark green') {
                    if(this.m_noAnd!=true) {
                        this.m_stage=4;
                        change=true;
                    }
                    
                    else {
                        i+=1;
                        change=true;
                        if(i==this.m_noe.length) {
                            this.m_stage=4;
                            this.m_eoi=0;
                        }
                        
                        else {
                            this.m_eoi=i;
                        }
                    }
                }
            }
            
            else {
                if(this.m_yese.length==0 & this.m_noe.length==0) {
                    this.m_stage=4;
                    change=true;
                }
                
                else if(this.m_yese.length==0) {
                    this.m_stage=1;
                    change=true;
                    return [change,list_new];
                }
                
                else {
                    i=this.m_eoi;
                    end=this.m_yese[i];
                    if(end.m_stage==0) {
                        end.m_stage=1;
                        change=true;
                    }
                    
                    else if(end.m_reState=='dark yellow') {
                        if(this.m_yesAnd==true) {
                            this.m_stage=1;
                            change=true;
                        }
                        
                        else {
                            i+=1;
                            change=true;
                            if(i==this.m_yese.length) {
                                this.m_stage=1;
                                this.m_eoi=0;
                            }
                            
                            else {
                                this.m_eoi=i;
                            }
                        }
                    }
                    
                    else if(end.m_reState=='dark green') {
                        if(this.m_yesAnd!=true) {
                            this.m_stage=4;
                            change=true;
                        }
                        
                        else {
                            i+=1;
                            change=true;
                            if(i==this.m_yese.length) {
                                this.m_stage=4;
                                this.m_eoi=0;
                            }
                            
                            else {
                                this.m_eoi=i;
                            }
                        }
                    }
                }
            }
        }


        if(this.m_stage==4) {
            if(this.m_clauseNew.length!=0 | this.m_clauseOut==true) {
                this.m_clauseCollect=true;
            }
            if((this.m_buildMode==true | this.isFunctionPoint()==1) & this.m_map!='' & !list_new.includes(this.m_map)) {
                list_new.push(this.m_map);
            }
            this.m_stage=5;
            if(this.m_no==true) {
                this.m_reState='dark yellow';
                change=true;
                return [change,list_new];
            }
            
            else {
                this.m_reState='dark green';
                change=true;
                return [change,list_new];
            }
        }
        return [change,list_new];
    }


    allEffects() {
        var list_effects=[this];
        
        for(var i=0;i<this.m_clause.length;i++) {
            var karma=this.m_clause[i];
            list_effects=list_effects.concat(karma.allEffects());
        }
        
        for(var i=0;i<this.m_noe.length;i++) {
            var karma=this.m_noe[i];
            list_effects=list_effects.concat(karma.allEffects());
        }
        
        for(var i=0;i<this.m_yese.length;i++) {
            var karma=this.m_yese[i];
            list_effects=list_effects.concat(karma.allEffects());
        }
        return list_effects;
    }

    info() {
        var map,str_info;
        if(this.m_map!='') {
            map=this.m_map.info();
        }
        else {
            map='(None)';
        }
        var map_info,name_info;
        
        if(this.m_reState=='dark green') {
            name_info=`<span style="background-color:green;color:white;">${this.m_symbol.info()}</span>`;
        }
        else if(this.m_reState=='dark yellow') {
            name_info=`<span style="background-color:yellow;color:black;">${this.m_symbol.info()}</span>`;
        }
        else {
            name_info=`<span>${this.m_symbol.info()}</span>`;
        }
        
        if(this.stateSelf()=='yellow') {
            map_info=`<span style="background-color:${this.stateSelf()};">${map}</span>`;
        }
        else {
            map_info=`<span style="background-color:${this.stateSelf()};color:white;">${map}</span>`;
        }
        
        str_info=`${name_info}:${map_info},stage(${this.m_stage})`;
        return str_info;
    }


}







/*
stateRelation
name_m
nextInlist
concat
测试(J函数):...
+[新建阅读窗口](,测试)
*/
/*
+[J函数](,JS版本)

测试list:...
+[新建阅读窗口](,测试list)
str

保存:...
+[新建阅读窗口](,保存)
*/



function writeStdCode_karma(karma,list_pt) {
    var karma_code='',text='';

    if(karma=='') {
        return [karma_code,list_pt];
    }
    if(!list_pt.includes(karma.m_symbol)) {
        list_pt.push(karma.m_symbol);
    }
    if(karma.m_buildMode==true) {
        karma_code+='+';
    }
    // var n=list_pt.indexOf(karma.m_symbol);
    // karma_code+=(list_pt.indexOf(karma.m_symbol)).toString();
    karma_code+=karma.m_symbol.info();
    if(karma.m_clause.length!=0) {
        if(karma.m_clauseAnd==false) {
            karma_code+='|';
        }
        karma_code+='{';
        
        for(var i=0;i<karma.m_clause.length;i++) {
            var clause=karma.m_clause[i];
            [text,list_pt]=writeStdCode_karma(clause,list_pt);
            karma_code+=text;
            if(clause!=karma.m_clause[karma.m_clause.length-1]) {
                karma_code+=',';
            }
        }
        karma_code+='}';
    }
    if(karma.m_yese.length+karma.m_noe.length>1) {
        if(karma.m_yesAnd==true) {
            karma_code+='&';
        }
        karma_code+=':';
    }
    
    for(var i=0;i<karma.m_yese.length;i++) {
        var end=karma.m_yese[i];
        if(end.m_no==false) {
            karma_code+='->';
        }
        
        else {
            karma_code+='=>';
        }
        [text,list_pt]=writeStdCode_karma(end,list_pt);
        karma_code+=text;
        if(end!=karma.m_yese[karma.m_yese.length-1]) {
            karma_code+=',';
        }
    }
    
    for(var i=0;i<karma.m_noe.length;i++) {
        var end=karma.m_noe[i];
        if (karma.m_yese.length!=0) {
            karma_code+=',';
        }
        if(end.m_no==false) {
            karma_code+='->>';
        }
        
        else {
            karma_code+='=>>';
        }
        [text,list_pt]=writeStdCode_karma(end,list_pt);
        karma_code+=text;
        if(end!=karma.m_noe[karma.m_noe.length-1]) {
            karma_code+=',';
        }
    }
    if(karma.m_yese.length+karma.m_noe.length>1) {
        karma_code+=';';
    }
    return [karma_code,list_pt];
}

/*

保存NetPStack:...
*/

class NetPStack {
    
    constructor() {
        this.m_builtStack=[{}];
        this.m_undefinedStack=[{}];
    }

    popBuilt() {
        return this.m_builtStack.pop();
    }
    
    popUndefined() {
        return this.m_undefinedStack.pop();
    }
    
    pushBuilt(built) {
        this.m_builtStack.push(built);
    }
    
    pushUndefined(undefined_pt) {
        this.m_undefinedStack.push(undefined_pt);
    }
    
    enterClause() {
        var copy0={},copy1={};

        Object.assign(copy0,this.m_builtStack[this.m_builtStack.length-1]);
        this.m_builtStack.push(copy0);

        Object.assign(this.m_undefinedStack[this.m_undefinedStack.length-1],copy1);
        this.m_undefinedStack.push(copy1);
    }


    insertPtIntotKarma_back(km0,netP) {
        var km_new=new Karma(netP),km;
        if(netP.m_name.length>1 & netP.m_name[0]=='+') {
            netP.m_name=netP.m_name.slice(1,netP.m_name.length);
            km_new.m_buildMode=true;
        }
        
        for(var i=0;i<km0.m_clause.length;i++) {
            km=km0.m_clause[i];
            km.m_cause=km_new;
        }
        
        for(var i=0;i<km0.m_yese.length;i++) {
            km=km0.m_yese[i];
            km.m_cause=km_new;
        }
        
        for(var i=0;i<km0.m_noe.length;i++) {
            km=km0.m_noe[i];
            km.m_cause=km_new;
        }
        km_new.m_clause=km0.m_clause;
        km_new.m_yese=km0.m_yese;
        km_new.m_noe=km0.m_noe;
        km0.m_yese=[km_new];
        km0.m_noe=[];
        km_new.m_cause=km0;
    }
    

    insertPtIntotKarma_front(km0,netP) {
        var i;
        var km_new=new Karma(netP);
        if(netP.m_name.length>1 & netP.m_name[0]=='+') {
            netP.m_name=netP.m_name.slice(1,netP.m_name.length);
            km_new.m_buildMode=true;
        }
        if(km0.m_cause!='') {
            var cause=km0.m_cause;
            km_new.m_cause=cause;
            if(cause.m_clause.includes(km0)) {
                i=cause.m_clause.indexOf(km0);
                cause.m_clause.splice(i,1);
                cause.m_clause.push(km_new);
            }
            
            else if(cause.m_yese.includes(km0)) {
                i=cause.m_yese.indexOf(km0);
                cause.m_yese.splice(i,1);
                cause.m_yese.push(km_new);
            }
            
            else if(cause.m_noe.includes(km0)) {
                i=cause.m_noe.indexOf(km0);
                cause.m_noe.splice(i,1);
                cause.m_noe.push(km_new);
            }
            
            else {
                print("Warning! The karma:"+km0.m_symbol.info()+", has a weird cause karma.");
            }
        }
        km0.m_cause=km_new;
        km_new.m_yese=[km0];
        if(km0.m_no==true) {
            km0.m_no=false;
            km_new.m_no=true;
        }
    }


    insertPtIntotKarma(km0,netP) {
        var otherP;
        if(km0.m_symbol.m_db[0]==netP) {
            otherP=km0.m_symbol.m_db[1];
        }
        
        else if(km0.m_symbol.m_db[1]==netP) {
            otherP=km0.m_symbol.m_db[0];
        }
        
        else {
            return;
        }
        // if(km0.isType('新建') | km0.m_symbol.m_name=='[那]') {
        if(km0.m_symbol.m_name=='[那]') {
            insertPtIntotKarma_back(km0,netP);
        }
        
        // else if(km0.isType('普通非新建') | km0.m_symbol.m_name=='[is]') {
        else if(km0.m_symbol.m_name=='[is]') {
            if(otherP=='' | otherP.m_master=='') {
                this.insertPtIntotKarma_back(km0,netP);
            }
            
            // else if(otherP.m_master in km0.allCauses()) {
            //     this.insertPtIntotKarma_back(km0,netP);
            //}
            
            else {
                this.insertPtIntotKarma_front(km0,netP);
            }
        }
        
        //else if(km0.isType('引用')) {
        else {
            this.insertPtIntotKarma_front(km0,netP);
        }
    }



    leaveClause() {
        var dict_len=0,dict_undef={};
        var dict_len2=0,dict_undef2={};
        var pt,km_head;
        if(this.m_undefinedStack.length==1) {
            dict_undef=this.m_undefinedStack[this.m_undefinedStack.length-1];
            dict_len=Object.keys(dict_undef).length;
            if(dict_len!=0) {
                for(var term in dict_undef) {
                    pt=dict_undef[term];
                    if(pt.m_master=='') {
                        km_head=pt.m_con[0].m_master;
                        // this.insertPtIntotKarma(km_head,pt);
                    }
                }
            }
        }
        
        else {
            dict_undef=this.m_undefinedStack[this.m_undefinedStack.length-1];
            dict_len=Object.keys(dict_undef).length;

            dict_undef2=this.m_undefinedStack[this.m_undefinedStack.length-2];
            dict_len2=Object.keys(dict_undef2).length;

            if(dict_len>dict_len2) {
            
            for(var term in dict_undef) {
                if(dict_undef2[term]==undefined) {
                    pt=dict_undef[term];
                    if(pt.m_master=='') {
                        km_head=pt.m_con[0].m_master;
                        this.insertPtIntotKarma(km_head,pt);
                    }
                }
            }
        }
        }

        this.m_builtStack.pop();
        this.m_undefinedStack.pop();
    }
    
    popUndefinedName(name) {
        
        for(var i=0;i<this.m_undefinedStack.length;i++) {
            var stack=this.m_undefinedStack[i];
            delete stack[name];
        }
    }
    
    buildNetP(name,con0_name='',con1_name='') {
        var recent=this.m_builtStack[this.m_builtStack.length-1];
        var undefined_pt=this.m_undefinedStack[this.m_undefinedStack.length-1];
        var point=undefined_pt[name];
        if(point==undefined) {
            var name0=name;
            point=new NetP(name.replace(/#.*$/,''));
            recent[name0]=point;
        }
        
        else {
            delete undefined_pt[name];
        }
        if(con1_name!='') {
            var con1=recent[con1_name];
            if(con1==undefined) {
                var con1_name0=con1_name;
                con1=new NetP(con1_name.replace(/#.*$/,''));
                recent[con1_name0]=con1;
                undefined_pt[con1_name0]=con1;
            }
            point.connect(con1,1);
        }
        if(con0_name!='') {
            var con0=recent[con0_name];
            if(con0==undefined) {
                var con0_name0=con0_name;
                con0=new NetP(con0_name.replace(/#.*$/,''));
                recent[con0_name0]=con0;
                undefined_pt[con0_name]=con0;
            }
            point.connect(con0,0);
        }
        return point;
    }




}



class Parser {

    chainToken(code,pointStack='') {
        var karma;
        if(pointStack=='') {
            pointStack=new NetPStack();
        }
        [code,karma,pointStack]=this.karmaToken(code,pointStack);
        if(code=='' | code[0]==';' | code[0]=='\n' | code[0]=='}') {
            return [code,karma,pointStack];
        }
        
        else if(code[0]==',') {
            return [code,karma,pointStack];
        }
        
        else if(code[0]==':') {
            code=code.slice(1,code.length);
            [code,karma,pointStack]=this.splitToken(code,karma,pointStack);
        }
        
        else if(code[0]=='|' | code[0]=='&') {
            var typeSub=code[0];
            code=code.slice(1,code.length);
            if(code!='' & code[0]==':') {
                if(typeSub=='|') {
                    karma.m_noAnd=false;
                    karma.m_yesAnd=false;
                }
                
                else {
                    karma.m_noAnd=true;
                    karma.m_yesAnd=true;
                }
                code=code.slice(1,code.length);
                [code,karma,pointStack]=this.splitToken(code,karma,pointStack);
            }
        }
        
        else {
            var typeCon,effect;
            [code,typeCon]=this.conToken(code);
            [code,effect,pointStack]=this.chainToken(code,pointStack);
            this.buildRelation(karma,typeCon,effect);
        }
        return [code,karma,pointStack];
    }


    conToken(code) {
        var typeCon;
        while(code.length>3 & code.slice(0,3)=='...') {
            code=code.replace(/^\.\.\..*[\n\t ]*/,'');
        }
        code=code.replace(/^[ \t]*/,'');
        if(code.length>2 & code.slice(0,3)=='->>') {
            typeCon=code.slice(0,3);
            code=code.slice(3,code.length);
        }
        
        else if(code.length>2 & code.slice(0,3)=='=>>') {
            typeCon=code.slice(0,3);
            code=code.slice(3,code.length);
        }
        
        else if(code.length>1 & code.slice(0,2)=='->') {
            typeCon=code.slice(0,2);
            code=code.slice(2,code.length);
        }
        
        else if(code.length>1 & code.slice(0,2)=='=>') {
            typeCon=code.slice(0,2);
            code=code.slice(2,code.length);
        }
        
        else {
            print('\n\n\nIllegal connection symbol!\nCode:',code);
            //raise Exception('Illegal connection symbol!');
        }
        code=code.replace(/^[ \t]*/,'');
        return [code,typeCon];
    }


    clauseToken(code,karma,pointStack) {
        pointStack.enterClause();
        var clause;

        while(true) {
            code=code.replace(/^[ \t\n]*/,'');
            if(code=='') {
                //raise Exception('Error! Unbalanced bracket!');
            }
            
            else if(code[0]=='}') {
                break;
            }
            
            else {
                [code,clause,pointStack]=this.chainToken(code,pointStack);
                karma.m_clause.push(clause);
                clause.m_cause=karma;
                if(code!='' & code[0]!=',') {
                    break;
                }
                
                else if(code!='') {
                    code=code.slice(1,code.length);
                }
            }
        }
        pointStack.leaveClause();
        return [code,karma,pointStack];
    }


    splitToken(code,karma,pointStack) {
        var typeCon,effect;

        while(true) {
            code=code.replace(/^[ \t\n]*/,'');
            [code,typeCon]=this.conToken(code);
            [code,effect,pointStack]=this.chainToken(code,pointStack);
            this.buildRelation(karma,typeCon,effect);
            code=code.replace(/^[ \t\n]*/,'');
            if(code=='' | code[0]==';' | code[0]=='}') {
                break;
            }
            
            else if(code[0]!=',') {
                print('\n\n\n\nError! Ilegal splitting type!\nCode:',code);
                //raise Exception('Error! Ilegal splitting type!');
            }
            
            else {
                code=code.slice(1,code.length);
            }
        }
        return [code,karma,pointStack];
    }



    karmaToken(code,pointStack) {
        if(code=='') {
            //raise Exception('Error! Invalid karma detected!');
        }

        var buildType=false;
        var karma='';
        var netP;

        if(code[0]=='+') {
            buildType=true;
        }
        [code,netP,pointStack]=this.netPToken(code,pointStack);
        karma=new Karma(netP);
        if(buildType==true & netP.m_name!='+') {
            netP.m_name=netP.m_name.slice(1,netP.m_name.length);
            karma.m_buildMode=true;
        }

        if(code!='' & code[0]=='{') {
            code=code.slice(1,code.length);
            [code,karma,pointStack]=this.clauseToken(code,karma,pointStack);
            code=code.replace(/^[\n\t ]*/,'');
            if(code=='' | code[0]!='}') {
                print('\n\n\nError! Unbalanced bracket.\nCode:',code);
                //raise Exception('Error! Unbalanced bracket.');
            }
            
            else {
                code=code.slice(1,code.length);
            }
        }

        return [code,karma,pointStack];
    }


    netPToken(code,pointStack) {
        var title=/^[\w \[\]~#.+=\-^/*\\!<\']*|^\[>=?\]/;
        var name=code.match(title)[0];
        code=code.replace(title,'');
        if(name=='') {
            print('\n\n\nError! Invalid name.\nCode:',code);
            //raise Exception('Error! Invalid name.');
        }


        if(name[name.length-1]=='=' | name[name.length-1]=='-') {
            if(code.length>0 & code[0]=='>') {
                code=name[name.length-1]+code;
                name=name.slice(0,name.length-1);
            }
        }

        var con0_name='';
        var con1_name='';
        var text='';
        if(code!='' & code[0]=='\"') {
            code=code.slice(1,code.length);
            [code,text]=this.textToken(code);
            if(code=='' | code[0]!='\"') {
                print(code);
                //raise Exception('Error! Unbalanced quote!');
            }
            code=code.slice(1,code.length);
        }
        if(code!='' & code[0]=='(') {
            code=code.slice(1,code.length);
            con0_name=code.match(title)[0];
            code=code.replace(title,'');
            if(code=='' | code[0]!=',') {
                print(code);
                //raise Exception('Error! Ilegal net point format. A net point must be title"text"(title,title)');
            }
            code=code.slice(1,code.length);
            con1_name=code.match(title)[0];
            code=code.replace(title,'');
            if(code=='' | code[0]!=')') {
                //raise Exception('Error! Unbalanced bracket in a net point format!');
            }
            code=code.slice(1,code.length);
        }
        if(name=='') {
            print('Warning! There is a point without a name!');
        }
        var netP=pointStack.buildNetP(name,con0_name,con1_name);
        //var netP=new NetP(name,text);
        netP.m_text=text;
        return [code,netP,pointStack];
    }




    textToken(code) {
        var text='';
        var preEnd=true;
        
        while(true) {
            if(code=='') {
                break;
            }
            
            else if(code.length>1 & code.slice(0,2)=='\\"') {
                preEnd=false;
            }
            
            else if(code[0]=='\"' & preEnd==true) {
                break;
            }
            
            else {
                text+=code[0];
                preEnd=true;
            }
            code=code.slice(1,code.length);
        }
        return [code,text];
    }


    buildRelation(karma,typeCon,effect) {
        if(typeCon=='->') {
            karma.m_yese.push(effect);
        }
        
        else if(typeCon=='->>') {
            karma.m_noe.push(effect);
        }
        
        else if(typeCon=='=>') {
            karma.m_yese.push(effect);
            effect.m_no=true;
        }
        
        else if(typeCon=='=>>') {
            karma.m_noe.push(effect);
            effect.m_no=true;
        }
        
        else {
            //raise Exception('Error! Ilegal connection type!');
        }
        effect.m_cause=karma;
    }

}
