<!--
+[返回目录]

LaTeX数学记号::https://oeis.org/wiki/List_of_LaTeX_mathematical_symbols
+[打开](,LaTeX数学记号)
+[保存文本](,保存网页)
-->

<html>
  <head>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!--
Nini, 打开JS编译器(文件)
parser
保存:...
-->

<script>

/*
保存:...
+[J函数](,JS版本)
Reason_oneStep
J函数(JS版本,)

m_needed

参考::https://www.freecodecamp.org/news/how-to-clone-an-array-in-javascript-1d3183468f6a/
+[打开](,参考)
[:]
*/


class Karma {

    constructor(symbol) {
        this.m_symbol=symbol;
        symbol.m_master=this;
        this.m_creator='';
        this.m_map='';
        this.m_cause='';
        this.m_yese=[];
        this.m_noe=[];
        this.m_yesAnd=false;
        this.m_noAnd=false;
        this.m_eoi=0;
        this.m_clause=[];
        this.m_clauseAnd=true;

        this.m_clauseNew=[];
        this.m_clauseCollect=false;
        this.m_clauseOut=false;
        this.m_clauseIn=false;

        this.m_not=false;
        this.m_no=false;
        this.m_buildMode=false;

        this.m_listMP='';
        this.m_restricted=false;

        this.m_ranger='';
        this.m_rangType=false
        this.m_stage=0;
        this.m_reState='';
        this.m_choose=true;
        this.m_interp=false;
    }

    addKarma(karma,con_type='肯定') {
        
        while(karma.m_cause!='') {
            karma=karma.m_cause;
        }
        if(con_type=="clause" | con_type=="从句") {
            this.m_clause.push(karma);
        }
        
        else if(con_type=="no" | con_type=="否定") {
            this.m_noe.push(karma);
        }
        
        else {
            this.m_yese.push(karma);
        }
        karma.m_cause=this;
    }

    info_cause() {
        var info='';
        var karma=this;
        
        while(true) {
            if(karma.m_symbol!='') {
                info=karma.m_symbol.m_name+info;
            }
            if(karma.m_cause=='') {
                break;
            }
            if(karma.m_cause.m_yese.includes(karma)) {
                if(karma.m_no==true) {
                    info='=>'+info;
                }
                
                else {
                    info='->'+info;
                }
            }
            
            else if(karma.m_cause.m_noe.includes(karma)) {
                if(karma.m_no==true) {
                    info='=>>'+info;
                }
                
                else {
                    info='->>'+info;
                }
            }
            
            else if(karma.m_cause.m_clause.includes(karma)) {
                info='=='+info;
            }
            karma=karma.m_cause;
        }
        return info;
    }


    stateSelf() {
        var name;

        if(this.m_interp==true) {
            return 'blue';
        }
        if(this.m_symbol=='' | this.m_map=='') {
            return 'yellow';
        }
        if(this.m_symbol.m_name=='[eq]' | this.m_symbol.m_name=='[同名]') {
            return this.stateSelf_eq();
        }
        
        else if(this.m_symbol.m_name=='[is]' | this.m_symbol.m_name=='[是]') {
            return this.stateSelf_is();
        }
        
        else if(this.m_symbol.m_name=='[那]') {
            return 'green';
        }
        if(this.m_symbol.m_name=='_正则表达式' | this.m_symbol.m_name=='_re') {
            
            try {
                pattern=new RegEx(this.m_symbol.m_text);
            } catch(e) {
                print('Invalid regular expression: ',this.m_symbol.m_text,'!');
                return 'red';
            }
            match=this.m_map.m_name;
            if(pattern.test(match)) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
        if(this.m_symbol.m_name!='' & this.m_symbol.m_name[0]=='_') {
            name=this.m_symbol.m_name.slice(1,this.m_symbol.m_name.length);
            var name_m=this.m_map.m_name;
            if(name.length==0) {
                return 'green';
            }
            
            else if(name[0]=='[' & name[name.length-1]==']') {
                if(name_m.length>=2 & name_m[0]=='[' & name_m[name_m.length-1]==']') {
                    return 'green';
                }
                
                else {
                    return 'red';
                }
            }
            
            else {
                return 'green';
            }
        }
        if(this.m_symbol.m_name.length > 1 & this.m_symbol.m_name[0]=='[' & this.m_symbol.m_name[this.m_symbol.m_name.length-1]==']') {
            var name1=this.m_symbol.m_name.slice(1,this.m_symbol.m_name.length-1);
            var name2=this.m_symbol.m_name;
            if(this.m_interp==false & this.m_map.m_creator=='' & this.m_buildMode==false) {
                return 'red';
            }
            if(name1==this.m_map.m_name | name2==this.m_map.m_name) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
        if(this.m_symbol.m_name!='' & this.m_symbol.m_name[0]=='~') {
            name=this.m_symbol.m_name.slice(1,this.m_symbol.m_name.length);
            if(name==this.m_map.m_name) {
                return 'red';
            }
            
            else {
                return 'green';
            }
        }
        
        else {
            name=this.m_map.m_name;
            if(name!='' & name[0]=='[' & name[name.length-1]==']') {
                name=name.slice(1,name.length-1);
            }
            if(name!=this.m_symbol.m_name) {
                return 'red';
            }
            
            else if(this.m_symbol.m_text!='' & this.m_symbol.m_text!=this.m_map.m_text) {
                return 'red';
            }
            
            else {
                return 'green';
            }
        }
    }


    stateSelf_eq() {
        var karmaL,karmaR;
        var nameL,nameR;

        if(this.m_map=='') {
            return 'yellow';
        }
        if(this.m_symbol.m_db[0]=='' | this.m_symbol.m_db[1]=='') {
            return 'red';
        }
        karmaL=this.m_symbol.m_db[0].m_master;
        karmaR=this.m_symbol.m_db[1].m_master;
        if(karmaL=='' | karmaR=='') {
            print('Error! [eq] doesn\'t have sbj | obj.');
            print('Sbj:',karmaL);
            print('Obj:',karmaR);
            return 'red';
        }
        if(karmaL.m_map=='' | karmaR.m_map=='') {
            return 'green';
        }
        
        else {
            nameL=karmaL.m_map.m_name;
            nameR=karmaR.m_map.m_name;
            if(karmaL.m_map.m_name.length>1 & karmaL.m_map.m_name[0]=='[' & karmaL.m_map.m_name[karmaL.m_map.m_name.length-1]==']') {
                nameL=karmaL.m_map.m_name.slice(1,karmaL.m_map.m_name.length-1);
            }
            if(karmaR.m_map.m_name.length>1 & karmaR.m_map.m_name[0]=='[' & karmaR.m_map.m_name[karmaR.m_map.m_name.length-1]==']') {
                nameR=karmaR.m_map.m_name.slice(1,karmaR.m_map.m_name.length-1);
            }
            if(nameL==nameR) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
    }


    stateSelf_is() {
        var karmaL,karmaR;
        if(this.m_map=='') {
            return 'yellow';
        }
        if(this.m_symbol.m_db[0]=='' | this.m_symbol.m_db[1]=='') {
            return 'red';
        }
        karmaL=this.m_symbol.m_db[0].m_master;
        karmaR=this.m_symbol.m_db[1].m_master;
        if(karmaL.m_map=='' | karmaR.m_map=='') {
            return 'green';
        }
        
        else {
            if(karmaL.m_map==karmaR.m_map) {
                return 'green';
            }
            
            else {
                return 'red';
            }
        }
    }



    stateRelation() {
        if(this.m_map=='' | this.m_symbol=='') {
            return true;
        }
        var cause=this.m_cause;
        
        while(cause!='') {
            if(cause.m_symbol==this.m_symbol.m_db[0]) {
                if(cause.m_map!=this.m_map.m_db[0]) {
                    return false;
                }
            }
            if(cause.m_symbol==this.m_symbol.m_db[1]) {
                if(cause.m_map!=this.m_map.m_db[1]) {
                    return false;
                }
            }

// For a function point, you should check the relation between the point through the function point selfstate()
            if(cause.m_symbol.m_db[0]==this.m_symbol) {
                if(cause.m_map.m_db[0]!=this.m_map | cause.stateSelf()=='red') {
                    return false;
                }
            }
            if(cause.m_symbol.m_db[1]==this.m_symbol) {
                if(cause.m_map.m_db[1]!=this.m_map | cause.stateSelf()=='red') {
                    return false;
                }
            }
            cause=cause.m_cause;
        }
        return true;
    }

/*
newMap存档:...
Reason_oneStep
delete
list_have
info_cause
setRangers
*/


    mapListFromRange() {
        var list_map=[];
        if(this.m_rangType==true) {
            if(this.m_ranger.m_map=='') {
                list_map=[];
            }
            
            else {
                list_map=[...this.m_ranger.m_map.m_con];
            }
        }
        
        else if(this.m_ranger.m_symbol.m_db[0]==this.m_symbol) {
            if(this.m_ranger.m_map.m_db[0]=='') {
                list_map=[];
            }
            
            else {
                list_map=[this.m_ranger.m_map.m_db[0]];
            }
        }
        
        else if(this.m_ranger.m_symbol.m_db[1]==this.m_symbol) {
            if(this.m_ranger.m_map.m_db[1]=='') {
                list_map=[];
            }
            
            else {
                list_map=[this.m_ranger.m_map.m_db[1]];
            }
        }
        
        else {
            print('Warning! Undefined situation.');
        }
        return list_map;
    }


    mapListFromPool_normal(pool) {
        var list_map=[];
        var name=this.m_symbol.m_name;

        if(name.length>0 & (name[0]=='_' | name[0]=='~')) {
            list_have=dictToList(pool);
            list_map=[];
            
            for(var i=0;i<list_have.length;i++) {
                var point=list_have[i];
                if(point.m_needed=='' | (point.m_needed!='' & point.m_creator!='')) {
                    list_map.push(point);
                }
            }
        }
        
        else {
// print(undefined===[])
            list_map=pool[this.m_symbol.m_name];
            if(list_map===undefined) {
                list_map=[];
            }
        }
        return list_map;
    }
    

    mapList_is(ranger,pool) {
        if(ranger.m_symbol.m_db[0]=='' | ranger.m_symbol.m_db[1]=='') {
            return this.mapListFromPool_normal(pool);
        }
        if(ranger.m_symbol.m_db[0]==this.m_symbol & ranger.m_map.m_db[1]!='') {
            return [ranger.m_map.m_db[1]];
        }
        if(ranger.m_symbol.m_db[1]==this.m_symbol & ranger.m_map.m_db[0]!='') {
            return [ranger.m_map.m_db[0]];
        }
        return this.mapListFromPool_normal(pool);
    }

    allCauses() {
        var cause=this;
        var list_km=[];
        
        while(cause.m_cause!='') {
            cause=cause.m_cause;
            list_km.push(cause);
        }
        return list_km;
    }

    mapList_that(ranger) {
        var list_cause=ranger.allCauses();
        var list_map=[];
        
        for(var i=0;i<list_cause.length;i++) {
            var cause=list_cause[i];
            var pt_map=cause.m_map;
            if(pt_map!='' & !list_map.includes(pt_map)) {
                list_map.push(pt_map);
            }
        }
        return list_map;
    }

    //rangeList(pool,areaType,list_new) {
    rangeList(pool,list_new) {
        var list_map=[];

        if(this.m_listMP!=='') {
            return this.m_listMP;
        }
        
        else if(this.m_ranger!='') {
            var ranger=this.m_ranger;
            var nameR=this.m_ranger.m_symbol.m_name;
            if(nameR=='[is]') {
                list_map=this.mapList_is(this.m_ranger,pool);
            }
            
            else if(nameR=='[那]') {
                list_map=this.mapList_that(this.m_ranger);
            }
            
            else if(this.m_ranger.isType('非回答新建') &  this.m_symbol.m_con.includes(this.m_ranger.m_symbol)) {
                list_map=this.mapListFromPool_normal(pool);
            }
            
            else {
                list_map=this.mapListFromRange();
            }
        }
        
        else {
            list_map=this.mapListFromPool_normal(pool);
        }
        this.m_listMP=list_map;
        return list_map;
    }


    newMap(pool,areaType,list_new) {
    //newMap(list_map,areaType,list_new) {
        var list_map=this.rangeList(pool,list_new);

        // var list_map=[];
        var name;
        if(this.m_buildMode==false | areaType==false) {
            name=this.m_symbol.m_name;
            if(this.isPreDefined()) {
                if(this.m_map=='') {
                    point=new NetP(name,this.m_symbol.m_text);
                    point.m_needed=this;
                    point.m_creator=this;
                    this.map(point);
                }
                
                else {
                    this.m_map.delete();
                    delete this.m_map;
                    this.map('');
                }
                return;
            }
            
            else if(this.isFunctionPoint()==2) {
                if(this.m_map=='') {
                    point=new NetP(name,this.m_symbol.m_text);
                    point.m_needed=this;
                    this.map(point);
                }
                
                else {
                    this.map(this.m_map);
                }
                this.m_interp=true;
                return;
            }
            var list_have=list_map;
            var mp=this.m_map;
            this.map(this.nextInlist(mp,list_have));
            return;
        }
        
        else {
            name=this.m_symbol.m_name;
            if(name!='' & (name[0]!='[' | name[name.length-1]!=']')) {
                if(this.m_map!='') {
                    this.m_map.m_creator='';
                    if(this.m_map.m_needed=='') {
                        this.m_map.delete();
                        this.map('');
                        return;
                    }
                    
                    else {
                        this.m_map.m_name='['+this.m_map.m_name+']';
                    }
                }
                var list_need=[];
                
                for(var i=0;i<list_map.length;i++) {
                    var point=list_map[i];
                    if(point.m_creator=='' & point.m_needed!='') {
                        list_need.push(point);
                    }
                }

                point=this.m_map;
                this.map(this.nextInlist(point,list_need));
                if(this.m_map=='') {
                    if(this.m_restricted==true) {
                        this.map('');
                        return;
                    }
                    point=new NetP(this.m_symbol.m_name,this.m_symbol.m_text);
                    point.m_building=true;
                    this.map(point);
                }
                
                else {
                    this.m_map.m_building=true;
                    this.m_map.m_name=this.m_map.m_name.slice(1,this.m_map.m_name.length-1);
                }
                this.m_map.m_creator=this;
                return;
            }
            else {
                if(this.m_map=='') {
                    point=new NetP(name,this.m_symbol.m_text);
                    point.m_building=true;
                    point.m_needed=this;
                    this.map(point);
                    return;
                } else {
                    this.m_map.m_needed='';
                    this.m_map.delete();
                    this.map('');
                    return;
                }
            }
        } 

        this.map('');
    }
/*
+[J函数](,JS版本)
*/

    nextInlist(point,list_pt) {
        var i;
        if(list_pt.length==0) {
            return '';
        }
        if(point=='') {
            return list_pt[0];
        }
        
        try {
            i=list_pt.lastIndexOf(point);
        } catch(e) {
            return '';
        }

        if(i+1>=list_pt.length) {
            return '';
        }
        else {
            return list_pt[i+1];
        }
    }

/*
+[J函数](,JS版本)
*/

    map(point) {
        var cause;
        this.clearAll();
        this.m_map=point;
        if(this.m_map!='') {
            cause=this.m_cause;
            
            while(cause!='') {
                if(cause.needBuildRelation()) {
                    if(cause.m_map.m_needed=='' | cause.m_map.m_needed==cause) {
                        if(cause.m_symbol.m_db[0]==this.m_symbol) {
                            cause.m_map.connect(this.m_map,0);
                        }
                        if(cause.m_symbol.m_db[1]==this.m_symbol) {
                            cause.m_map.connect(this.m_map,1);
                        }
                    }
                }
                if(this.needBuildRelation()) {
                    if(this.m_map.m_needed=='' | this.m_map.m_needed==this) {
                        if(this.m_symbol.m_db[0]==cause.m_symbol) {
                            this.m_map.connect(cause.m_map,0);
                        }
                        if(this.m_symbol.m_db[1]==cause.m_symbol) {
                            this.m_map.connect(cause.m_map,1);
                        }
                    }
                }
                cause=cause.m_cause;
            }
        }
    }

/*
+[J函数](,JS版本)
info(
*/

    clearAll() {
        this.m_map='';
        this.m_stage=0;
        this.m_interp=false;
        this.m_reState='';
        this.m_choose=true;
        this.m_eoi=0;
        if(this.m_restricted==false) {
            delete this.m_listMP;
            this.m_listMP='';
        }
        
        for(var i=0;i<this.m_clause.length;i++) {
            var clause=this.m_clause[i];
            clause.clearAll();
        }
        
        for(var i=0;i<this.m_noe.length;i++) {
            var end=this.m_noe[i];
            end.clearAll();
        }
        
        for(var i=0;i<this.m_yese.length;i++) {
            var end=this.m_yese[i];
            end.clearAll();
        }
    }


    needBuildRelation() {
        if(this.buildingNewMap()) {
            return true;
        }
        
        else if(this.isFunctionPoint()!=0) {
            return true;
        }
        return false;
    }



    buildingNewMap() {
        if(this.m_map=='') {
            return false;
        }
        
        else if(this.m_buildMode==false) {
            return false;
        }
        
        else {
            if(this.m_map.m_needed=='') {
                return true;
            }
        }
        return false;
    }



    isFunctionPoint() {
        if(this.m_symbol.m_name=='') {
            return 0;
        }
        
        else if(this.m_symbol.m_name=='[eq]' | this.m_symbol.m_name=='[同名]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name=='[is]' | this.m_symbol.m_name=='[是]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name=='[那]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name=='[]') {
            return 1;
        }
        
        else if(this.m_symbol.m_name[0]=='[' & this.m_symbol.m_name[this.m_symbol.m_name.length-1]==']') {
            return 2;
        }
        return 0;
    }

/*
list_have
*/

    isPreDefined() {
        var name=this.m_symbol.m_name;
        if(name=='[is]' | name=='[eq]' | name=='[那]' | name=='[]') {
            return true;
        }
        
        else {
            return false;
        }
    }


    areaType() {
        return 0;
    }

/*
+[J函数](,JS版本)
length
newMap
*/

    Reason_oneStep(pool) {
        var list_new=[];
        // var areaType=areaType.concat(this.areaType());
        var areaType=true;
        var change=false;
        var keep=true;

        if(this.m_stage==0) {
            if(this.m_cause!='') {
                if(this.m_cause.m_clause.includes(this)) {
                    if(this.m_cause.m_stage==2) {
                        this.m_stage=1;
                        change=true;
                    }
                }
            }
        }

        if(this.m_stage==1) {
            
            while(true) {
                if(this.stateSelf()!='blue') {
                    this.newMap(pool,areaType,list_new);
                }
                
                else {
                    this.m_interp=false;
                }
                change=true;
                if(this.stateRelation()==false) {
                    continue;
                }
                
                else if(this.stateSelf()=='red') {
                    continue;
                }
                
                else if(this.stateSelf()=='yellow') {
                    this.m_stage=5;
                    if(this.m_no==false) {
                        this.m_reState='dark yellow';
                        return [change,list_new];
                    }
                    
                    else {
                        this.m_reState='dark green';
                        return [change,list_new];
                    }
                }
                
                else if(this.stateSelf()=='blue') {
                    this.m_stage=1;
                    return [change,list_new];
                }
                
                else {
                    this.m_stage=2;
                    break;
                }
            }
        }

        if(this.m_stage==2) {

            if(this.m_clause.length==0) {
                this.m_choose=true;
                this.m_stage=3;
                change=true;
            }
            
            else {
                this.m_choose=this.m_clauseAnd;
                keep=false;
            }

            
            for(var i=0;i<this.m_clause.length;i++) {
                var clause=this.m_clause[i];
                if(this.m_clauseAnd==true) {
                    if(clause.m_reState=='dark yellow') {
                        this.m_choose=false;
                        this.m_stage=3;
                        change=true;
                        this.m_clauseOut=true;
                        break;
                    }
                    
                    else if(clause.m_reState=='') {
                        keep=true;
                    }
                }
                
                else {
                    if(clause.m_reState=='dark green') {
                        this.m_choose=true;
                        this.m_stage=3;
                        change=true;
                        this.m_clauseOut=true;
                        break;
                    }
                    
                    else if(clause.m_reState=='') {
                        keep=true;
                    }
                }
            }

            if(this.m_clause.length!=0 & keep==false) {
                this.m_stage=3;
                change=true;
                this.m_clauseOut=true;
            }
        }


        if(this.m_stage==3) {
            if(this.m_choose==false) {
                if(this.m_noe.length==0) {
                    this.m_stage=1;
                    change=true;
                    return [change,list_new];
                }
                i=this.m_eoi;
                var end=this.m_noe[i];
                if(end.m_stage==0) {
                    end.m_stage=1;
                    change=true;
                }
                
                else if(end.m_reState=='dark yellow') {
                    if(this.m_noAnd==true) {
                        this.m_stage=1;
                        change=true;
                    }
                    
                    else {
                        i+=1;
                        change=true;
                        if(i==this.m_noe.length) {
                            this.m_stage=1;
                            this.m_eoi=0;
                        }
                        
                        else {
                            this.m_eoi=i;
                        }
                    }
                }
                
                else if(end.m_reState=='dark green') {
                    if(this.m_noAnd!=true) {
                        this.m_stage=4;
                        change=true;
                    }
                    
                    else {
                        i+=1;
                        change=true;
                        if(i==this.m_noe.length) {
                            this.m_stage=4;
                            this.m_eoi=0;
                        }
                        
                        else {
                            this.m_eoi=i;
                        }
                    }
                }
            }
            
            else {
                if(this.m_yese.length==0 & this.m_noe.length==0) {
                    this.m_stage=4;
                    change=true;
                }
                
                else if(this.m_yese.length==0) {
                    this.m_stage=1;
                    change=true;
                    return [change,list_new];
                }
                
                else {
                    i=this.m_eoi;
                    end=this.m_yese[i];
                    if(end.m_stage==0) {
                        end.m_stage=1;
                        change=true;
                    }
                    
                    else if(end.m_reState=='dark yellow') {
                        if(this.m_yesAnd==true) {
                            this.m_stage=1;
                            change=true;
                        }
                        
                        else {
                            i+=1;
                            change=true;
                            if(i==this.m_yese.length) {
                                this.m_stage=1;
                                this.m_eoi=0;
                            }
                            
                            else {
                                this.m_eoi=i;
                            }
                        }
                    }
                    
                    else if(end.m_reState=='dark green') {
                        if(this.m_yesAnd!=true) {
                            this.m_stage=4;
                            change=true;
                        }
                        
                        else {
                            i+=1;
                            change=true;
                            if(i==this.m_yese.length) {
                                this.m_stage=4;
                                this.m_eoi=0;
                            }
                            
                            else {
                                this.m_eoi=i;
                            }
                        }
                    }
                }
            }
        }


        if(this.m_stage==4) {
            if(this.m_clauseNew.length!=0 | this.m_clauseOut==true) {
                this.m_clauseCollect=true;
            }
            if((this.m_buildMode==true | this.isFunctionPoint()==1) & this.m_map!='' & !list_new.includes(this.m_map)) {
                list_new.push(this.m_map);
            }
            this.m_stage=5;
            if(this.m_no==true) {
                this.m_reState='dark yellow';
                change=true;
                return [change,list_new];
            }
            
            else {
                this.m_reState='dark green';
                change=true;
                return [change,list_new];
            }
        }
        return [change,list_new];
    }

    isVirtual() {
        var name=this.m_symbol.m_name;
        if(name.length>1 & name[0]=='[' & name[name.length-1]==']') {
            return true;
        }
        
        else {
            return false;
        }
    }


    isSpecialRanger() {
        var name=this.m_symbol.m_name;
        if(name=='[is]' | name=='[那]') {
            return true;
        }
        return false;
    }

    isType(str_type) {
        var name=this.m_symbol.m_name;
        if(infoInStr('引用',str_type)) {
            if(!this.isVirtual() | this.m_buildMode==true) {
                return false;
            }
        }
        if(infoInStr('新建',str_type)) {
            if(infoInStr('非新建',str_type)) {
                if(this.m_buildMode==true) {
                    return false;
                }
            }
            
            else if(this.m_buildMode==false) {
                return false;
            }
        }
        if(infoInStr('动作',str_type)) {
            if(!this.isVirtual() | this.m_buildMode==false) {
                return false;
            }
        }
        if(infoInStr('内置',str_type)) {
            if(!this.isPreDefined()) {
                return false;
            }
        }
        if(infoInStr('特殊范围',str_type)) {
            if(!this.isSpecialRanger()) {
                return false;
            }
        }
        if(infoInStr('否定',str_type)) {
            if(name=='' | name[0]!='~') {
                return false;
            }
        }
        if(infoInStr('通用',str_type)) {
            if(name=='' | name[0]!='_') {
                return false;
            }
        }
        if(infoInStr('普通',str_type)) {
            if(this.isVirtual()) {
                return false;
            }
        }
        if(infoInStr('端点',str_type)) {
            if(infoInStr('非端点',str_type)) {
                if(this.m_ranger=='') {
                    return false;
                }
            }
            
            else if(this.m_ranger!='') {
                return false;
            }
        }
        if(infoInStr('回答',str_type)) {
            var an_type=true;
            if(this.m_map=='' | this.m_map.m_needed==this | this.m_map.m_needed=='') {
                an_type=false;
            }
            if(infoInStr('非回答',str_type)) {
                if(an_type) {
                    return false;
                }
            }
            
            else if(!an_type) {
                return false;
            }
        }
        if(infoInStr('限制',str_type)) {
            if(this.m_restricted==false) {
                return false;
            }
        }
        return true;
    }


    setRangers(causes='') {
        var connecting='';
        var connected='';
        var caseNo=100;
        if(causes=='') {
            causes=[];
        }
        
        else if(this.isType('非新建普通链节')) {
            
            for(var i=0;i<causes.length;i++) {
                var cause=causes[i];
                if(cause.m_symbol.m_db[0]==this.m_symbol | cause.m_symbol.m_db[1]==this.m_symbol) {
                    if(cause.isType('特殊范围')) {
                        connected=cause;
                        break;
                    }
                    
                    else if(cause.isType('普通非新建') & caseNo>3) {
                        connected=cause;
                        caseNo=3;
                    }
                    
                    else if(cause.isType('新建') & caseNo>5) {
                        connected=cause;
                        caseNo=5;
                    }
                }
                
                else if(this.m_symbol.m_db[0]==cause.m_symbol | this.m_symbol.m_db[1]==cause.m_symbol) {
                    if(cause.isType('引用') & caseNo>2) {
                        connecting=cause;
                        caseNo=2;
                    }
                    
                    else if(cause.isType('普通非新建') & caseNo>4) {
                        connecting=cause;
                        caseNo=4;
                    }
                    
                    else if(cause.isType('新建') & caseNo>6) {
                        connecting=cause;
                        caseNo=6;
                    }
                }
            }
            if(connected!='') {
                this.m_ranger=connected;
            }
            
            else if(connecting!='') {
                this.m_ranger=connecting;
                this.m_rangType=true;
            }
        }
        causes=[...causes,this];
        
        for(var i=0;i<this.m_clause.length;i++) {
            var con=this.m_clause[i];
            con.setRangers(causes);
        }
        
        for(var i=0;i<this.m_yese.length;i++) {
            var end=this.m_yese[i];
            end.setRangers(causes);
        }
        
        for(var i=0;i<this.m_noe.length;i++) {
            var end=this.m_noe[i];
            end.setRangers(causes);
        }
    }

    allEffects() {
        var list_effects=[this];
        
        for(var i=0;i<this.m_clause.length;i++) {
            var karma=this.m_clause[i];
            list_effects=list_effects.concat(karma.allEffects());
        }
        
        for(var i=0;i<this.m_noe.length;i++) {
            var karma=this.m_noe[i];
            list_effects=list_effects.concat(karma.allEffects());
        }
        
        for(var i=0;i<this.m_yese.length;i++) {
            var karma=this.m_yese[i];
            list_effects=list_effects.concat(karma.allEffects());
        }
        return list_effects;
    }


    causeEnd() {
        var cause=this;
        
        while(cause.m_cause!='') {
            cause=cause.m_cause;
        }
        return cause;
    }


    info() {
        var map,str_info;
        if(this.m_map!='') {
            map=this.m_map.info();
        }
        else {
            map='(None)';
        }
        var map_info,name_info;
        
        if(this.m_reState=='dark green') {
            name_info=`<span style="background-color:green;color:white;">${this.m_symbol.info()}</span>`;
        }
        else if(this.m_reState=='dark yellow') {
            name_info=`<span style="background-color:yellow;color:black;">${this.m_symbol.info()}</span>`;
        }
        else {
            name_info=`<span>${this.m_symbol.info()}</span>`;
        }
        
        if(this.stateSelf()=='yellow') {
            map_info=`<span style="background-color:${this.stateSelf()};">${map}</span>`;
        }
        else {
            map_info=`<span style="background-color:${this.stateSelf()};color:white;">${map}</span>`;
        }
        
        str_info=`${name_info}:${map_info},stage(${this.m_stage})`;
        return str_info;
    }


}


function infoInStr(string,str_info) {
    a=str_info.includes(string);
    return a;
}


function dictToList(dict_pt) {
    var list_pt=[];
    
    for(var i=0;i<dict_pt.length;i++) {
        var term=dict_pt[i];
        list_pt=[...list_pt,dict_pt[term]];
    }
    return list_pt;
}




/*
oneStep

stateRelation
setRangers
nextInlist
concat
测试(J函数):...
+[新建阅读窗口](,测试)
*/
/*
+[J函数](,JS版本)

测试:...
测试list:...
+[新建阅读窗口](,测试)
Object

保存:...
+[新建阅读窗口](,保存)
setRange
readSubCode_tokener
buildPoints_tokener
removeComment
catch
*/



function writeStdCode_karma(karma,list_pt) {
    var karma_code='',text='';

    if(karma=='') {
        return [karma_code,list_pt];
    }
    if(!list_pt.includes(karma.m_symbol)) {
        list_pt.push(karma.m_symbol);
    }
    if(karma.m_buildMode==true) {
        karma_code+='+';
    }
    // var n=list_pt.indexOf(karma.m_symbol);
    // karma_code+=(list_pt.indexOf(karma.m_symbol)).toString();
    karma_code+=karma.m_symbol.info();
    if(karma.m_clause.length!=0) {
        if(karma.m_clauseAnd==false) {
            karma_code+='|';
        }
        karma_code+='{';
        
        for(var i=0;i<karma.m_clause.length;i++) {
            var clause=karma.m_clause[i];
            [text,list_pt]=writeStdCode_karma(clause,list_pt);
            karma_code+=text;
            if(clause!=karma.m_clause[karma.m_clause.length-1]) {
                karma_code+=',';
            }
        }
        karma_code+='}';
    }
    if(karma.m_yese.length+karma.m_noe.length>1) {
        if(karma.m_yesAnd==true) {
            karma_code+='&';
        }
        karma_code+=':';
    }
    
    for(var i=0;i<karma.m_yese.length;i++) {
        var end=karma.m_yese[i];
        if(end.m_no==false) {
            karma_code+='->';
        }
        
        else {
            karma_code+='=>';
        }
        [text,list_pt]=writeStdCode_karma(end,list_pt);
        karma_code+=text;
        if(end!=karma.m_yese[karma.m_yese.length-1]) {
            karma_code+=',';
        }
    }
    
    for(var i=0;i<karma.m_noe.length;i++) {
        var end=karma.m_noe[i];
        if (karma.m_yese.length!=0) {
            karma_code+=',';
        }
        if(end.m_no==false) {
            karma_code+='->>';
        }
        
        else {
            karma_code+='=>>';
        }
        [text,list_pt]=writeStdCode_karma(end,list_pt);
        karma_code+=text;
        if(end!=karma.m_noe[karma.m_noe.length-1]) {
            karma_code+=',';
        }
    }
    if(karma.m_yese.length+karma.m_noe.length>1) {
        karma_code+=';';
    }
    return [karma_code,list_pt];
}

/*
do
保存NetPStack:...
*/

class NetPStack {
    
    constructor() {
        this.m_builtStack=[{}];
        this.m_undefinedStack=[{}];
    }

    info() {
        var info='',info_stack='';
        
        info+='Built: ';
        for(var i in this.m_builtStack) {
            info_stack=''
            for(var key in this.m_builtStack[i]) {
                info_stack+=`${key}:${this.m_builtStack[i][key].info()},`;
            }
            info+=`{${info_stack}},`;
        }
        
        info+='<br>Undefined: ';
        for(var i in this.m_undefinedStack) {
            info_stack=''
            for(var key in this.m_undefinedStack[i]) {
                info_stack+=`${key}:${this.m_undefinedStack[i][key].info()},`;
            }
            info+=`{${info_stack}},`;
        }
        info+=`<br>`;
        return info;
    
    }

    popBuilt() {
        return this.m_builtStack.pop();
    }
    
    popUndefined() {
        return this.m_undefinedStack.pop();
    }
    
    pushBuilt(built) {
        this.m_builtStack.push(built);
    }
    
    pushUndefined(undefined_pt) {
        this.m_undefinedStack.push(undefined_pt);
    }
    
    enterClause() {
        var copy0={},copy1={};

        Object.assign(copy0,this.m_builtStack[this.m_builtStack.length-1]);
        this.m_builtStack.push(copy0);

        Object.assign(this.m_undefinedStack[this.m_undefinedStack.length-1],copy1);
        this.m_undefinedStack.push(copy1);
    }


    insertPtIntotKarma_back(km0,netP) {
        var km_new=new Karma(netP),km;
        if(netP.m_name.length>1 & netP.m_name[0]=='+') {
            netP.m_name=netP.m_name.slice(1,netP.m_name.length);
            km_new.m_buildMode=true;
        }
        
        for(var i=0;i<km0.m_clause.length;i++) {
            km=km0.m_clause[i];
            km.m_cause=km_new;
        }
        
        for(var i=0;i<km0.m_yese.length;i++) {
            km=km0.m_yese[i];
            km.m_cause=km_new;
        }
        
        for(var i=0;i<km0.m_noe.length;i++) {
            km=km0.m_noe[i];
            km.m_cause=km_new;
        }
        km_new.m_clause=km0.m_clause;
        km_new.m_yese=km0.m_yese;
        km_new.m_noe=km0.m_noe;
        km0.m_yese=[km_new];
        km0.m_noe=[];
        km_new.m_cause=km0;
    }
    

    insertPtIntotKarma_front(km0,netP) {
        var i;
        var km_new=new Karma(netP);
        if(netP.m_name.length>1 & netP.m_name[0]=='+') {
            netP.m_name=netP.m_name.slice(1,netP.m_name.length);
            km_new.m_buildMode=true;
        }
        if(km0.m_cause!='') {
            var cause=km0.m_cause;
            km_new.m_cause=cause;
            if(cause.m_clause.includes(km0)) {
                i=cause.m_clause.indexOf(km0);
                cause.m_clause.splice(i,1);
                cause.m_clause.push(km_new);
            }
            
            else if(cause.m_yese.includes(km0)) {
                i=cause.m_yese.indexOf(km0);
                cause.m_yese.splice(i,1);
                cause.m_yese.push(km_new);
            }
            
            else if(cause.m_noe.includes(km0)) {
                i=cause.m_noe.indexOf(km0);
                cause.m_noe.splice(i,1);
                cause.m_noe.push(km_new);
            }
            
            else {
                print("Warning! The karma:"+km0.m_symbol.info()+", has a weird cause karma.");
            }
        }
        km0.m_cause=km_new;
        km_new.m_yese=[km0];
        if(km0.m_no==true) {
            km0.m_no=false;
            km_new.m_no=true;
        }
    }


    insertPtIntotKarma(km0,netP) {
        var otherP;
        if(km0.m_symbol.m_db[0]==netP) {
            otherP=km0.m_symbol.m_db[1];
        }
        
        else if(km0.m_symbol.m_db[1]==netP) {
            otherP=km0.m_symbol.m_db[0];
        }
        
        else {
            return;
        }

        if(km0.isType('新建') | km0.m_symbol.m_name=='[那]') {
            this.insertPtIntotKarma_back(km0,netP);
        }
        
        else if(km0.isType('普通非新建') | km0.m_symbol.m_name=='[is]') {
            if(otherP=='' | otherP.m_master=='') {
                this.insertPtIntotKarma_back(km0,netP);
            }
            
            else if(km0.allCauses().includes(otherP.m_master)) {
                this.insertPtIntotKarma_back(km0,netP);
            }
            
            else {
                this.insertPtIntotKarma_front(km0,netP);
            }
        }
        else if(km0.isType('引用')) {
        //else {
            this.insertPtIntotKarma_front(km0,netP);
        }
    }



    leaveClause() {
        var dict_len=0,dict_undef={};
        var dict_len2=0,dict_undef2={};
        var pt,km_head;
        if(this.m_undefinedStack.length==1) {
            dict_undef=this.m_undefinedStack[this.m_undefinedStack.length-1];
            dict_len=Object.keys(dict_undef).length;
            if(dict_len!=0) {
                for(var term in dict_undef) {
                    pt=dict_undef[term];
                    if(pt.m_master=='') {
                        km_head=pt.m_con[0].m_master;
                        this.insertPtIntotKarma(km_head,pt);
                    }
                }
            }
        }
        
        else {
            dict_undef=this.m_undefinedStack[this.m_undefinedStack.length-1];
            dict_len=Object.keys(dict_undef).length;

            dict_undef2=this.m_undefinedStack[this.m_undefinedStack.length-2];
            dict_len2=Object.keys(dict_undef2).length;

            if(dict_len>dict_len2) {
                for(var term in dict_undef) {
                    if(dict_undef2[term]==undefined) {
                        pt=dict_undef[term];
                        if(pt.m_master=='') {
                            km_head=pt.m_con[0].m_master;
                            this.insertPtIntotKarma(km_head,pt);
                        }
                    }
                }
            }
        }

        this.m_builtStack.pop();
        this.m_undefinedStack.pop();
    }
    
    popUndefinedName(name) {
        
        for(var i=0;i<this.m_undefinedStack.length;i++) {
            var stack=this.m_undefinedStack[i];
            delete stack[name];
        }
    }
    
    buildNetP(name,con0_name='',con1_name='') {
        var recent=this.m_builtStack[this.m_builtStack.length-1];
        var undefined_pt=this.m_undefinedStack[this.m_undefinedStack.length-1];
        var point=undefined_pt[name];
        if(point==undefined) {
            var name0=name;
            point=new NetP(name.replace(/#.*$/,''));
            recent[name0]=point;
        }
        
        else {
            delete undefined_pt[name];
        }
        if(con1_name!='') {
            var con1=recent[con1_name];
            if(con1==undefined) {
                var con1_name0=con1_name;
                con1=new NetP(con1_name.replace(/#.*$/,''));
                recent[con1_name0]=con1;
                undefined_pt[con1_name0]=con1;
            }
            point.connect(con1,1);
        }
        if(con0_name!='') {
            var con0=recent[con0_name];
            if(con0==undefined) {
                var con0_name0=con0_name;
                con0=new NetP(con0_name.replace(/#.*$/,''));
                recent[con0_name0]=con0;
                undefined_pt[con0_name]=con0;
            }
            point.connect(con0,0);
        }
        return point;
    }




}



class Parser {

    readSubCode_tokener(code) {
        var list_karma=[];
        var karma,pointStack;
        var result=true;
        
        while(code!='') {
            code=code.replace(/^[ \t\n]+/,'');
            if(code=='') {
                break;
            }

            [code,result]=this.removeComment(code);
            if(result==true) {
                continue;
            }
            
            else {
                [code,karma,pointStack]=this.chainToken(code);
                pointStack.leaveClause();
                karma=karma.causeEnd();
                karma.setRangers();
                list_karma.push(karma);
                if(code!='' & code[0]==';') {
                    code=code.slice(1,code.length);
                }
            }
        }
        return list_karma;
    }

/*
buildNetP
*/

    buildPoints_tokener(code) {
        code=code.replace(/^[ \t\n\r]*/,'');

        var list_pt=[],netP;
        var pointStack=new NetPStack();

        while(code!='') {
            [code,netP,pointStack]=this.netPToken(code,pointStack);
            list_pt.push(netP);
            code=code.replace(/^\[-?\d+,-?\d+\]/,'');
            code=code.replace(/^[ \t\n\r;]*/,'');

        }
        return list_pt;
    }


    removeComment(code) {
        if(code.length==0) {
            return [code,false];
        }
        
        else if(code[0]=='#') {
            code=code.replace(/^#.*/,'');
        }
        
        else if(code.slice(0,3)=='"""') {
            code=code.slice(3,code.length);
            
            while(true) {
                if(code.length<3) {
                    code='';
                    break;
                }
                
                else if(code.slice(0,3)=='"""') {
                    break;
                }
                
                else {
                    code=code.replace(/^.*\n?/,'');
                }
            }
            code=code.slice(3,code.length);
        }
        
        else {
            return [code,false];
        }
        return [code,true];
    }


    chainToken(code,pointStack='') {
        var karma;
        if(pointStack=='') {
            pointStack=new NetPStack();
        }
        [code,karma,pointStack]=this.karmaToken(code,pointStack);
        if(code=='' | code[0]==';' | code[0]=='\n' | code[0]=='}') {
            return [code,karma,pointStack];
        }
        
        else if(code[0]==',') {
            return [code,karma,pointStack];
        }
        
        else if(code[0]==':') {
            code=code.slice(1,code.length);
            [code,karma,pointStack]=this.splitToken(code,karma,pointStack);
        }
        
        else if(code[0]=='|' | code[0]=='&') {
            var typeSub=code[0];
            code=code.slice(1,code.length);
            if(code!='' & code[0]==':') {
                if(typeSub=='|') {
                    karma.m_noAnd=false;
                    karma.m_yesAnd=false;
                }
                
                else {
                    karma.m_noAnd=true;
                    karma.m_yesAnd=true;
                }
                code=code.slice(1,code.length);
                [code,karma,pointStack]=this.splitToken(code,karma,pointStack);
            }
        }
        
        else {
            var typeCon,effect;
            [code,typeCon]=this.conToken(code);
            [code,effect,pointStack]=this.chainToken(code,pointStack);
            this.buildRelation(karma,typeCon,effect);
        }
        return [code,karma,pointStack];
    }


    conToken(code) {
        var typeCon;
        while(code.length>3 & code.slice(0,3)=='...') {
            code=code.replace(/^\.\.\..*[\n\t ]*/,'');
        }
        code=code.replace(/^[ \t]*/,'');
        if(code.length>2 & code.slice(0,3)=='->>') {
            typeCon=code.slice(0,3);
            code=code.slice(3,code.length);
        }
        
        else if(code.length>2 & code.slice(0,3)=='=>>') {
            typeCon=code.slice(0,3);
            code=code.slice(3,code.length);
        }
        
        else if(code.length>1 & code.slice(0,2)=='->') {
            typeCon=code.slice(0,2);
            code=code.slice(2,code.length);
        }
        
        else if(code.length>1 & code.slice(0,2)=='=>') {
            typeCon=code.slice(0,2);
            code=code.slice(2,code.length);
        }
        
        else {
            print('\n\n\nIllegal connection symbol!\nCode:',code);
            throw 'Illegal connection symbol!';
        }
        code=code.replace(/^[ \t]*/,'');
        return [code,typeCon];
    }


    clauseToken(code,karma,pointStack) {
        pointStack.enterClause();
        var clause;

        while(true) {
            code=code.replace(/^[ \t\n]*/,'');
            if(code=='') {
                throw 'Error! Unbalanced bracket!';
            }
            
            else if(code[0]=='}') {
                break;
            }
            
            else {
                [code,clause,pointStack]=this.chainToken(code,pointStack);
                karma.m_clause.push(clause);
                clause.m_cause=karma;
                if(code!='' & code[0]!=',') {
                    break;
                }
                
                else if(code!='') {
                    code=code.slice(1,code.length);
                }
            }
        }
        pointStack.leaveClause();
        return [code,karma,pointStack];
    }


    splitToken(code,karma,pointStack) {
        var typeCon,effect;

        while(true) {
            code=code.replace(/^[ \t\n]*/,'');
            [code,typeCon]=this.conToken(code);
            [code,effect,pointStack]=this.chainToken(code,pointStack);
            this.buildRelation(karma,typeCon,effect);
            code=code.replace(/^[ \t\n]*/,'');
            if(code=='' | code[0]==';' | code[0]=='}') {
                break;
            }
            
            else if(code[0]!=',') {
                print('\n\n\n\nError! Ilegal splitting type!\nCode:',code);
                throw 'Error! Ilegal splitting type!';
            }
            
            else {
                code=code.slice(1,code.length);
            }
        }
        return [code,karma,pointStack];
    }



    karmaToken(code,pointStack) {
        if(code=='') {
            throw 'Error! Invalid karma detected!';
        }

        var buildType=false;
        var karma='';
        var netP;

        if(code[0]=='+') {
            buildType=true;
        }
        [code,netP,pointStack]=this.netPToken(code,pointStack);
        karma=new Karma(netP);
        if(buildType==true & netP.m_name!='+') {
            netP.m_name=netP.m_name.slice(1,netP.m_name.length);
            karma.m_buildMode=true;
        }

        if(code!='' & code[0]=='{') {
            code=code.slice(1,code.length);
            [code,karma,pointStack]=this.clauseToken(code,karma,pointStack);
            code=code.replace(/^[\n\t ]*/,'');
            if(code=='' | code[0]!='}') {
                print('\n\n\nError! Unbalanced bracket.\nCode:',code);
                throw 'Error! Unbalanced bracket.';
            }
            
            else {
                code=code.slice(1,code.length);
            }
        }

        return [code,karma,pointStack];
    }


    netPToken(code,pointStack) {
        var title=/^[\w\u3000\u3400-\u4DBF\u4E00-\u9FFF \[\]~#.+=\-^/*\\!<\']*|^\[>=?\]/;
        var name=code.match(title)[0];
        code=code.replace(title,'');
        if(name=='') {
            print('\n\n\nError! Invalid name.\nCode:',code);
            throw 'Error! Invalid name.';
        }


        if(name[name.length-1]=='=' | name[name.length-1]=='-') {
            if(code.length>0 & code[0]=='>') {
                code=name[name.length-1]+code;
                name=name.slice(0,name.length-1);
            }
        }

        var con0_name='';
        var con1_name='';
        var text='';
        if(code!='' & code[0]=='\"') {
            code=code.slice(1,code.length);
            [code,text]=this.textToken(code);
            if(code=='' | code[0]!='\"') {
                print(code);
                throw 'Error! Unbalanced quote!';
            }
            code=code.slice(1,code.length);
        }
        if(code!='' & code[0]=='(') {
            code=code.slice(1,code.length);
            con0_name=code.match(title)[0];
            code=code.replace(title,'');
            if(code=='' | code[0]!=',') {
                print(code);
                throw 'Error! Ilegal net point format. A net point must be title"text"(title,title)';
            }
            code=code.slice(1,code.length);
            con1_name=code.match(title)[0];
            code=code.replace(title,'');
            if(code=='' | code[0]!=')') {
                throw 'Error! Unbalanced bracket in a net point format!';
            }
            code=code.slice(1,code.length);
        }
        if(name=='') {
            print('Warning! There is a point without a name!');
        }
        var netP=pointStack.buildNetP(name,con0_name,con1_name);
        //var netP=new NetP(name,text);
        netP.m_text=text;
        return [code,netP,pointStack];
    }



    textToken(code) {
        var text='';
        var preEnd=true;
        
        while(true) {
            if(code=='') {
                break;
            }
            
            else if(code.length>1 & code.slice(0,2)=='\\"') {
                preEnd=false;
            }
            
            else if(code[0]=='\"' & preEnd==true) {
                break;
            }
            
            else {
                text+=code[0];
                preEnd=true;
            }
            code=code.slice(1,code.length);
        }
        return [code,text];
    }


    buildRelation(karma,typeCon,effect) {
        if(typeCon=='->') {
            karma.m_yese.push(effect);
        }
        
        else if(typeCon=='->>') {
            karma.m_noe.push(effect);
        }
        
        else if(typeCon=='=>') {
            karma.m_yese.push(effect);
            effect.m_no=true;
        }
        
        else if(typeCon=='=>>') {
            karma.m_noe.push(effect);
            effect.m_no=true;
        }
        
        else {
            throw 'Error! Ilegal connection type!';
        }
        effect.m_cause=karma;
    }

}


function info_PtList(list_pt) {
    var info_pt='';
    for(var i=0;i<list_pt.length;i++) {
        var pt=list_pt[i];
        info_pt+=pt.info()+','
    }

    return `[${info_pt}]`;
}


function info_PtPool(pool_pt) {
    var info_pt='';
    for(var key in pool_pt) {
        var list_pt=pool_pt[key];
        info_pt+=key+`: ${info_PtList(list_pt)},`;
    }

    return `{${info_pt}}`;
}

function printPtList(list_pt) {
    print(info_PtList(list_pt));
}

function printPtPool(pool_pt) {
    print(info_PtPool(pool_pt));
}


function mergeArrays(list0,list1) {
    for(var j=0;j<list1.length;j++) {
        if(!list0.includes(list1[j])) {
            list0.push(list1[j]);
        }
    }
}

/*
+[J函数](,JS版本)

保存run_code:...
*/

function run_code_line(km,list_pt) {
    var code,list_km,list_new;

    //[code,km]=parser.chainToken(code0);
    list_km=km.allEffects();
    
    list_km[0].m_stage=1;
    var change=true,change1;
    
    while(change) {
        change=false;
        for(var i=0;i<list_km.length;i++) {
            [change1,list_new]=list_km[i].Reason_oneStep(list_pt);
            karma=list_km[i];
            //print(karma.info(),list_new.length);
            mergeArrays(list_pt,list_new);
    
            if(change1 & !change) {
                change=true;
            }
        }
        //printPtList(list_pt);
        //print(change);
        //print();
    }
    return code;
}

function run_code(code0,list_pt) {
    var code1=code0;
    var parser=new Parser();
    list_km=parser.readSubCode_tokener(code0);

    for(var i in list_km) {
        run_code_line(list_km[i],list_pt);
    }

    return code0;
}



/*
chain
+[J函数](,JS版本)
测试stdCode:...
测试Parser:...
测试:...
+[J函数](,测试)
+[新建阅读窗口](,测试)
*/
/*
+[J函数](,JS版本)
do
obj.print
+[新建阅读窗口](,测试)
op
*/

function listFromPt(pt) {
    var list_pt=[];

    if(pt=='') {
        return list_pt;
    }

    for(var i=0;i<pt.m_con.length;i++) {
        if(pt.m_con[i].m_name=='的' & pt.m_con[i].m_db[1]!='' & pt.m_con[i].m_db[1]!=pt) {
            list_pt.push(pt.m_con[i].m_db[1]);
        }
    }
    return list_pt;
}


class StCore {
    constructor() {
        this.m_parser=new Parser();

        this.m_self='';
        this.m_lib='';
        this.m_idea='';
        this.m_hear='';
        this.m_speak='';
    }

/*
+[J函数](,测试)
*/

    init(code) {
        var list_pt0=this.make(code),list_pt=[];

        this.m_self=list_pt0[0];
        this.m_self.m_permission=0;
        list_pt=listFromPt(this.m_self);

        for(var i in list_pt) {
            var pt=list_pt[i];
            if(pt.m_name==='m_lib') {
                this.m_lib=pt;
                pt.m_permission=0;
            }
            else if(pt.m_name==='m_idea') {
                this.m_idea=pt;
                pt.m_permission=0;
            }
            else if(pt.m_name==='听') {
                this.m_hear=pt;
                pt.m_permission=0;
            }
            else if(pt.m_name==='说') {
                this.m_speak=pt;
                pt.m_permission=0;
            }
        }

        if(this.m_hear=='') {
            this.m_hear=new NetP('听');
            new NetP.con(this.m_self,this.m_hear);
            this.m_hear.m_permission=0;
        }
        if(this.m_speak=='') {
            this.m_speak=new NetP('说');
            new NetP.con(this.m_self,this.m_speak);
            this.m_speak.m_permission=0;
        }

        return list_pt;
    }

    do(code,pt_in='',list_global=[]) {
        var list_pt=listFromPt(pt_in)
        var list_new=[];
        var list_km=[];

        mergeArrays(list_pt,list_global);
        if(!list_pt.includes(pt_in) & pt_in!='') {
            list_pt.push(pt_in);
        }

        [code,list_km]=this.run_code(code,list_pt,list_new);
        this.operation(list_new);
        
        for(var i=0;i<list_new.length;i++) {
            var pt=list_new[i],pt_de;
            pt_de=new NetP('的');
            pt_de.con(pt_in,pt);
        }
    
        return [code,list_km];
    }

    make(code,pt_in='') {
        var list_pt=this.m_parser.buildPoints_tokener(code);
        if(pt_in==='') {
            return list_pt
        }
        for(var i in list_pt) {
            var pt=list_pt[i];
            new NetP('的').con(pt_in,pt);
        }
        return list_pt;
    }

/*
保存run_code_line:...
*/

    run_code_line(km,list_pt,list_ns) {
        var code,list_km,list_new,list_del=[];
        var karma,int_result=false;
        var pool=listPt2poolPt(list_pt);

        list_km=km.allEffects();
        
        list_km[0].m_stage=1;
        var change=true,change1;

        while(change) {
            change=false;
            for(var i=0;i<list_km.length;i++) {
                [change1,list_new]=list_km[i].Reason_oneStep(pool);
                karma=list_km[i];

//print(karma.info(),karma.m_interp);
                if(karma.m_interp) {
                    int_result=this.think(karma.m_map);
                    list_del.push(karma.m_map);
//print(int_result);
                    if(!int_result) {
                        karma.m_map='';
                    }
                }

//printPtList(karma.m_listMP)
//printPtList(list_new);
                listPtIntoPoolPt(pool,list_new);
                mergeArrays(list_pt,list_new);
                mergeArrays(list_ns,list_new);
        
                if(change1 & !change) {
                    change=true;
                }
            }
        }

        for(var i=0;i<list_del.length;i++) {
            list_del[i].delete();
        }

        return true;
    }
    
    run_code(code0,list_pt,list_ns=[]) {
        var code1=code0,list_km;
        var parser=this.m_parser;

        list_km=parser.readSubCode_tokener(code0);

        for(var i in list_km) {
            this.run_code_line(list_km[i],list_pt,list_ns);
        }

        return [code0,list_km];
    }

    act(pt_code,pt) {
        var code1=pt_code.m_text;
        var list_km=[],list_new=[],result=false;
        var parser=this.m_parser;

        list_km=parser.readSubCode_tokener(code1);
    
        list_km[0].m_listMP=[pt];
        list_km[0].m_restricted=true;

        result=this.run_code_line(list_km[0],[pt_code],list_new);
        if(result) {
            this.operation(list_new);
        }
        return result;
    }

    operation(list_pt) {
        var list_del=[];
        for(var i=list_pt.length-1;i>=0;i--) {
            var pt=list_pt[i];
            var operated=false;
            var sbj=pt.m_db[0],obj=pt.m_db[1];

            if(pt.m_name=='[del]') {
                this.opDel(pt,list_pt,list_del);
                operated=true;
            }
            else if(pt.m_name=='[左连]') {
                this.opConnect(sbj,obj,0);
                operated=true;
            }
            else if(pt.m_name=='[右连]') {
                this.opConnect(sbj,obj,1);
                operated=true;
            }

            else if(pt.m_name=='[消息窗口]') {
                this.opMsgWin(pt);
                operated=true;
            }
            else if(pt.m_name=='[修改内容]') {
                this.opWriteText(sbj,obj,pt);
                operated=true;
            }
            else if(pt.m_name=='[增加内容]') {
                this.opAddToText(sbj,obj,pt);
                operated=true;
            }
            else if(pt.m_name=='[模板文本]') {
                this.opTempText(sbj,obj,pt);
                operated=true;
            }

            else if(pt.m_name=='[做]') {
                this.opDo(pt);
                operated=true;
            }
            else if(pt.m_name=='[JS]') {
                this.opJs(obj,pt);
                operated=true;
            }

            else if(pt.m_name.length>1 & pt.m_name[0]=='[' & pt.m_name[pt.m_name.length-1]==']') {
                this.opLibDefined(pt);
                operated=true;
            }
            if(operated) {
                list_del.push(i);
            }
        }

        for(var i=0;i<list_del.length;i++) {
            var i_del=list_del[i];
            var pt_del=list_pt[i_del];
            list_pt.splice(i_del,1);
            pt_del.delete();
            //delete pt_del;
        }
    }
    
    opMsgWin(action) {
        var obj=action.m_db[1];
        var name,text;
        if(obj=='' & action.m_text=='') {
            return;
        }
        else if(obj!=='') {
            name=obj.info();
            text=obj.m_text;
        }
        else {
            name='消息';
            text=action.m_text;
        }
        alert(`${name}: ${text}`);
    }

    opDo(action) {
        var con_de='';
        for(var i in action.m_con) {
            var con=action.m_con[i];
            if(con.m_name=='[code]' | con.m_name=='code') {
                if(con.m_db[1]!='' & con.m_db[1]!=action) {
                    con_de=con.m_db[1];
                }
            }
        }
        
        action.m_name='['+con_de.m_name+']';
        this.act(con_de,action);
    }

    opJs(obj,action) {
        var code=action.m_text;
        var var_name='';
        var code_out=`\nvar outs_in_JS={`;
        var outs,outs_var={};
        
        for(var i in action.m_con) {
            var pt=action.m_con[i];
            if(pt.m_name=='code' | pt.m_name=='[code]') {
                if(pt.m_db[1]!='' & pt.m_db[1]!=action) {
                    code=pt.m_db[1].m_text;
                }
                break;
            }
        }
        
        if(obj!=='') {
            code_out+="'ans':`${ans}`,";
            outs_var['ans']=obj;
        }

        for(var i in action.m_con) {
            var pt=action.m_con[i];
            if(pt.m_name=='.' | pt.m_name=='[.]' | pt.m_name=='o' | pt.m_name=='[o]') {
                if(pt.m_db[1]!='' & pt.m_db[1]!=action) {
                    if(pt.m_text!='') {
                        var_name=pt.m_text;
                    }
                    else {
                        var_name=pt.m_db[1].m_name;
                    }
                    code=code.split('%'+var_name).join(pt.m_db[1].m_text);
                }
            }

            if(pt.m_name=='o' | pt.m_name=='[o]') {
                if(pt.m_db[1]!='' & pt.m_db[1]!=action) {
                    if(pt.m_text!='') {
                        var_name=pt.m_text;
                    }
                    else {
                        var_name=pt.m_db[1].m_name;
                    }
                    code_out+="'"+var_name+"':`${"+var_name+"}`,";
                    outs_var[var_name]=pt.m_db[1];
                }
            }
        }
        code_out+='};outs_in_JS';

        "use strict";
        try {
            outs=eval(code+code_out);
            for(var key in outs) {
                outs_var[key].m_text=outs[key];
            }
        } catch(e) {
            print(e);
        }

    }

    opWriteText(sbj,obj,action) {
        if(obj==='') {
            return;
        }
        else if(obj.m_permission==0) {
            //print();
        }
        
        var text='',con='';
        if(sbj=='' & action.m_text=='') {
            return;
        }
        else if(action.m_text=='') {
            text=sbj.m_text;
        }
        else if(sbj=='') {
            text=action.m_text;
        }
        else {
            pat=action.m_text;
            con=sbj.m_text;
            text=pat+con;
        }
        obj.m_text=text;
    }

    opAddToText(sbj,obj,action) {
        if(obj=='') {
            return;
        }
        else if(obj.m_permission==0) {
            //obj.print();
        }
    
        var text,con;
        if(sbj=='' & action.m_text=='') {
            return;
        }
        else if(action.m_text=='') {
            text=sbj.m_text;
        }
        else if(sbj=='') {
            text=action.m_text;
        }
        else {
            pat=action.m_text;
            con=sbj.m_text;
            text=pat+con;
        }
        obj.m_text+=text;
    }

    opTempText(sbj,obj,action) {
        var text=action.m_text;
        var text_name;
        
        if(sbj!='') {
            text=sbj.m_text;
        }
        else {
            for(var i in action.m_con) {
                var pt=action.m_con[i];
                if(pt.m_name=='code' | pt.m_name=='[code]') {
                    if(pt.m_db[1]!='' & pt.m_db[1]!=action) {
                        text=pt.m_db[1].m_text;
                    }
                    break;
                }
            }
        }
        
        for(var i in action.m_con) {
            var pt=action.m_con[i];
            if(pt.m_name=='.' | pt.m_name=='[.]') {
                if(pt.m_db[1]!='' & pt.m_db[1]!=action) {
                    if(pt.m_text!='') {
                        text_name=pt.m_text;
                    }
                    else {
                        text_name=pt.m_db[1].m_name;
                    }
                    text=text.split('%'+text_name).join(pt.m_db[1].m_text);
                }
            }
        }
        obj.m_text=text;
    }
    
    opDel(action,list_pt,list_del) {
        if(action.m_db[1]=='') {
            return;
        }
        var pt_del=action.m_db[1];
        pt_del.delete()

        if(pt_del in list_del) {
            return;
        }
        else {
            list_del.push(list_pt.indexOf(pt_del));
        }
    }

    opConnect(sbj,obj,i) {
        if(sbj=='') {
            return;
        }
        sbj.disconnect_i(i);
        sbj.connect(obj,i);
    }

    opLibDefined(action) {
        var list_pt=listFromPt(this.m_lib);
        var name=action.m_name.slice(1,action.m_name.length-1);
        var result=false;

        for(var i in list_pt) {
            var pt=list_pt[i];
            if(name===list_pt[i].m_name) {
                //result=this.act(list_pt[i].m_text,action);
                result=this.act(pt,action);
                if(result) {
                    break;
                }
            }
        }
    }

    think(question,list_new) {
        var result=false;
        var list_pt=listFromPt(this.m_idea);
        var name=question.m_name.slice(1,question.m_name.length-1);
    
        for(var i in list_pt) {
            var pt=list_pt[i];
            if(name===list_pt[i].m_name) {
                result=this.match(list_pt[i],question);
                if(result) {
                    return true;
                }
            }
        }
        result=this.termBuiltin(question);
        return result;
    }
    
    match(pt_A,pt_Q) {
        var code1=pt_A.m_text;
        var list_km=[],list_new=[],result=false;
        var parser=this.m_parser;
    
        list_km=parser.readSubCode_tokener(code1);
    
        list_km[0].m_listMP=[pt_Q];
        list_km[0].m_restricted=true;
    
        result=this.run_code_line(list_km[0],[pt_A],list_new);
        return result;
    }
    
    termBuiltin(question) {
        var sbj,obj;
        sbj=question.m_db[0];
        obj=question.m_db[1];
        
        if(question.m_name=='[m_name]') {
            return this.answerQuestion(question);
        }
        else if(question.m_name=='[==]') {
            return this.tpEqual(sbj,obj,question);
        }
        
        return false;
    }
    
    tpEqual(sbj,obj,question) {
        if(obj=='') {
            return false;
        }
        if(sbj=='') {
            if(obj.m_text==question.m_text) {
                this.answerQuestion(question);
                return true;
            }
        }
        else if(obj.m_text==sbj.m_text) {
            this.answerQuestion(question);
            return true;
        }
        return false;
    }

    answerQuestion(question) {
        var name=question.m_name;
        if(name.length<2) {
            return false;
        }
        if(name[0]==='[' & name[name.length-1]===']') {
            question.m_name=name.slice(1,name.length-1);
            question.m_creator='Nini';
        }
        return true;
    }

}

function listPt2poolPt(list_pt) {
    var pool={};
    
    for(var i=0;i<list_pt.length;i++) {
        var pt=list_pt[i];
        var name=pt.m_name;
        
        if(pool[name]===undefined) {
            pool[name]=[pt];
        }
        else {
            pool[name].push(pt);
        }
    }

    return pool;
}

function listPtIntoPoolPt(pool,list_pt) {
    for(var i=0;i<list_pt.length;i++) {
        var pt=list_pt[i];
        var name=pt.m_name;
        
        if(pool[name]===undefined) {
            pool[name]=[pt];
        }
        else if(!pool[name].includes(pt)) {
            pool[name].push(pt);
        }
    }

    return pool;
}

function poolPt2listPt(pool) {
    var list_pt=[];
    
    for(var key in pool) {
        list_pt=[...list_pt,...pool[key]];
    }
    
    return list_pt;
}

var Nini=new StCore();


/*
act()
+[J函数](,JS版本)
测试:...
+[新建阅读窗口](,测试)
*/
/*
+[J函数](,JS版本)
*/

function arrayRemove(arr,value) {
    a=arr.filter(function(ele) {
            return ele!=value;
        }
    );
    return a;
}

class NetP {
    constructor(name,text='') {
        this.m_master='';
        this.m_needed='';
        this.m_creator='';
        this.m_dev='';
        this.m_var='';

        this.m_permission=4;


        this.m_name=name;
        this.m_text=text;
        this.m_db=['',''];
        this.m_con=[];
    }

    connect(con,index) {
        if(index>1 | index<0) {
            return
        }
        else {
            this.disconnect_i(index)
            this.m_db[index]=con
            if(con!='') {
                if(!con.m_con.includes(this)) {
                    con.m_con.push(this)
                }
            }
        }
    }

/*
+[J函数](,JS版本)
*/

    disconnect_i(index) {
        var con;
        if(index==0 | index==1) {
            con=this.m_db[index];
            this.m_db[index]=''
            if(con!='' & con!=this.m_db[1-index]) {
                for(var i=0;i<con.m_con.length;i++) {
                    if(con.m_con[i]==this) {
                        con.m_con.splice(i,1);
                    }
                }
            }
        }
    }

    delete() {
        this.disconnect_i(0);
        this.disconnect_i(1);
        var cons=this.m_con.slice();
        for(var i;i<cons.length;i++) {
            var point=cons[i];
            if(point.m_db[0]==this) {
                point.disconnect(0);
            }
            if(point.m_db[1]==this) {
                point.disconnect(1);
            }
        }
    }

    con(con0,con1) {
        if(con0!==0) {
            this.disconnect_i(0);
            this.connect(con0,0);
        }
        if(con1!==0) {
            this.disconnect_i(1);
            this.connect(con1,1);
        }
        return this
    }

    info() {
    
        var str_info, str_d, str_b;
        if (this.m_db[0]=='') {
            str_d='';
        } else {
            str_d=this.m_db[0].m_name;
        }

        if (this.m_db[1]=='') {
            str_b='';
        }
        else {
            str_b=this.m_db[1].m_name;
        }
        
        str_info=`${this.m_name}(${str_d},${str_b})`;

        return str_info;
    }
}


/*
记住"Matlab"
Nini, 打开动作(库)
Nini, 打开JS编译器(文件)
+[J函数](,JS版本)

测试:...
+[新建阅读窗口](,测试)
*/
/*
+[J函数](,JS版本)
return
Karma
this.m_word_order
group

保存:...
+[新建阅读窗口](,保存)
fun_把字句
*/


class NL_Parser {
    constructor() {
        this.m_word_order=0;

        this.m_dict_名词=['标记区域', '立方体', '波前', '波长', '圆柱体', '区域', '采样点', '截面分布', '参考面', '来源', '标记点', '类', '位置', '参数', 'Z方向', '成像示意图', '场强', '可见光', '函数', '方向', '衍射环', 'IP图像', 'X方向', '三维箭头', '二维函数', '光标', '变量', '平面', '红外线', '相位', '光强', '长度', 'Y坐标', '网格', '像', '多边形', '球体', '透镜组', '能谱', '倍率', '光栅压缩器', '反演', '光束传播图', '坐标', '顺序', '像距', '线段', 'X坐标', '范围', 'Javascript', '物', '光谱', '波包', '相机', '发射角分布', 'FROG', '圆形', '屏幕', 'Y方向', '程序流程图', '长方形'];

        this.m_dict_动词=['有', '玩耍', '替换', '相距', '到达', '离开', '挑衅', '获取', '进入', '复制', '拍摄', '查看', '准备', '添加', '到', '移动', '使用', '奔跑', '引用', '在', '反射', '裁剪', '转换', '吃', '修改', '为', '截取', '计算', '放映', '解析', '调换', '是', '清空', '旋转', '捕捉', '击败', '优化', '更新', '背向', '朝向', '显示', '分析', '跑', '结束', '距离'];
        this.m_dict_形容词=['所有', '什么样', '聪明', '勇敢', '单纯', '什么', '善良', '正义', '全部', '美丽', '天真'];

        this.m_dict_副词=['下', '右', '上', '都', '左', '中'];
        this.m_dict_数量词=['只', '号', '辆', '个'];
        this.m_dict_介词=['沿', '在', '绕', '从', '按', '根据'];
        this.m_dict_代词=[];
        this.m_dict_连词=['或者', '或', '和', '并且'];
        this.m_dict_助词=['把', '将', '的', '被'];
        this.m_dict_标点=[',', '\n', '，', '!', '。', '？', '.', '?', '！'];
    }
    
    fun_助词(code) {
        var n=this.word_in_dict(code,this.m_dict_助词);
        if(n!=0) {
            var pt=new NetP(code.slice(0,n));
            var pt0=new NetP("助词").con(0,pt);
            return code.slice(n,code.length),pt0;
        }
        return [code,''];
    }
    
    fun_连词(code) {
        var n=this.word_in_dict(code,this.m_dict_连词);
        if(n!=0) {
            var pt=new NetP(code.slice(0,n));
            var pt0=new NetP("连词").con(0,pt);
            return [code.slice(n,code.length),pt0];
        }
        return [code,''];
    }
    
    fun_介词(code) {
        var n=this.word_in_dict(code,this.m_dict_介词);
        if(n!=0) {
            var pt=new NetP(code.slice(0,n));
            var pt0=new NetP("介词").con(0,pt);
            return [code.slice(n,code.length),pt0];
        }
        return [code,''];
    }
    
    
    fun_数量词(code) {
        var n_type=0;
        if(code.length>0 & code[0]=='第') {
            n_type=1;
            code=code.slice(1,code.length);
        }
        var result=code.match('\d+|几');
        if(result==null) {
            return [code,''];
        }
        var 数目=new NetP(result.group());
        //code=code[result.span()[1]:];
        var n=this.word_in_dict(code,this.m_dict_数量词);
        if(n!=0) {
            var pt=new NetP(code.slice(0,n)).con(数目,0);
            var pt0=new NetP("数量词").con(0,数目);
            new NetP("的").con(pt0,pt);
            if(n_type==1) {
                var pt1=new NetP('第').con(数目,0);
                new NetP("的").con(pt0,pt1);
            }
            return [code.slice(n,code.length),pt0];
        }
        return [code,''];
    }
    
    fun_副词(code) {
        var n=this.word_in_dict(code,this.m_dict_副词);
        if(n!=0) {
            var pt=new NetP(code.slice(0,n));
            var pt0=new NetP("副词").con(0,pt);
            return [code.slice(n,code.length),pt0];
        }
        return [code,''];
    }
    
    fun_代词(code) {
        var n=this.word_in_dict(code,this.m_dict_代词);
        if(n!=0) {
            var pt=new NetP(code.slice(0,n));
            var pt0=new NetP("代词").con(0,pt);
            return [code.slice(n,code.length),pt0];
        }
        return [code,''];
    }
    
    fun_形容词(code) {
        var n=this.word_in_dict(code,this.m_dict_形容词);
        if(n!=0) {
            var pt=new NetP(code.slice(0,n));
            var pt0=new NetP("形容词").con(0,pt);
            return [code.slice(n,code.length),pt0];
        }
        return [code,''];
    }
    
    fun_名词(code) {
        if(code.length==0) {
            return ['',''];
        }
        
        var name='',n;
        
        for(var i=0;i<code.length;i++) {
            n=this.word_in_dict(code.slice(i,code.length),this.m_dict_动词)+this.word_in_dict(code.slice(i,code.length),this.m_dict_助词)+this.word_in_dict(code.slice(i,code.length),this.m_dict_连词)+this.word_in_dict(code.slice(i,code.length),this.m_dict_介词)+this.word_in_dict(code.slice(i,code.length),this.m_dict_副词)+this.word_in_dict(code.slice(i,code.length),this.m_dict_标点);
            if(n!=0) {
                if(i!=0) {
                    name=code.slice(0,i);
                    break;
                }
                
                else {
                    return [code,''];
                }
            }
            if(code[i]=='"') {
                if(i==0) {
                    name="临时文本";
                }
                
                else {
                    name=code.slice(0,i);
                }
                break;
            }
        }
        if(name=='') {
            name=code;
        }
        code=code.slice(i,code.length);
        var text='';
        var result=code.match(/^"[^"]+"/);

        if(result!==null) {
            result=result[0];
            n=result.length;
            text=result.slice(1,result.length-1);
            code=code.slice(n,code.length);
        }

        var pt=new NetP(name,text);
        var pt0=new NetP("名词").con(0,pt);
        new NetP("的").con(pt0,new NetP("序号",`${this.m_word_order}`));
        this.m_word_order+=1;
        return [code,pt0];
    }
    
    fun_dict(code,dict_words,type_word) {
        var n=this.word_in_dict(code,dict_words);
        if(n!=0) {
            var pt=new NetP(code.slice(0,n));
            var pt0=new NetP(type_word).con(0,pt);
            return [code.slice(n,code.length),pt0];
        }
        return [code,''];
    }
    
    word_in_dict(code,words) {
        var n=Math.min(20,code.length);
        
        for(var i=0;i<n;i++) {
            if(words.includes(code.slice(0,n-i))) {
                return n-i;
            }
        }
        return 0;
    }
    
    fun_动词(code) {
        var n=this.word_in_dict(code,this.m_dict_动词);
        if(n!=0) {
            var pt=new NetP(code.slice(0,n));
            var pt0=new NetP("动词").con(0,pt);
            return [code.slice(n,code.length),pt0];
        }
        return [code,''];
    }


    fun_谓语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 状语,动词,谓语,被;

        var sent_type=0;
        [code,状语]=this.fun_状语(code);
        if(code.length>0 & code[0]=='被') {
            [code,动词]=this.fun_动词(code.slice(1,code.length));
            sent_type=1;
        }
        
        else {
            [code,动词]=this.fun_动词(code);
        }
        if(动词=='') {
            状语='';
            [code,动词]=this.fun_动词(code_save);
        }
        if(动词=='') {
            return [code,''];
        }
        谓语=new NetP("谓语");
        谓语.m_db[1]=动词.m_db[1];
        new NetP('的').con(谓语,动词);
        if(sent_type==1) {
            被=new NetP('被').con('',动词);
            new NetP('的').con(谓语,被);
        }
        if(状语!='') {
            new NetP('的').con(谓语,状语);
            状语.m_db[1].con(动词.m_db[1],0);
        }
        return [code,谓语];
    }

/*
fun_把字句
*/

    fun_主语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 定语,名词,主语;

        [code,定语]=this.fun_定语(code);

        if(定语!='') {
            [code,名词]=this.fun_名词(code);
            if(名词!='') {
                主语=new NetP("主语");
                主语.m_db[1]=名词.m_db[1];

                if(this.m_dict_动词.includes(定语.m_db[1].m_name)) {
                    if(定语.m_db[1].m_db[0]!='') {
                        定语.m_db[1].con(0,名词.m_db[1]);
                    }
                    
                    else {
                        定语.m_db[1].con(名词.m_db[1],0);
                    }
                }
                
                else if(this.m_dict_副词.includes(定语.m_db[1].m_name)) {
                    if(定语.m_db[1].m_db[0]!='') {
                        定语.m_db[1].con(0,名词.m_db[1]);
                    }
                    
                    else {
                        定语.m_db[1].con(名词.m_db[1],0);
                    }
                }
                
                else {
                    定语.m_db[1].con(名词.m_db[1],0);
                }
                new NetP('的').con(主语,定语);
                new NetP('的').con(主语,名词);

                return [code,主语];
            }
        }

        code=code_save;
        [code,名词]=this.fun_名词(code);
        if(名词!='') {
            主语=new NetP("主语");
            主语.m_db[1]=名词.m_db[1];

            new NetP('的').con(主语,名词);
            return [code,主语];
        }
        code=code_save;
        return [code,''];
    }

/*
+[新建阅读窗口](,保存)
*/

    sent_pat(code,pat0) {
        var pat=pat0.replace(/%\[句子[^\[^\]]*\]/,'(.+)');
        var result=code.match(pat);
        if(result==null) {
            return false;
        }
        
        else {
            return true;
        }
    }
    
    fun_复句(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;

        if(this.sent_pat(code,"因为%[句子], 所以%[句子]")) {
            [code,复句]=this.fun_因果复句(code);
            return [code,复句];
        }
        
        else if(this.sent_pat(code,"当%[句子], %[句子]")) {
            [code,复句]=this.fun_状语复句(code);
            return [code,复句];
        }
        
        else if(this.sent_pat(code,"%[句子], 然后, %[句子]")) {
            [code,复句]=this.fun_然后复句(code);
            return [code,复句];
        }
        return [code,''];
    }
    
    fun_因果复句(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        if(code.slice(0,2)=='因为') {
            [code,句子1]=this.fun_句子(code.slice(2,code.length));
        }
        
        else {
            return [code_save,''];
        }
        if(code.slice(0,4)==', 所以') {
            [code,句子2]=this.fun_句子(code.slice(4,code.length));
        }
        
        else {
            return [code_save,''];
        }
        if(句子1=='' | 句子2=='') {
            return [code_save,''];
        }
        因果句=new NetP('因果复句');
        因为=new NetP('因为').con(因果句,句子1);
        所以=new NetP('所以').con(因果句,句子2);
        new NetP('的').con(因果句,句子1);
        new NetP('的').con(因果句,句子2);
        return [code,因果句];
    }
    
    fun_状语复句(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        if(code[0]=='当') {
            [code,句子1]=this.fun_句子(code.slice(1,code.length));
        }
        
        else {
            return [code_save,''];
        }
        if(code.slice(0,2)==', ') {
            [code,句子2]=this.fun_句子(code.slice(2,code.length));
        }
        
        else {
            return [code_save,''];
        }
        if(句子1=='' | 句子2=='') {
            return [code_save,''];
        }
        复句=new NetP('状语复句');
        条件=new NetP('条件').con(复句,句子1);
        结果=new NetP('结果').con(复句,句子2);
        new NetP('的').con(复句,句子1);
        new NetP('的').con(复句,句子2);
        return [code,复句];
    }
    
    fun_然后复句(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        [code,句子1]=this.fun_单句(code);
        if(code.slice(0,6)==', 然后, ') {
            [code,句子2]=this.fun_单句(code.slice(6,code.length));
        }
        
        else {
            return [code_save,''];
        }
        if(句子1=='' | 句子2=='') {
            return [code_save,''];
        }
        复句=new NetP('然后复句');
        之前=new NetP('之前').con(复句,句子1);
        之后=new NetP('之后').con(复句,句子2);
        new NetP('的').con(复句,句子1);
        new NetP('的').con(复句,句子2);
        return [code,复句];
    }
    
    fun_句子(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
var 句子;
        
        this.m_word_order=0;
        [code,句子]=this.fun_复句(code);
        if(句子!='') {
            return [code,句子];
        }
        
        try {
            [code,句子]=this.fun_被动句(code);
        } catch(e) {
            code=code_save;
            句子='';
        }
        if(句子!='') {
            return [code,句子];
        }
        
        try {
            [code,句子]=this.fun_把字句(code);
        } catch(e) {
            code=code_save;
            句子='';
        }
        if(句子!='') {
            return [code,句子];
        }
        
        try {
            [code,句子]=this.fun_普通句(code);
        } catch(e) {
            code=code_save;
            句子='';
        }
        return [code,句子];
    }
    
    fun_单句(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code, 句子;
        
        this.m_word_order=0;
        
        try {
            [code,句子]=this.fun_被动句(code);
        } catch(e) {
            code=code_save;
            句子='';
        }
        if(句子!='') {
            return [code,句子];
        }
        
        try {
            [code,句子]=this.fun_把字句(code);
        } catch(e) {
            code=code_save;
            句子='';
        }
        if(句子!='') {
            return [code,句子];
        }
        
        try {
            [code,句子]=this.fun_普通句(code);
        } catch(e) {
            code=code_save;
            句子='';
        }
        return [code,句子];
    }

/*
fun_句子
+[新建阅读窗口](,保存)
*/
    
    fun_普通句(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 介宾短语,主语,谓语,句子,宾语,副词,补语;
        var code1;

        [code1,介宾短语]=this.fun_介宾短语(code);
        if(介宾短语!='') {
            if(code1.slice(0,2)==', ') {
                code=code1.slice(2,code1.length);
            }
            
            else {
                介宾短语='';
            }
        }
        [code1,主语]=this.fun_主语(code);
        [code1,谓语]=this.fun_谓语(code1);
        if(谓语!='') {
            code=code1;
        }
        
        else {
            主语='';
            [code,谓语]=this.fun_谓语(code);
        }
        [code,宾语]=this.fun_宾语(code);
        if(谓语=='') {
            return [code,''];
        }
        句子=new NetP("句子");
        句子.m_db[1]=谓语.m_db[1];
        new NetP('的').con(句子,谓语);
        if(介宾短语!='') {
            介宾短语.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,介宾短语);
            new NetP('的').con(谓语,介宾短语);
        }
        if(主语!='') {
            谓语.m_db[1].con(主语.m_db[1],0);
            new NetP('的').con(句子,主语);
        }
        if(宾语!='') {
            谓语.m_db[1].con(0,宾语.m_db[1]);
            new NetP('的').con(句子,宾语);
        }
        [code1,副词]=this.fun_副词(code);
        if(副词!='') {
            副词.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,副词);
            new NetP('的').con(谓语,副词);
            return [code1,句子];
        }
        [code1,补语]=this.fun_补语(code);
        if(补语!='') {
            补语.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,补语);
            new NetP('的').con(谓语,补语);
            return [code1,句子];
        }
        return [code,句子];
    }
    
    fun_被动句(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var code1,状语,状语2,宾语,主语,谓语,副词,补语,句子;

        [code1,状语]=this.fun_介宾短语(code);
        if(状语!='') {
            if(code1.slice(0,2)==', ') {
                code=code1.slice(2,code1.length);
            }
            
            else {
                状语='';
            }
        }
        [code,宾语]=this.fun_宾语(code);
        [code,状语2]=this.fun_状语(code);
        if(code[0]!='被') {
            return [code_save,''];
        }
        
        else {
            code=code.slice(1,code.length);
        }
        [code,主语]=this.fun_主语(code);
        [code,谓语]=this.fun_谓语(code);
        if(谓语=='') {
            return [code,''];
        }
        句子=new NetP("句子");
        句子.m_db[1]=谓语.m_db[1];
        new NetP('的').con(句子,谓语);
        new NetP('被').con(谓语,谓语.m_db[1]);
        if(状语!='') {
            状语.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,状语);
            new NetP('的').con(谓语,状语);
        }
        if(状语2!='') {
            状语2.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,状语2);
            new NetP('的').con(谓语,状语2);
            状语2.m_name='状语';
        }
        if(主语!='') {
            谓语.m_db[1].con(主语.m_db[1],0);
            new NetP('的').con(句子,主语);
        }
        if(宾语!='') {
            谓语.m_db[1].con(0,宾语.m_db[1]);
            new NetP('的').con(句子,宾语);
        }
        [code1,副词]=this.fun_副词(code);
        if(副词!='') {
            副词.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,副词);
            new NetP('的').con(谓语,副词);
            return [code1,句子];
        }
        [code1,补语]=this.fun_补语(code);
        if(补语!='') {
            补语.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,补语);
            new NetP('的').con(谓语,补语);
            return [code1,句子];
        }
        return [code,句子];
    }

/*
被动句
*/
    
    fun_把字句(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 状语,状语2,主语,宾语,谓语,句子,副词,补语;
        var code1;

        [code1,状语]=this.fun_介宾短语(code);
        if(状语!='') {
            if(code1.slice(0,2)==', ') {
                code=code1.slice(2,code1.length);
            }
            
            else {
                状语='';
            }
        }

        [code,主语]=this.fun_主语(code);
        [code,状语2]=this.fun_状语(code);
        if(code[0]!='把' & code[0]!='将') {
            return [code_save,''];
        }
        
        else {
            code=code.slice(1,code.length);
        }


        [code,宾语]=this.fun_宾语(code);
        [code,谓语]=this.fun_谓语(code);
        if(谓语=='') {
            return [code,''];
        }
        句子=new NetP("句子");
        句子.m_db[1]=谓语.m_db[1];
        new NetP('的').con(句子,谓语);
        new NetP('把').con(谓语,谓语.m_db[1]);
        if(状语!='') {
            状语.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,状语);
            new NetP('的').con(谓语,状语);
        }
        if(状语2!='') {
            状语2.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,状语2);
            new NetP('的').con(谓语,状语2);
            状语2.m_name='状语';
        }
        if(主语!='') {
            谓语.m_db[1].con(主语.m_db[1],0);
            new NetP('的').con(句子,主语);
        }
        if(宾语!='') {
            谓语.m_db[1].con(0,宾语.m_db[1]);
            new NetP('的').con(句子,宾语);
        }
        [code1,副词]=this.fun_副词(code);
        if(副词!='') {
            副词.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,副词);
            new NetP('的').con(谓语,副词);
            return [code1,句子];
        }
        [code1,补语]=this.fun_补语(code);
        if(补语!='') {
            补语.m_db[1].con(谓语.m_db[1],0);
            new NetP('的').con(句子,补语);
            new NetP('的').con(谓语,补语);
            return [code1,句子];
        }
        return [code,句子];
    }

/*
fun_偏正短语
*/

    fun_宾语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 定语,名词,宾语;

        [code,定语]=this.fun_定语(code);
        if(定语!='') {
            [code,名词]=this.fun_名词(code);
            if(名词!='') {
                宾语=new NetP("宾语");
                宾语.m_db[1]=名词.m_db[1];

                if(this.m_dict_动词.includes(定语.m_db[1].m_name)) {
                    if(定语.m_db[1].m_db[0]!='') {
                        定语.m_db[1].con(0,名词.m_db[1]);
                    }
                    
                    else {
                        定语.m_db[1].con(名词.m_db[1],0);
                    }
                }
                
                else if(this.m_dict_副词.includes(定语.m_db[1].m_name)) {
                    if(定语.m_db[1].m_db[0]!='') {
                        定语.m_db[1].con(0,名词.m_db[1]);
                    }
                    
                    else {
                        定语.m_db[1].con(名词.m_db[1],0);
                    }
                }
                
                else {
                    定语.m_db[1].con(名词.m_db[1],0);
                }
                new NetP('的').con(宾语,定语);
                new NetP('的').con(宾语,名词);
                return [code,宾语];
            }
        }
        code=code_save;
        [code,名词]=this.fun_名词(code);
        if(名词!='') {
            宾语=new NetP("宾语");
            宾语.m_db[1]=名词.m_db[1];

            new NetP('的').con(宾语,名词);
            return [code,宾语];
        }
        code=code_save;
        return [code,''];
    }

/*
printPtList
*/

    fun_定语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 短语,助词,定语,形容词,数量词,名词;

        [code,短语]=this.fun_短语(code);
        if(短语!='') {
            //print(短语,code);
            [code,助词]=this.fun_dict(code,['的'],'助词');
            if(助词!='') {
                定语=new NetP("定语");
                定语.m_db[1]=短语.m_db[1];
                new NetP('的').con(定语,短语);
                new NetP('的').con(定语,助词);
                return [code,定语];
            }
        }
        code=code_save;
        [code,形容词]=this.fun_形容词(code);
        if(形容词!='') {
            定语=new NetP("定语");
            定语.m_db[1]=形容词.m_db[1];
            new NetP('的').con(定语,形容词);
            [code,助词]=this.fun_dict(code,['的'],'助词');
            if(助词!='') {
                new NetP('的').con(定语,助词);
            }
            return [code,定语];
        }
        code=code_save;
        [code,数量词]=this.fun_数量词(code);
        if(数量词!='') {
            定语=new NetP("定语");
            定语.m_db[1]=数量词.m_db[1];
            //new Karma(定语.m_db[1]);
            new NetP('的').con(定语,数量词);
            return [code,定语];
        }
        code=code_save;
        [code,名词]=this.fun_名词(code);
        if(名词!='') {
            [code,助词]=this.fun_dict(code,['的'],'助词');
            if(助词!='') {
                定语=new NetP("定语");
                定语.m_db[1]=名词.m_db[1];
                //new Karma(定语.m_db[1]);
                new NetP('的').con(定语,名词);
                new NetP('的').con(定语,助词);
                return [code,定语];
            }
        }
        code=code_save;
        return [code,''];
    }

/*
fun_把字句
*/

    fun_状语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 并列短语,状语,介宾短语,副词,形容词,代词;

        [code,并列短语]=this.fun_并列短语(code);
        if(并列短语!='') {
            状语=new NetP("状语");
            状语.m_db[1]=并列短语.m_db[1];
            new NetP('的').con(状语,并列短语);
            return [code,状语];
        }
        code=code_save;
        [code,介宾短语]=this.fun_介宾短语(code);
        if(介宾短语!='') {
            状语=new NetP("状语");
            状语.m_db[1]=介宾短语.m_db[1];
            new NetP('的').con(状语,介宾短语);
            return [code,状语];
        }
        code=code_save;
        [code,副词]=this.fun_副词(code);
        if(副词!='') {
            状语=new NetP("状语");
            状语.m_db[1]=副词.m_db[1];
            new NetP('的').con(状语,副词);
            return [code,状语];
        }
        code=code_save;
        [code,形容词]=this.fun_形容词(code);
        if(形容词!='') {
            状语=new NetP("状语");
            状语.m_db[1]=形容词.m_db[1];
            new NetP('的').con(状语,形容词);
            return [code,状语];
        }
        code=code_save;
        [code,代词]=this.fun_代词(code);
        if(代词!='') {
            状语=new NetP("状语");
            状语.m_db[1]=代词.m_db[1];
            new NetP('的').con(状语,代词);
            return [code,状语];
        }
        code=code_save;
        return [code,''];
    }
/*
print
*/

    fun_补语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 并列短语,补语,介宾短语,述宾短语,形容词,数量词,代词;

        [code,并列短语]=this.fun_并列短语(code);
        if(并列短语!='') {
            补语=new NetP("补语");
            补语.m_db[1]=并列短语.m_db[1];
            new NetP('的').con(补语,并列短语);
            return [code,补语];
        }
        code=code_save;
        [code,介宾短语]=this.fun_介宾短语(code);
        if(介宾短语!='') {
            补语=new NetP("补语");
            补语.m_db[1]=介宾短语.m_db[1];
            new NetP('的').con(补语,介宾短语);
            return [code,补语];
        }
        code=code_save;
        [code,述宾短语]=this.fun_述宾短语(code);
        if(述宾短语!='') {
            补语=new NetP("补语");
            补语.m_db[1]=述宾短语.m_db[1];
            new NetP('的').con(补语,述宾短语);
            return [code,补语];
        }
        code=code_save;
        [code,形容词]=this.fun_形容词(code);
        if(形容词!='') {
            补语=new NetP("补语");
            补语.m_db[1]=形容词.m_db[1];
            new NetP('的').con(补语,形容词);
            return [code,补语];
        }
        code=code_save;
        [code,数量词]=this.fun_数量词(code);
        if(数量词!='') {
            补语=new NetP("补语");
            补语.m_db[1]=数量词.m_db[1];
            new NetP('的').con(补语,数量词);
            return [code,补语];
        }
        code=code_save;
        [code,代词]=this.fun_代词(code);
        if(代词!='') {
            补语=new NetP("补语");
            补语.m_db[1]=代词.m_db[1];
            new NetP('的').con(补语,代词);
            return [code,补语];
        }
        code=code_save;
        return [code,''];
    }

/*
fun_主语
print
*/
    
    fun_短语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 并列短语,偏正短语,介宾短语,述宾短语,述补短语,主谓短语;

        [code,并列短语]=this.fun_并列短语(code);
        if(并列短语!='') {
            //print('并列短语',code);
            return [code,并列短语];
        }
        code=code_save;
        [code,偏正短语]=this.fun_偏正短语(code);
        if(偏正短语!='') {
            //print('偏正短语',code);
            return [code,偏正短语];
        }
        code=code_save;
        [code,介宾短语]=this.fun_介宾短语(code);
        if(介宾短语!='') {
            //print('介宾短语',code);
            return [code,介宾短语];
        }
        code=code_save;
        [code,述宾短语]=this.fun_述宾短语(code);
        if(述宾短语!='') {
            return [code,述宾短语];
        }
        code=code_save;
        [code,述补短语]=this.fun_述补短语(code);
        if(述补短语!='') {
            //print('述补短语',code);
            return [code,述补短语];
        }
        code=code_save;
        [code,主谓短语]=this.fun_主谓短语(code);
        if(主谓短语!='') {
            //print('主谓短语',code);
            return [code,主谓短语];
        }
        code=code_save;
        return [code,''];
    }
    
    fun_并列短语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 形容词,形容词_0,形容词_1,连词,并列短语,并列短语_0,名词,名词_0,名词_1;

        [code,形容词]=this.fun_形容词(code);
        if(形容词!='') {
            [code,连词]=this.fun_连词(code);
            if(连词!='') {
                [code,并列短语]=this.fun_并列短语(code);
                if(并列短语!='') {
                    并列短语_0=new NetP("并列短语");
                    连词.m_db[1].con(形容词.m_db[1],并列短语.m_db[1]);
                    并列短语_0.m_db[1]=形容词.m_db[1];
                    new NetP('的').con(并列短语_0,形容词);
                    new NetP('的').con(并列短语_0,连词);
                    new NetP('的').con(并列短语_0,并列短语);
                    return [code,并列短语_0];
                }
            }
        }
        code=code_save;
        [code,名词]=this.fun_名词(code);
        if(名词!='') {
            [code,连词]=this.fun_连词(code);
            if(连词!='') {
                [code,并列短语]=this.fun_并列短语(code);
                if(并列短语!='') {
                    并列短语_0=new NetP("并列短语");
                    连词.m_db[1].con(名词.m_db[1],并列短语.m_db[1]);
                    并列短语_0.m_db[1]=名词.m_db[1];
                    new NetP('的').con(并列短语_0,名词);
                    new NetP('的').con(并列短语_0,连词);
                    new NetP('的').con(并列短语_0,并列短语);
                    return [code,并列短语_0];
                }
            }
        }
        code=code_save;
        [code,名词_0]=this.fun_名词(code);
        if(名词_0!='') {
            [code,连词]=this.fun_连词(code);
            if(连词!='') {
                [code,名词_1]=this.fun_名词(code);
                if(名词_1!='') {
                    并列短语=new NetP("并列短语");
                    连词.m_db[1].con(名词_0.m_db[1],名词_1.m_db[1]);
                    并列短语.m_db[1]=名词_0.m_db[1];
                    new NetP('的').con(并列短语,名词_0);
                    new NetP('的').con(并列短语,连词);
                    new NetP('的').con(并列短语,名词_1);
                    return [code,并列短语];
                }
            }
        }
        code=code_save;
        [code,形容词]=this.fun_形容词(code);
        if(形容词!='') {
            [code,连词]=this.fun_连词(code);
            if(连词!='') {
                [code,名词]=this.fun_名词(code);
                if(名词!='') {
                    并列短语=new NetP("并列短语");
                    连词.m_db[1].con(形容词.m_db[1],名词.m_db[1]);
                    并列短语.m_db[1]=形容词.m_db[1];
                    new NetP('的').con(并列短语,形容词);
                    new NetP('的').con(并列短语,连词);
                    new NetP('的').con(并列短语,名词);
                    return [code,并列短语];
                }
            }
        }
        code=code_save;
        [code,名词]=this.fun_名词(code);
        if(名词!='') {
            [code,连词]=this.fun_连词(code);
            if(连词!='') {
                [code,形容词]=this.fun_形容词(code);
                if(形容词!='') {
                    并列短语=new NetP("并列短语");
                    连词.m_db[1].con(名词.m_db[1],形容词.m_db[1]);
                    并列短语.m_db[1]=名词.m_db[1];
                    new NetP('的').con(并列短语,名词);
                    new NetP('的').con(并列短语,连词);
                    new NetP('的').con(并列短语,形容词);
                    return [code,并列短语];
                }
            }
        }
        code=code_save;
        [code,形容词_0]=this.fun_形容词(code);
        if(形容词_0!='') {
            [code,连词]=this.fun_连词(code);
            if(连词!='') {
                [code,形容词_1]=this.fun_形容词(code);
                if(形容词_1!='') {
                    并列短语=new NetP("并列短语");
                    连词.m_db[1].con(形容词_0.m_db[1],形容词_1.m_db[1]);
                    并列短语.m_db[1]=形容词_0.m_db[1];
                    new NetP('的').con(并列短语,形容词);
                    new NetP('的').con(并列短语,连词);
                    new NetP('的').con(并列短语,形容词);
                    return [code,并列短语];
                }
            }
        }
        code=code_save;
        return [code,''];
    }

/*
fun_定语
*/
    
    fun_偏正短语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 名词_0,名词_1,偏正短语,形容词,动词,pt_de;

        [code,名词_0]=this.fun_名词(code);
        if(名词_0!='') {
            [code,名词_1]=this.fun_名词(code);
            if(名词_1!='') {
                偏正短语=new NetP("偏正短语");
                偏正短语.m_db[1]=名词_1.m_db[1];

                pt_de=new NetP('的').con(名词_0.m_db[1],名词_1.m_db[1]);

                new NetP('的').con(偏正短语,名词_0);
                new NetP('的').con(偏正短语,pt_de);
                new NetP('的').con(偏正短语,名词_1);
                return [code,偏正短语];
            }
        }
        code=code_save;
        [code,形容词]=this.fun_形容词(code);
        if(形容词!='') {
            [code,动词]=this.fun_动词(code);
            if(动词!='') {
                偏正短语=new NetP("偏正短语");
                偏正短语.m_db[1]=动词.m_db[1];
                形容词.m_db[1].con(动词.m_db[1],0);
                //new Karma(动词.m_db[1]);
                //new Karma(形容词.m_db[1]);
                new NetP('的').con(偏正短语,形容词);
                new NetP('的').con(偏正短语,动词);
                return [code,偏正短语];
            }
        }
        code=code_save;
        [code,形容词]=this.fun_形容词(code);
        if(形容词!='') {
            [code,名词]=this.fun_名词(code);
            if(名词!='') {
                偏正短语=new NetP("偏正短语");
                偏正短语.m_db[1]=名词.m_db[1];
                形容词.m_db[1].con(名词.m_db[1],0);
                //new Karma(形容词.m_db[1]);
                //new Karma(名词.m_db[1]);
                new NetP('的').con(偏正短语,形容词);
                new NetP('的').con(偏正短语,名词);
                return [code,偏正短语];
            }
        }
        code=code_save;
        return [code,''];
    }
    
    fun_述宾短语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 动词,名词,述宾短语;

        [code,动词]=this.fun_动词(code);
        if(动词!='') {
            [code,名词]=this.fun_名词(code);
            if(名词!='') {
                述宾短语=new NetP("述宾短语");
                述宾短语.m_db[1]=动词.m_db[1];
                动词.m_db[1].con(0,名词.m_db[1]);

                new NetP('的').con(述宾短语,动词);
                new NetP('的').con(述宾短语,名词);
                return [code,述宾短语];
            }
        }
        code=code_save;
        return [code,''];
    }
    
    fun_述补短语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 动词,形容词,述补短语;

        [code,动词]=this.fun_动词(code);
        if(动词!='') {
            [code,形容词]=this.fun_形容词(code);
            if(形容词!='') {
                述补短语=new NetP("述补短语");
                述补短语.m_db[1]=动词.m_db[1];
                形容词.m_db[1].con(动词.m_db[1],0);
                //new Karma(动词.m_db[1]);
                //new Karma(形容词.m_db[1]);
                new NetP('的').con(述补短语,动词);
                new NetP('的').con(述补短语,形容词);
                return [code,述补短语];
            }
        }
        code=code_save;
        return [code,''];
    }
    
    fun_主谓短语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 名词,主谓短语,动词,副词;

        [code,名词]=this.fun_名词(code);
        if(名词=='') {
            return [code_save,''];
        }
        主谓短语=new NetP("主谓短语");
        new NetP('的').con(主谓短语,名词);

        [code,动词]=this.fun_动词(code);
        if(动词!='') {
            动词.m_db[1].con(名词.m_db[1],0);
            主谓短语.m_db[1]=动词.m_db[1];

            new NetP('的').con(主谓短语,动词);
        }
        
        else {
            [code,副词]=this.fun_副词(code);
            if(副词!='') {
                副词.m_db[1].con(名词.m_db[1],0);
                主谓短语.m_db[1]=副词.m_db[1];

                new NetP('的').con(主谓短语,副词);
            }
            
            else {
                return [code_save,''];
            }
        }
        return [code,主谓短语];
    }
    
    fun_介宾短语(code) {
        if(code=="") {
            return [code,''];
        }
        var code_save=code;
        var 介词,宾语,介宾短语,副词;

        [code,介词]=this.fun_介词(code);
        [code,宾语]=this.fun_名词(code);
        介宾短语=new NetP("介宾短语");
        if(宾语!='' & 介词!='') {
            介宾短语.m_db[1]=介词.m_db[1];
            介词.m_db[1].con(0,宾语.m_db[1]);
            //new Karma(介词.m_db[1]);
            new NetP('的').con(介宾短语,宾语);
            new NetP('的').con(介宾短语,介词);
        }
        
        else {
            code=code_save;
            return [code,''];
        }
        [code,副词]=this.fun_副词(code);
        if(副词!='') {
            副词.m_db[1].con(介词.m_db[1],0);
            new NetP('的').con(介宾短语,副词);
        }
        return [code,介宾短语];
    }

/*
并列短语
*/

    collectPts(pt,list_pt='') {
        if(list_pt=='') {
            list_pt=[];
        }
        if(!list_pt.includes(pt)) {
            list_pt.push(pt);
        }
        
        for(var i=0;i<pt.m_con.length;i++) {
            var con=pt.m_con[i];
            if(con.m_db[0]==pt) {
                if(!list_pt.includes(con)) {
                    list_pt.push(con);
                }
                if(con.m_name=="的" & con.m_db[1]!='') {
                    this.collectPts(con.m_db[1],list_pt);
                }
            }
        }
        if(pt.m_db[0]!='') {
            if(!list_pt.includes(pt.m_db[0])) {
                list_pt.push(pt.m_db[0]);
            }
        }
        if(pt.m_db[1]!='') {
            if(!list_pt.includes(pt.m_db[1])) {
                list_pt.push(pt.m_db[1]);
            }
        }
        return list_pt;
    }

    sentStruct(pt) {
        var pt0=new NetP('^起点').con(0,pt);
        var list_pt0,list_pt;
        list_pt0=this.collectPts(pt);
        list_pt=[pt0,...list_pt0];
        return list_pt;
    }
    
    sent2Struct(sent) {
        var code,pt,list_pt;
        [code,pt]=this.fun_句子(sent);
        if(pt=='') {
            return [[],code];
        }
        else {
            list_pt=this.sentStruct(pt);
            return [list_pt,code];
        }
    }

}


function info_PtList(list_pt) {
    var info_pt='';
    for(var i=0;i<list_pt.length;i++) {
        var pt=list_pt[i];
        info_pt+=pt.info()+','
    }

    return `[${info_pt}]`;
}

function printPtList(list_pt) {
    print(info_PtList(list_pt));
}

var NLP=new NL_Parser();


/*
fun_单句
测试(J函数):...
+[新建阅读窗口](,测试)
*/
function print() {
    if(document.getElementById("cmd_window").innerHTML===null) {
        return;
    }

    document.getElementById("cmd_window").innerHTML+="<br>";
    for (var i=0; i < arguments.length; i++) {
        text=arguments[i];
        document.getElementById("cmd_window").innerHTML+=" "+text;
    }
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, 'cmd_window']);
}

function arrayRemove(arr,value) {
    a=arr.filter(function(ele) {
            return ele!=value;
        }
    );
    return a;
}
</script>




<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {
  box-sizing: border-box;
  font-family: Arial, Helvetica, sans-serif;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
}

/* Style the top navigation bar */
.topnav {
  overflow: hidden;
  background-color: #333;
}

/* Style the topnav links */
.topnav a {
  float: left;
  display: block;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

/* Change color on hover */
.topnav a:hover {
  background-color: #ddd;
  color: black;
}


/* Style the content */
.content {
  background-color: #fff;
  padding: 10px;
}

/*
+[网页](web,实验室日历模板)
*/

/* Style the footer */
.footer {
  background-color: #333;
  padding: 10px;
  margin-top: 20px
}

.footer p {
  color: #ddd
}

</style>


  </head>


<body>
<div class="topnav">
  <a href="#">Link</a>
  <a href="#">Link</a>
  <a href="#">Link</a>
</div>


<div class="content">
    <p><mathjax style=\"font-size:1.5em\">
<!--
+[H函数](,Nini聊天框)

emoji::https://unicode.org/emoji/charts/full-emoji-list.html#1f92b

-->

<st id='st_core' style='display:none'>
Nini#0""(,)
m_lib#1"

自我意识:...

"(,)
m_idea#2""(,)
的#3""(Nini#0,m_idea#2)
的#4""(Nini#0,m_lib#1)
说#5""(,)
听#6""(,)
的#7""(Nini#0,说#5)
的#8""(Nini#0,听#6)
自我意识#9"\"\"\"

\"\"\"

+自我意识(Nini,)->+[del](,+自我意识)...

->的(Nini,听)->的(Nini,说):
    ->[==]\"你好\"(,听)->+[修改内容]\"哈哈哈! 我好开心! \"(,说),
    ->[==]\"你不好\"(,听)->+[修改内容]\"我生气了! \"(,说),
    ->^起点(听,)->+[修改内容]\"我懂你在说什么\"(,说),
    ->+[修改内容]\"我不懂\"(,说)
"(,)
的#10""(m_lib#1,自我意识#9)

</st>

<style>
.window {
  position: relative;
  width: 90%;
  #overflow: hidden;
  overflow: auto;
  # padding-top: 20%;
  left: 5%;
  border: 2px solid #888888;
}

.window.history {
  height: 60%;
  background-color: lightgrey;
}

.window.me {
  background-color: white;
}

.chat-bubble {
    margin: 10px;
    display: inline-block;
    position: relative;
    width: auto;
    height: auto;
}

.chat-bubble.Nini {
    float: left;
    clear: both;
    background-color: white;
}

.chat-bubble.me {
    float: right;
    clear: both;
    background-color: lightgreen;
}

.talktext{
    padding: 1em;
    text-align: left;
    line-height: 1.5em;
}

</style>

<!--
+[H函数](,Nini聊天框)
&#129409
&#x1f611
&#x1f612
&#x1f623
&#x1f603
-->

<h1 id='Nini_face'>Nini: &#x1f603</h1>

<div id="chat_history" class="window history">

<div class="chat-bubble Nini">
    <div class="talktext">
你好!
    </div>
</div>

</div>

<br>

<textarea class="window me" id='edit_box' rows=4>你好</textarea>

<p id='cmd_window'></p>

<script>

var face_normal='&#x1f611';
var face_see='&#x1f612';
var face_bad='&#x1f623';
var face_happy='&#x1f603';

Nini.init(st_core.textContent);
var pt_Nini=Nini.m_self;
var echo_sent=[];

edit_box.addEventListener("keydown", function (event) {
    if(event.key==='Enter') {
        var code=edit_box.value;
        edit_box.value='';
        event.preventDefault();
        updateChatHistory(code);
        runCode_Nini(code);
    }
});

function updateChatHistory(code,speaker='me') {
    chat_history.innerHTML+=`
<div class="chat-bubble ${speaker}">
    <div class="talktext">
${code}
    </div>
</div>
`;

    chat_history.scrollTop = chat_history.scrollHeight;

}

function runCode_Nini(code) {
    understandHear(code)
    Nini.do('+[自我意识](Nini,)',pt_Nini);
    if(Nini.m_speak.m_text!='') {
        updateChatHistory(Nini.m_speak.m_text,speaker='Nini');
        Nini.m_speak.m_text='';
    }
}

function understandHear(code) {
    var list_pt,pt0,pt_con,pt_hear;
    var list_del=[];
    pt_hear=Nini.m_hear;
    pt_hear.m_text=code;

    for(var i=0;i<pt_hear.m_con.length;i++) {
        pt_con=pt_hear.m_con[i];
        if(pt_con.m_name=='^起点') {
            list_del.push(pt_con);
        }
//print(pt_con.info());
    }
    for(var i=0;i<list_del.length;i++) {
        list_del[i].con('',0);
    }

    [list_pt,code]=NLP.sent2Struct(code);
    if(list_pt.length==0) {
        return;
    }
    else {
        pt0=list_pt[0];
        pt0.con(pt_hear,0)
    }

}

//understandHear('我不信');
//understandHear('A0显示B0');
//understandHear('我不信');
//understandHear('我不信');

</script>


<!--
Nini, 打开网页画板(文件)
Nini本体(核心结构):...
+[新建阅读窗口](,Nini本体)
+[H函数](,Nini聊天框)
-->
    </mathjax></p>
</div>

<div class="footer">
  <p>Footer</p>
</div>

</body>
</html>